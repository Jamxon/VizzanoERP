Index: app/Http/Controllers/CasherController.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?php\r\n\r\nnamespace App\\Http\\Controllers;\r\n\r\nuse App\\Exports\\CashboxTransactionsExport;\r\nuse App\\Exports\\DepartmentGroupsExport;\r\nuse App\\Exports\\GroupsOrdersEarningsExport;\r\nuse App\\Exports\\MonthlyCostPdf;\r\nuse App\\Http\\Resources\\GroupPlanResource;\r\nuse App\\Models\\Attendance;\r\nuse App\\Models\\Cashbox;\r\nuse App\\Models\\Department;\r\nuse App\\Models\\Employee;\r\nuse App\\Models\\Group;\r\nuse App\\Models\\CashboxBalance;\r\nuse App\\Models\\CashboxTransaction;\r\nuse App\\Models\\Currency;\r\nuse App\\Models\\MonthlyExpense;\r\nuse App\\Models\\MonthlySelectedOrder;\r\nuse App\\Models\\Order;\r\nuse App\\Models\\OrderCut;\r\nuse App\\Models\\SalaryPayment;\r\nuse App\\Models\\SewingOutputs;\r\nuse Carbon\\CarbonPeriod;\r\nuse Illuminate\\Http\\Request;\r\nuse Illuminate\\Support\\Carbon;\r\nuse Illuminate\\Support\\Facades\\DB;\r\nuse Barryvdh\\DomPDF\\Facade\\Pdf;\r\nuse Maatwebsite\\Excel\\Facades\\Excel;\r\nuse App\\Exports\\MonthlyCostExport;\r\nuse PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\r\nuse PhpOffice\\PhpSpreadsheet\\Spreadsheet;\r\nuse PhpOffice\\PhpSpreadsheet\\Style\\Alignment;\r\nuse PhpOffice\\PhpSpreadsheet\\Style\\Border;\r\nuse App\\Exports\\TransactionsExport;\r\nuse Illuminate\\Support\\Facades\\Http;\r\n\r\nclass CasherController extends Controller\r\n{\r\n    public function exportMonthlyCostPdf(Request $request)\r\n    {\r\n        $request->validate([\r\n            'start_date' => 'nullable|date',\r\n            'end_date' => 'nullable|date|after_or_equal:start_date',\r\n            'dollar_rate' => 'nullable|numeric',\r\n        ]);\r\n\r\n        $start = $request->start_date\r\n            ? Carbon::parse($request->start_date)->startOfDay()\r\n            : Carbon::now()->startOfMonth();\r\n\r\n        $end = $request->end_date\r\n            ? Carbon::parse($request->end_date)->endOfDay()\r\n            : Carbon::now()->endOfMonth();\r\n\r\n        $dollarRate = $request->dollar_rate ?? 12700;\r\n\r\n        // Sana oralig'i juda katta bo'lsa, ogohlantiramiz\r\n        if ($start->diffInDays($end) > 366) {\r\n            return response()->json([\r\n                'status' => 'error',\r\n                'message' => 'Sana oralig\\'i 1 yildan ko\\'p bo\\'lmasligi kerak'\r\n            ], 400);\r\n        }\r\n\r\n        $period = CarbonPeriod::create($start, $end);\r\n\r\n        // 1) Kunlik tafsilotlarni to'plash\r\n        $dailyRows = [];\r\n        $progressData = [\r\n            'total_days' => $period->count(),\r\n            'processed_days' => 0\r\n        ];\r\n\r\n        foreach ($period as $dateObj) {\r\n            $date = $dateObj->toDateString();\r\n\r\n            try {\r\n                // getDailyCost methodini chaqirish\r\n                $dailyResp = $this->getDailyCost(new Request([\r\n                    'date' => $date,\r\n                    'dollar_rate' => $dollarRate,\r\n                ]));\r\n\r\n                // Response ni array formatiga o'tkazish\r\n                if (is_object($dailyResp) && method_exists($dailyResp, 'getData')) {\r\n                    $daily = $dailyResp->getData(true);\r\n                } elseif (is_array($dailyResp)) {\r\n                    $daily = $dailyResp;\r\n                } else {\r\n                    $daily = [];\r\n                }\r\n\r\n                $dailyRows[] = [\r\n                    'date' => $date,\r\n                    'aup' => $daily['aup'] ?? 0,\r\n                    'kpi' => $daily['kpi'] ?? 0,\r\n                    'transport_attendance' => $daily['transport_attendance'] ?? 0,\r\n                    'tarification' => $daily['tarification'] ?? 0,\r\n                    'daily_expenses' => $daily['daily_expenses'] ?? 0,\r\n                    'total_earned_uzs' => $daily['total_earned_uzs'] ?? 0,\r\n                    'total_fixed_cost_uzs' => $daily['total_fixed_cost_uzs'] ?? 0,\r\n                    'net_profit_uzs' => $daily['net_profit_uzs'] ?? 0,\r\n                    'employee_count' => $daily['employee_count'] ?? 0,\r\n                    'total_output_quantity' => $daily['total_output_quantity'] ?? 0,\r\n                    'rasxod_limit_uzs' => $daily['rasxod_limit_uzs'] ?? 0,\r\n                ];\r\n\r\n                $progressData['processed_days']++;\r\n\r\n            } catch (\\Exception $e) {\r\n                // Agar biron bir kun uchun ma'lumot olmasa, bo'sh qiymatlar qo'yamiz\r\n                \\Log::warning(\"Kunlik ma'lumot olishda xatolik [{$date}]: \" . $e->getMessage());\r\n\r\n                $dailyRows[] = [\r\n                    'date' => $date,\r\n                    'aup' => 0, 'kpi' => 0, 'transport_attendance' => 0,\r\n                    'tarification' => 0, 'daily_expenses' => 0, 'total_earned_uzs' => 0,\r\n                    'total_fixed_cost_uzs' => 0, 'net_profit_uzs' => 0,\r\n                    'employee_count' => 0, 'total_output_quantity' => 0, 'rasxod_limit_uzs' => 0,\r\n                ];\r\n            }\r\n        }\r\n\r\n        // 2) Umumiy oylik hisob-kitoblarni olish\r\n        try {\r\n            $monthlyResp = $this->getMonthlyCost(new Request([\r\n                'start_date' => $start->toDateString(),\r\n                'end_date' => $end->toDateString(),\r\n                'dollar_rate' => $dollarRate,\r\n            ]));\r\n\r\n            $monthly = $monthlyResp->getData(true);\r\n        } catch (\\Exception $e) {\r\n            return response()->json([\r\n                'status' => 'error',\r\n                'message' => 'Oylik hisobotni olishda xatolik: ' . $e->getMessage()\r\n            ], 500);\r\n        }\r\n\r\n        // 3) Payload tayyorlash\r\n        $payload = [\r\n            'summary' => array_merge($monthly, [\r\n                'start_date' => $start->format('d.m.Y'),\r\n                'end_date' => $end->format('d.m.Y'),\r\n                'dollar_rate' => $dollarRate,\r\n                'days_in_period' => $start->diffInDays($end) + 1,\r\n                'generated_at' => Carbon::now()->format('d.m.Y H:i:s'),\r\n            ]),\r\n            'daily' => $dailyRows,\r\n            'orders' => $monthly['orders'] ?? [],\r\n            'progress' => $progressData,\r\n        ];\r\n\r\n        // 4) PDF yaratish\r\n        $pdf = new MonthlyCostPdf($payload);\r\n\r\n        // Fayl nomini yaratish\r\n        $fileName = sprintf(\r\n            \"Oylik_Hisobot_%s_%s.pdf\",\r\n            $start->format('Y-m-d'),\r\n            $end->format('Y-m-d')\r\n        );\r\n\r\n        // Memory limit ni oshirish katta hisobotlar uchun\r\n        ini_set('memory_limit', '512M');\r\n        ini_set('max_execution_time', 300); // 5 minut\r\n\r\n        // PDF yaratish va yuklash\r\n        return $pdf->generate()->download($fileName);\r\n\r\n\r\n    }\r\n\r\n    public function exportMonthlyCostExcel(Request $request)\r\n    {\r\n        $request->validate([\r\n            'start_date' => 'nullable|date',\r\n            'end_date' => 'nullable|date|after_or_equal:start_date',\r\n            'dollar_rate' => 'nullable|numeric',\r\n        ]);\r\n\r\n        try {\r\n            $start = $request->start_date\r\n                ? Carbon::parse($request->start_date)->startOfDay()\r\n                : Carbon::now()->startOfMonth();\r\n\r\n            $end = $request->end_date\r\n                ? Carbon::parse($request->end_date)->endOfDay()\r\n                : Carbon::now()->endOfMonth();\r\n\r\n            $dollarRate = $request->dollar_rate ?? 12700;\r\n\r\n            $period = CarbonPeriod::create($start, $end);\r\n\r\n            // 1) Kunlik tafsilotlarni to'plash\r\n            $dailyRows = [];\r\n            foreach ($period as $dateObj) {\r\n                $date = $dateObj->toDateString();\r\n\r\n                // chaqiramiz getDailyCost — u JSON qaytaradi, shuning uchun getData(true)\r\n                $dailyResp = $this->getDailyCost(new Request([\r\n                    'date' => $date,\r\n                    'dollar_rate' => $dollarRate,\r\n                ]));\r\n\r\n                $daily = is_object($dailyResp) && method_exists($dailyResp, 'getData')\r\n                    ? $dailyResp->getData(true)\r\n                    : (is_array($dailyResp) ? $dailyResp : []);\r\n\r\n                $dailyRows[] = [\r\n                    'date' => $date,\r\n                    'aup' => $daily['aup'] ?? 0,\r\n                    'kpi' => $daily['kpi'] ?? 0,\r\n                    'transport_attendance' => $daily['transport_attendance'] ?? 0,\r\n                    'tarification' => $daily['tarification'] ?? 0,\r\n                    'daily_expenses' => $daily['daily_expenses'] ?? 0,\r\n                    'total_earned_uzs' => $daily['total_earned_uzs'] ?? 0,\r\n                    'total_fixed_cost_uzs' => $daily['total_fixed_cost_uzs'] ?? 0,\r\n                    'net_profit_uzs' => $daily['net_profit_uzs'] ?? 0,\r\n                    'employee_count' => $daily['employee_count'] ?? 0,\r\n                    'total_output_quantity' => $daily['total_output_quantity'] ?? 0,\r\n                    'rasxod_limit_uzs' => $daily['rasxod_limit_uzs'] ?? 0,\r\n                ];\r\n            }\r\n\r\n            // 2) Umumiy oylik hisob-kitoblarni olish (sizdagi getMonthlyCost methodidan)\r\n            $monthlyResp = $this->getMonthlyCost(new Request([\r\n                'start_date' => $start->toDateString(),\r\n                'end_date' => $end->toDateString(),\r\n                'dollar_rate' => $dollarRate,\r\n            ]));\r\n\r\n            $monthly = $monthlyResp->getData(true);\r\n\r\n            // 3) payload tayyorlash\r\n            $payload = [\r\n                'summary' => $monthly,\r\n                'daily' => $dailyRows,\r\n                'orders' => $monthly['orders'] ?? [],\r\n            ];\r\n\r\n            $fileName = sprintf(\"MonthlyReport_%s_%s.xlsx\", $start->toDateString(), $end->toDateString());\r\n\r\n            return Excel::download(new MonthlyCostExport($payload), $fileName);\r\n        } catch (\\Exception $e) {\r\n            return response()->json(['status' => 'error', 'message' => $e->getMessage()], 500);\r\n        }\r\n    }\r\n\r\n    public function getMonthlyCost(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $request->validate([\r\n            'start_date' => 'nullable|date',\r\n            'end_date' => 'nullable|date|after_or_equal:start_date',\r\n            'dollar_rate' => 'nullable|numeric',\r\n        ]);\r\n\r\n        try {\r\n            $start = $request->start_date\r\n                ? Carbon::parse($request->start_date)->startOfDay()\r\n                : Carbon::now()->startOfMonth();\r\n\r\n            $end = $request->end_date\r\n                ? Carbon::parse($request->end_date)->endOfDay()\r\n                : Carbon::now()->endOfMonth();\r\n        } catch (\\Exception $e) {\r\n            return response()->json(['error' => 'Invalid date format. Please use YYYY-MM-DD'], 400);\r\n        }\r\n\r\n        $dollarRate = $request->dollar_rate ?? 12900;\r\n\r\n        $period = CarbonPeriod::create($start, $end);\r\n        $orderSummaries = [];\r\n        $monthlyStats = [\r\n            'aup' => 0,\r\n            'kpi' => 0,\r\n            'transport_attendance' => 0,\r\n            'tarification' => 0,\r\n            'daily_expenses' => 0,\r\n            'total_earned_uzs' => 0,\r\n            'total_output_cost_uzs' => 0,\r\n            'total_fixed_cost_uzs' => 0,\r\n            'net_profit_uzs' => 0,\r\n            'employee_count_sum' => 0,\r\n            'total_output_quantity' => 0,\r\n            'rasxod_limit_uzs' => 0,\r\n            'transport_employees_count' => 0,\r\n            'transport_per_employee' => 0,\r\n        ];\r\n\r\n        foreach ($period as $dateObj) {\r\n            $date = $dateObj->toDateString();\r\n\r\n            $requestForDay = new Request([\r\n                'date' => $date,\r\n                'dollar_rate' => $dollarRate,\r\n            ]);\r\n\r\n            $daily = $this->getDailyCost($requestForDay)->getData(true);\r\n\r\n            $monthlyStats['aup'] += $daily['aup'] ?? 0;\r\n            $monthlyStats['kpi'] += $daily['kpi'] ?? 0;\r\n            $monthlyStats['transport_attendance'] += $daily['transport_attendance'] ?? 0;\r\n            $monthlyStats['tarification'] += $daily['tarification'] ?? 0;\r\n            $monthlyStats['daily_expenses'] += $daily['daily_expenses'] ?? 0;\r\n            $monthlyStats['total_earned_uzs'] += $daily['total_earned_uzs'] ?? 0;\r\n            $monthlyStats['total_output_cost_uzs'] += isset($daily['orders']) ? array_sum(array_column($daily['orders'], 'total_output_cost_uzs')) : 0;\r\n            $monthlyStats['total_fixed_cost_uzs'] += $daily['total_fixed_cost_uzs'] ?? 0;\r\n            $monthlyStats['net_profit_uzs'] += $daily['net_profit_uzs'] ?? 0;\r\n            $monthlyStats['employee_count_sum'] += $daily['employee_count'] ?? 0;\r\n            $monthlyStats['total_output_quantity'] += $daily['total_output_quantity'] ?? 0;\r\n            $monthlyStats['rasxod_limit_uzs'] += $daily['rasxod_limit_uzs'] ?? 0;\r\n            $monthlyStats['transport_employees_count'] += $daily['transport_employees_count'] ?? 0;\r\n            $monthlyStats['transport_per_employee'] += $daily['transport_per_employee'] ?? 0;\r\n\r\n            if (!isset($daily['orders'])) continue;\r\n\r\n            foreach ($daily['orders'] as $order) {\r\n                $orderId = $order['order']['id'] ?? null;\r\n                if (!$orderId) continue;\r\n\r\n                if (!isset($orderSummaries[$orderId])) {\r\n                    $orderSummaries[$orderId] = $order;\r\n                    $orderSummaries[$orderId]['total_earned_uzs'] = $order['total_output_cost_uzs']; // initial\r\n                    continue;\r\n                }\r\n\r\n                $orderSummaries[$orderId]['total_quantity'] += $order['total_quantity'];\r\n                $orderSummaries[$orderId]['rasxod_limit_uzs'] += $order['rasxod_limit_uzs'];\r\n                $orderSummaries[$orderId]['bonus'] += $order['bonus'];\r\n                $orderSummaries[$orderId]['tarification'] += $order['tarification'];\r\n                $orderSummaries[$orderId]['total_earned_uzs'] += $order['total_output_cost_uzs'];\r\n                $orderSummaries[$orderId]['total_output_cost_uzs'] += $order['total_output_cost_uzs'];\r\n                $orderSummaries[$orderId]['total_fixed_cost_uzs'] += $order['total_fixed_cost_uzs'];\r\n                $orderSummaries[$orderId]['net_profit_uzs'] += $order['net_profit_uzs'];\r\n\r\n                foreach ($order['costs_uzs'] as $key => $val) {\r\n                    if (!isset($orderSummaries[$orderId]['costs_uzs'][$key])) {\r\n                        $orderSummaries[$orderId]['costs_uzs'][$key] = 0;\r\n                    }\r\n                    $orderSummaries[$orderId]['costs_uzs'][$key] += $val;\r\n                }\r\n            }\r\n        }\r\n\r\n        foreach ($orderSummaries as &$order) {\r\n            $qty = max($order['total_quantity'], 1);\r\n            $totalCost = $order['total_fixed_cost_uzs'];\r\n            $earned = $order['total_earned_uzs'];\r\n\r\n            $order['cost_per_unit_uzs'] = round($totalCost / $qty);\r\n            $order['profit_per_unit_uzs'] = round(($earned / $qty) - $order['cost_per_unit_uzs']);\r\n            $order['profitability_percent'] = $totalCost > 0\r\n                ? round(($order['net_profit_uzs'] / $totalCost) * 100, 2)\r\n                : null;\r\n        }\r\n\r\n        $workingDays = collect($period)->filter(fn($date) => !$date->isSunday())->count();\r\n        $averageEmployeeCount = round($monthlyStats['employee_count_sum'] / max($workingDays, 1));\r\n        //        $perEmployeeCost = $monthlyStats['total_fixed_cost_uzs'] / max(1, $monthlyStats['employee_count_sum']);\r\n        // per_employee_cost_uzs breakdown\r\n        $employeeCount = max($monthlyStats['employee_count_sum'], 1);\r\n\r\n        $rasxodLimit = $monthlyStats['rasxod_limit_uzs'] / $employeeCount;\r\n        $transportCost = $monthlyStats['transport_attendance'] / $employeeCount;\r\n        $aupCost = $monthlyStats['aup'] / $employeeCount;\r\n        $monthlyExpenseCost = $monthlyStats['daily_expenses'] / $employeeCount;\r\n        $incomePercentageCost = collect($orderSummaries)->sum(fn($order) => $order['costs_uzs']['incomePercentageExpense'] ?? 0) / $employeeCount;\r\n        $amortizationCost = collect($orderSummaries)->sum(fn($order) => $order['costs_uzs']['amortizationExpense'] ?? 0) / $employeeCount;\r\n\r\n        $totalPerEmployee = $rasxodLimit + $transportCost + $aupCost + $monthlyExpenseCost + $incomePercentageCost + $amortizationCost;\r\n\r\n        $perEmployeeCosts = [\r\n            'rasxod_limit_uzs' => [\r\n                'amount' => round($rasxodLimit),\r\n                'percent' => round(($rasxodLimit / $totalPerEmployee) * 100, 2)\r\n            ],\r\n            'transport' => [\r\n                'amount' => round($transportCost),\r\n                'percent' => round(($transportCost / $totalPerEmployee) * 100, 2)\r\n            ],\r\n            'aup' => [\r\n                'amount' => round($aupCost),\r\n                'percent' => round(($aupCost / $totalPerEmployee) * 100, 2)\r\n            ],\r\n            'monthly_expense' => [\r\n                'amount' => round($monthlyExpenseCost),\r\n                'percent' => round(($monthlyExpenseCost / $totalPerEmployee) * 100, 2)\r\n            ],\r\n            'income_percentage_expense' => [\r\n                'amount' => round($incomePercentageCost),\r\n                'percent' => round(($incomePercentageCost / $totalPerEmployee) * 100, 2)\r\n            ],\r\n            'amortization_expense' => [\r\n                'amount' => round($amortizationCost),\r\n                'percent' => round(($amortizationCost / $totalPerEmployee) * 100, 2)\r\n            ],\r\n            'total' => round($totalPerEmployee)\r\n        ];\r\n\r\n        // Umumiy quantity va har bir dona uchun xarajat hisoblash\r\n        $costPerUnitOverall = $monthlyStats['total_output_quantity'] > 0\r\n            ? $monthlyStats['total_fixed_cost_uzs'] / $monthlyStats['total_output_quantity']\r\n            : 0;\r\n\r\n        return response()->json([\r\n            'start_date' => $start->toDateString(),\r\n            'end_date' => $end->toDateString(),\r\n            'days_in_period' => count($period),\r\n            'dollar_rate' => $dollarRate,\r\n            'aup' => $monthlyStats['aup'],\r\n            'kpi' => $monthlyStats['kpi'],\r\n            'transport_attendance' => $monthlyStats['transport_attendance'],\r\n            'tarification' => $monthlyStats['tarification'],\r\n            'monthly_expenses' => $monthlyStats['daily_expenses'],\r\n            'total_earned_uzs' => $monthlyStats['total_earned_uzs'],\r\n            'total_output_cost_uzs' => $monthlyStats['total_output_cost_uzs'],\r\n            'total_fixed_cost_uzs' => $monthlyStats['total_fixed_cost_uzs'],\r\n            'net_profit_uzs' => $monthlyStats['net_profit_uzs'],\r\n            'average_employee_count' => $averageEmployeeCount,\r\n            'per_employee_cost_uzs' => $perEmployeeCosts,\r\n            'orders' => array_values($orderSummaries),\r\n            'rasxod_limit_uzs' => $monthlyStats['rasxod_limit_uzs'],\r\n\r\n            'employee_count_sum' => $monthlyStats['employee_count_sum'],\r\n            'transport_employees_count' => $monthlyStats['transport_employees_count'],\r\n            'transport_per_employee' => $monthlyStats['transport_per_employee'],\r\n\r\n            // Yangi qo'shilgan qismlar\r\n            'total_output_quantity' => $monthlyStats['total_output_quantity'],\r\n            'cost_per_unit_overall_uzs' => round($costPerUnitOverall, 2),\r\n        ]);\r\n    }\r\n\r\n    public function getDailyCost(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $date = $request->date ?? Carbon::today()->toDateString();\r\n        $dollarRate = $request->dollar_rate ?? 12900;\r\n        $branchId = auth()->user()->employee->branch_id;\r\n\r\n        $carbonDate = Carbon::parse($date);\r\n        $daysInMonth = $carbonDate->daysInMonth;\r\n\r\n        // Shu sanadagi barcha ishchilarning IDlari\r\n        $relatedEmployeeIds = DB::table('employee_tarification_logs')\r\n            ->whereDate('date', $date)\r\n            ->whereIn('employee_id', Employee::where('branch_id', $branchId)->pluck('id'))\r\n            ->pluck('employee_id')\r\n            ->unique()\r\n            ->values();\r\n\r\n        // Transport - har doim hisoblanadi\r\n        $transport = DB::table('transport_attendance')\r\n            ->join('transport', 'transport_attendance.transport_id', '=', 'transport.id')\r\n            ->whereDate('transport_attendance.date', $date)\r\n            ->where('transport.branch_id', $branchId)\r\n            ->sum(DB::raw('(transport.salary + transport.fuel_bonus) * transport_attendance.attendance_type'));\r\n\r\n\r\n        // \uD83D\uDE8D Shu kuni transportda kelgan odamlar soni\r\n        $transportEmployeesCount = DB::table('employee_transport_daily as etd')\r\n            ->join('employees as e', 'etd.employee_id', '=', 'e.id')\r\n            ->join('transport as t', 'etd.transport_id', '=', 't.id')\r\n            ->whereDate('etd.date', $date)\r\n            ->where('t.branch_id', $branchId)   // transport shu filialdan bo‘lishi kerak\r\n            ->where('e.branch_id', $branchId)   // xodim ham shu filialdan bo‘lishi kerak\r\n            ->count('etd.employee_id');\r\n\r\n        // \uD83D\uDE8D Bir kishi uchun transport xarajati\r\n        $transportPerEmployee = $transportEmployeesCount > 0\r\n            ? $transport / $transportEmployeesCount\r\n            : 0;\r\n\r\n\r\n        // Monthly expenses ni type bo'yicha ajratish - har doim hisoblanadi\r\n        $monthlyExpenses = DB::table('monthly_expenses')\r\n            ->whereMonth('month', $carbonDate->month)\r\n            ->whereYear('month', $carbonDate->year)\r\n            ->where('branch_id', $branchId)\r\n            ->get();\r\n\r\n        // Type = 'monthly' bo'lgan xarajatlarni kuniga bo'lib hisoblash\r\n        $dailyExpenseMonthly = $monthlyExpenses\r\n                ->where('type', 'monthly')\r\n                ->sum('amount') / $daysInMonth;\r\n\r\n        $thisBranchEmployeeIds = Employee::where('branch_id', $branchId)->pluck('id');\r\n\r\n        // AUP xarajatlari - har doim hisoblanadi\r\n        $aup = DB::table('attendance_salary')\r\n            ->join('attendance', 'attendance_salary.attendance_id', '=', 'attendance.id')\r\n            ->join('employees', 'attendance_salary.employee_id', '=', 'employees.id')\r\n            ->where('employees.branch_id', $branchId)\r\n            ->where('employees.type', 'aup')\r\n            ->whereDate('attendance.date', $date)\r\n            ->whereIn('attendance_salary.employee_id', $thisBranchEmployeeIds)\r\n            ->sum('attendance_salary.amount');\r\n\r\n        // AUP emas lekin oylikka ishlovchilar - har doim hisoblanadi\r\n        $isNotAup = DB::table('attendance_salary')\r\n            ->join('attendance', 'attendance_salary.attendance_id', '=', 'attendance.id')\r\n            ->join('employees', 'attendance_salary.employee_id', '=', 'employees.id')\r\n            ->where('employees.branch_id', $branchId)\r\n            ->where('employees.type', '!=', 'aup')\r\n            ->whereDate('attendance.date', $date)\r\n            ->whereIn('attendance_salary.employee_id', $thisBranchEmployeeIds)\r\n            ->sum('attendance_salary.amount');\r\n\r\n        // Ishchilar soni - har doim hisoblanadi\r\n        $employees = Attendance::whereDate('date', $date)\r\n            ->where('status', 'present')\r\n            ->whereHas('employee', function ($q) use ($branchId)  {\r\n                $q->where('status', '!=', 'kicked');\r\n                $q->where('branch_id', $branchId);\r\n            })->count();\r\n\r\n        $outputs = SewingOutputs::with([\r\n            'orderSubmodel.orderModel.order',\r\n            'orderSubmodel.orderModel.model',\r\n            'orderSubmodel.orderModel.submodels.submodel'\r\n        ])\r\n            ->whereDate('created_at', $date)\r\n            ->whereHas('orderSubmodel.orderModel.order', function ($q) use ($branchId) {\r\n                $q->where('branch_id', $branchId);\r\n            })\r\n            ->get();\r\n\r\n        $grouped = $outputs->groupBy(fn($item) => optional($item->orderSubmodel->orderModel)->order_id);\r\n        $totalOutputQty = $outputs->sum('quantity');\r\n\r\n        // Agar orders mavjud bo'lsa, ularga xos harajatlarni hisoblash\r\n        $orders = collect();\r\n        $totalEarned = 0;\r\n        $totalOrderSpecificCosts = 0;\r\n\r\n        if ($grouped->count() > 0) {\r\n            $orders = $grouped->map(function ($items) use (\r\n                $dollarRate, $date, $relatedEmployeeIds,\r\n                $dailyExpenseMonthly, $transport, $aup, $isNotAup, $totalOutputQty, $monthlyExpenses\r\n            ) {\r\n                $first = $items->first();\r\n\r\n                $orderModel = optional(optional($first)->orderSubmodel)->orderModel;\r\n                $order = optional($orderModel)->order;\r\n\r\n                $orderId = $order->id ?? null;\r\n\r\n                $totalQty = $items->sum('quantity');\r\n                $priceUSD = $order->price ?? 0;\r\n                $priceUZS = $priceUSD * $dollarRate;\r\n\r\n                $submodelSpendsSum = \\DB::table('order_sub_models as osm')\r\n                    ->join('submodel_spends as ss', 'ss.submodel_id', '=', 'osm.id')\r\n                    ->where('osm.order_model_id', $orderModel->id)\r\n                    ->where('ss.region', 'uz')\r\n                    ->sum('ss.summa');\r\n\r\n                $remainder = $submodelSpendsSum * $totalQty;\r\n\r\n\r\n                $bonus = DB::table('bonuses')\r\n                    ->whereDate('created_at', $date)\r\n                    ->where('order_id', $orderId)\r\n                    ->sum('amount');\r\n\r\n                $tarification = DB::table('employee_tarification_logs')\r\n                    ->join('tarifications', 'employee_tarification_logs.tarification_id', '=', 'tarifications.id')\r\n                    ->join('tarification_categories', 'tarifications.tarification_category_id', '=', 'tarification_categories.id')\r\n                    ->join('order_sub_models', 'tarification_categories.submodel_id', '=', 'order_sub_models.id')\r\n                    ->join('order_models', 'order_sub_models.order_model_id', '=', 'order_models.id')\r\n                    ->join('orders', 'order_models.order_id', '=', 'orders.id')\r\n                    ->whereDate('employee_tarification_logs.date', $date)\r\n                    ->where('orders.id', $orderId)\r\n                    ->sum('employee_tarification_logs.amount_earned');\r\n\r\n                // Type bo'yicha xarajatlarni hisoblash\r\n                $orderShareRatio = $totalOutputQty > 0 ? $totalQty / $totalOutputQty : 0;\r\n\r\n                // Monthly type xarajat\r\n                $allocatedMonthlyExpenseMonthly = $dailyExpenseMonthly * $orderShareRatio;\r\n\r\n                // Income percentage type xarajat\r\n                $incomePercentageExpense = 0;\r\n                $incomePercentageExpenses = $monthlyExpenses->where('type', 'income_percentage');\r\n                foreach ($incomePercentageExpenses as $expense) {\r\n                    $percentageAmount = ($priceUZS * $totalQty) * ($expense->amount / 100);\r\n                    $incomePercentageExpense += $percentageAmount;\r\n                }\r\n\r\n                // Amortization type xarajat (har bir mahsulot uchun 10 sent)\r\n                $amortizationExpense = 0;\r\n                $amortizationExpenses = $monthlyExpenses->where('type', 'amortization');\r\n                if ($amortizationExpenses->count() > 0) {\r\n                    $amortizationExpense = $totalQty * 0.10 * $dollarRate;\r\n                }\r\n\r\n                $fixedCost = $bonus + $remainder;\r\n\r\n                $allocatedTransport = $transport * $orderShareRatio;\r\n                $allocatedAup = $aup * $orderShareRatio;\r\n                $allocatedIsNotAup = $isNotAup * $orderShareRatio;\r\n\r\n                $totalExtra = $allocatedTransport + $allocatedAup + $allocatedMonthlyExpenseMonthly + $incomePercentageExpense + $amortizationExpense;\r\n\r\n                $perUnitCost = $totalQty > 0 ? ($fixedCost + $totalExtra) / $totalQty : 0;\r\n                $profitUZS = ($priceUZS * $totalQty) - ($fixedCost + $totalExtra);\r\n\r\n                $responsibleUsers = $orderModel->submodels->map(function ($submodel) {\r\n                    return optional($submodel->group->group)->responsibleUser;\r\n                })->filter()->unique('id')->values();\r\n\r\n                $rasxodPercentOfPrice = $priceUZS > 0\r\n                    ? round((($submodelSpendsSum ?? 0) / $priceUZS) * 100, 2)\r\n                    : null;\r\n\r\n                return [\r\n                    'order' => $order,\r\n                    'responsibleUser' => $responsibleUsers,\r\n                    'model' => $orderModel->model ?? null,\r\n                    'submodels' => $orderModel->submodels->pluck('submodel')->filter()->values(),\r\n                    'price_usd' => $priceUSD,\r\n                    'price_uzs' => $priceUZS,\r\n                    'total_quantity' => $totalQty,\r\n                    'rasxod_limit_uzs' => $remainder,\r\n                    'rasxod_percent_of_price' => $rasxodPercentOfPrice,\r\n                    'bonus' => $bonus,\r\n                    'tarification' => $tarification,\r\n                    'total_output_cost_uzs' => $priceUSD * $totalQty * $dollarRate,\r\n                    'costs_uzs' => compact('bonus', 'remainder', 'tarification', 'allocatedTransport', 'allocatedAup', 'allocatedMonthlyExpenseMonthly', 'incomePercentageExpense', 'amortizationExpense'),\r\n                    'total_fixed_cost_uzs' => $fixedCost + $totalExtra,\r\n                    'net_profit_uzs' => $profitUZS,\r\n                    'cost_per_unit_uzs' => round($perUnitCost),\r\n                    'profit_per_unit_uzs' => round(($priceUZS - $perUnitCost)),\r\n                    'profitability_percent' => ($fixedCost + $totalExtra) > 0\r\n                        ? round(($profitUZS / ($fixedCost + $totalExtra)) * 100, 2)\r\n                        : null,\r\n                ];\r\n            })->values();\r\n\r\n            $totalEarned = $orders->sum('total_output_cost_uzs');\r\n            $totalOrderSpecificCosts = $orders->sum('total_fixed_cost_uzs');\r\n        }\r\n\r\n        // Agar orders bo'sh bo'lsa ham harajatlarni hisoblash\r\n        $totalIncomePercentageExpense = $orders->sum('costs_uzs.incomePercentageExpense');\r\n        $totalAmortizationExpense = $orders->sum('costs_uzs.amortizationExpense');\r\n\r\n        // Kunlik xarajat (orders bo'lmasa ham mavjud)\r\n        $dailyExpense = $dailyExpenseMonthly + $totalIncomePercentageExpense + $totalAmortizationExpense;\r\n\r\n        // Umumiy harajat (orders bo'lmasa ham o'zgarmas harajatlar mavjud)\r\n        $totalFixedCost = $transport + $aup + $dailyExpense + $orders->sum('rasxod_limit_uzs') ;\r\n\r\n        // Per employee cost calculation\r\n        $perEmployeeCosts = [];\r\n        $employeeCount = max($employees, 1);\r\n\r\n        $rasxodLimit = $orders->sum('rasxod_limit_uzs') / $employeeCount;\r\n        $transportCost = $transport / $employeeCount;\r\n        $aupCost = $aup / $employeeCount;\r\n        $isNotAupCost = $isNotAup / $employeeCount;\r\n        $monthlyExpenseCost = $dailyExpenseMonthly / $employeeCount;\r\n        $incomePercentageCost = $totalIncomePercentageExpense / $employeeCount;\r\n        $amortizationCost = $totalAmortizationExpense / $employeeCount;\r\n\r\n        $totalPerEmployee = $rasxodLimit + $transportCost + $aupCost + $monthlyExpenseCost + $incomePercentageCost + $amortizationCost;\r\n\r\n        $perEmployeeCosts = [\r\n            'rasxod_limit_uzs' => [\r\n                'amount' => round($rasxodLimit),\r\n                'percent' => $totalPerEmployee > 0 ? round(($rasxodLimit / $totalPerEmployee) * 100, 2) : 0\r\n            ],\r\n            'transport' => [\r\n                'amount' => round($transportCost),\r\n                'percent' => $totalPerEmployee > 0 ? round(($transportCost / $totalPerEmployee) * 100, 2) : 0\r\n            ],\r\n            'aup' => [\r\n                'amount' => round($aupCost),\r\n                'percent' => $totalPerEmployee > 0 ? round(($aupCost / $totalPerEmployee) * 100, 2) : 0\r\n            ],\r\n            'monthly_expense' => [\r\n                'amount' => round($monthlyExpenseCost),\r\n                'percent' => $totalPerEmployee > 0 ? round(($monthlyExpenseCost / $totalPerEmployee) * 100, 2) : 0\r\n            ],\r\n            'income_percentage_expense' => [\r\n                'amount' => round($incomePercentageCost),\r\n                'percent' => $totalPerEmployee > 0 ? round(($incomePercentageCost / $totalPerEmployee) * 100, 2) : 0\r\n            ],\r\n            'amortization_expense' => [\r\n                'amount' => round($amortizationCost),\r\n                'percent' => $totalPerEmployee > 0 ? round(($amortizationCost / $totalPerEmployee) * 100, 2) : 0\r\n            ],\r\n            'total' => round($totalPerEmployee)\r\n        ];\r\n\r\n        // Cost per unit calculation\r\n        $costPerUnitOverall = $totalOutputQty > 0 ? $totalFixedCost / $totalOutputQty : 0;\r\n\r\n        // Tarification calculation (orders bo'lmasa ham hisoblanishi kerak)\r\n        $tarificationTotal = DB::table('employee_tarification_logs')\r\n            ->join('tarifications', 'employee_tarification_logs.tarification_id', '=', 'tarifications.id')\r\n            ->join('tarification_categories', 'tarifications.tarification_category_id', '=', 'tarification_categories.id')\r\n            ->join('order_sub_models', 'tarification_categories.submodel_id', '=', 'order_sub_models.id')\r\n            ->join('order_models', 'order_sub_models.order_model_id', '=', 'order_models.id')\r\n            ->join('orders', 'order_models.order_id', '=', 'orders.id')\r\n            ->whereDate('employee_tarification_logs.date', $date)\r\n            ->whereIn('employee_tarification_logs.employee_id', $relatedEmployeeIds)\r\n            ->sum('employee_tarification_logs.amount_earned');\r\n\r\n        // Bonuses calculation (orders bo'lmasa ham hisoblanishi kerak)\r\n        $kpiTotal = DB::table('bonuses')->whereDate('created_at', $date)->sum('amount');\r\n\r\n        return response()->json([\r\n            'date' => $date,\r\n            'dollar_rate' => $dollarRate,\r\n            'orders' => $orders,\r\n            'transport_attendance' => $transport,\r\n            'transport_employees_count' => $transportEmployeesCount,\r\n            'transport_per_employee' => round($transportPerEmployee),\r\n            'daily_expenses' => $dailyExpense,\r\n            'aup' => $aup,\r\n            'isNotAup' => $isNotAup,\r\n            'total_earned_uzs' => $totalEarned,\r\n            'total_fixed_cost_uzs' => $totalFixedCost,\r\n            'employee_count' => $employees,\r\n            'rasxod_limit_uzs' => $orders->sum('rasxod_limit_uzs'),\r\n            'per_employee_cost_uzs' => $perEmployeeCosts,\r\n            'net_profit_uzs' => $totalEarned - $totalFixedCost,\r\n            'kpi' => $kpiTotal,\r\n            'tarification' => $tarificationTotal,\r\n            'total_output_quantity' => $totalOutputQty,\r\n            'cost_per_unit_overall_uzs' => round($costPerUnitOverall, 2),\r\n        ]);\r\n    }\r\n\r\n    public function getMonthlyExpense(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $month = $request->input('month', Carbon::now()->format('Y-m'));\r\n        $expenses = MonthlyExpense::whereMonth('month', Carbon::parse($month)->month)\r\n            ->whereYear('month', Carbon::parse($month)->year)\r\n            ->where('branch_id', auth()->user()->employee->branch_id)\r\n            ->get();\r\n\r\n        if ($expenses->isEmpty()) {\r\n            return response()->json(\r\n                [\r\n                    'month' => $month,\r\n                'expenses' => []\r\n                ],\r\n            );\r\n        }\r\n\r\n        return response()->json([\r\n            'month' => $month,\r\n            'expenses' => $expenses->map(function ($expense) {\r\n                return [\r\n                    'id' => $expense->id,\r\n                    'name' => $expense->name,\r\n                    'type' => $expense->type,\r\n                    'amount' => $expense->amount,\r\n                    'date' => $expense->month,\r\n                ];\r\n            }),\r\n        ]);\r\n    }\r\n\r\n    public function storeMonthlyExpense(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $validated = $request->validate([\r\n            'type' => 'required|string',\r\n            'amount' => 'required|numeric|min:0',\r\n            'month' => 'required|date_format:Y-m',\r\n            'name' => 'required|string|max:255',\r\n        ]);\r\n\r\n        $expense = MonthlyExpense::create([\r\n            'type' => $validated['type'],\r\n            'amount' => $validated['amount'],\r\n            'month' => $validated['month'] . '-01',\r\n            'name' => $validated['name'],\r\n            'branch_id' => auth()->user()->employee->branch_id,\r\n        ]);\r\n\r\n        return response()->json(['message' => 'Saved', 'data' => $expense]);\r\n    }\r\n\r\n    public function editMonthlyExpense($id, Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $validated = $request->validate([\r\n            'type' => 'nullable|string',\r\n            'amount' => 'nullable|numeric|min:0',\r\n            'month' => 'nullable|date_format:Y-m',\r\n            'name' => 'nullable|string|max:255',\r\n        ]);\r\n        $expense = MonthlyExpense::findOrFail($id);\r\n\r\n        if (isset($validated['month'])) {\r\n            $validated['month'] .= '-01'; // 2025-06 => 2025-06-01\r\n        }\r\n\r\n        $expense->update($validated);\r\n\r\n        return response()->json(['message' => 'Updated', 'data' => $expense]);\r\n    }\r\n\r\n    public function exportGroupsByDepartmentIdPdf(Request $request): \\Illuminate\\Http\\Response|\\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $departmentId = $request->input('department_id');\r\n        $startDate = $request->input('start_date');\r\n        $endDate = $request->input('end_date');\r\n        $group_id = $request->input('group_id');\r\n        $orderIds = $request->input('order_ids', []); // ✅ order_ids qo‘shdik\r\n\r\n        if (!$departmentId) {\r\n            return response()->json(['message' => '❌ department_id kiritilmadi.'], 422);\r\n        }\r\n\r\n        $groupQuery = Group::where('department_id', $departmentId)\r\n            ->with(['employees' => function ($query) {\r\n                $query->select('id', 'name', 'position_id', 'group_id', 'balance', 'payment_type', 'status', 'type')\r\n                    ->where('type', '!=', 'aup')\r\n                    ->with('salaryPayments');\r\n            }]);\r\n\r\n        if (!empty($group_id)) {\r\n            $groupQuery->where('id', $group_id);\r\n        }\r\n\r\n        $groups = $groupQuery->get();\r\n\r\n        $result = $groups->map(function ($group) use ($startDate, $endDate, $orderIds) {\r\n            $employees = $group->employees\r\n                ->map(fn($employee) => $this->getEmployeeEarnings($employee, $startDate, $endDate, $orderIds)) // ✅ orderIds qo‘shildi\r\n                ->filter(function ($employeeData) {\r\n                    if (!$employeeData) {\r\n                        return false;\r\n                    }\r\n                    if (\r\n                        ($employeeData['total_earned'] ?? 0) == 0 &&\r\n                        ($employeeData['balance'] ?? 0) == 0\r\n                    ) {\r\n                        return false;\r\n                    }\r\n                    return true;\r\n                })\r\n                ->sortBy(fn($e) => mb_strtolower($e['name'] ?? ''))\r\n                ->values();\r\n\r\n            $groupTotal = $employees->sum(fn($e) => $e['balance'] ?? 0);\r\n\r\n            return [\r\n                'id' => $group->id,\r\n                'name' => $group->name,\r\n                'total_balance' => $groupTotal,\r\n                'employees' => $employees->values()->toArray(),\r\n            ];\r\n        })->values()->toArray();\r\n\r\n        /*\r\n        // Guruhsiz xodimlar (hozircha jo‘natilmaydi)\r\n        $ungroupedEmployees = Employee::where('department_id', $departmentId)\r\n            ->whereNull('group_id')\r\n            ->where('type', '!=', 'aup')\r\n            ->select('id', 'name', 'group_id', 'position_id', 'balance', 'payment_type', 'status', 'type')\r\n            ->with('salaryPayments')\r\n            ->get()\r\n            ->map(fn($employee) => $this->getEmployeeEarnings($employee, $startDate, $endDate, $orderIds))\r\n            ->filter(function ($employeeData) {\r\n                if (!$employeeData) {\r\n                    return false;\r\n                }\r\n                if (\r\n                    ($employeeData['total_earned'] ?? 0) == 0 &&\r\n                    ($employeeData['balance'] ?? 0) == 0\r\n                ) {\r\n                    return false;\r\n                }\r\n                return true;\r\n            })\r\n            ->sortBy(fn($e) => mb_strtolower($e['name'] ?? ''))\r\n            ->values();\r\n\r\n        if ($ungroupedEmployees->isNotEmpty()) {\r\n            $ungroupedTotal = $ungroupedEmployees->sum(fn($e) => $e['balance'] ?? 0);\r\n            $result[] = [\r\n                'id' => null,\r\n                'name' => 'Guruhsiz',\r\n                'total_balance' => $ungroupedTotal,\r\n                'employees' => $ungroupedEmployees->values()->toArray(),\r\n            ];\r\n        }\r\n        */\r\n\r\n        // PDF yasash\r\n        $pdf = Pdf::loadView('pdf.group-salary-report', [\r\n            'data' => $result,\r\n            'startDate' => $startDate,\r\n            'endDate' => $endDate,\r\n        ])->setPaper('a4', 'landscape');\r\n\r\n        return $pdf->download('group-salary-report.pdf');\r\n    }\r\n\r\n    public function giveSalaryOrAdvance(Request $request)\r\n    {\r\n        return DB::transaction(function () use ($request) {\r\n\r\n            $validated = $request->validate([\r\n                'employee_id' => 'required|exists:employees,id',\r\n                'amount' => 'required|numeric',\r\n                'month' => 'required|date_format:Y-m',\r\n                'type' => 'required|in:salary,advance',\r\n                'comment' => 'nullable|string',\r\n            ]);\r\n\r\n            $validated['month'] = Carbon::createFromFormat('Y-m', $validated['month'])->startOfMonth();\r\n            $employee = Employee::findOrFail($validated['employee_id']);\r\n\r\n            // ⛔ ONLY If amount is negative — CONTROL RULES APPLY\r\n//            if ($validated['amount'] < 0) {\r\n\r\n                $lastPayment = SalaryPayment::where('employee_id', $validated['employee_id'])\r\n                    ->orderByDesc('id')\r\n                    ->first();\r\n\r\n//                if (!$lastPayment) {\r\n//                    return response()->json([\r\n//                        'message' => \"Oldin to‘lov yo‘q — minus qilishga ruxsat yo‘q!\"\r\n//                    ], 500);\r\n//                }\r\n\r\n                 //QOIDA #2: 5 daqiqa o'tgan bo'lsa — Block\r\n                 if ($lastPayment->created_at->lt(now()->subMinutes(5))) {\r\n                     return response()->json([\r\n                         'message' => \"Oxirgi to‘lovdan 5 daqiqa o‘tib ketgan \uD83D\uDE09\"\r\n                     ], 500);\r\n                 }\r\n\r\n                // QOIDA #3: Minus kattalik check\r\n//                if (abs($validated['amount']) > abs($lastPayment->amount)) {\r\n//                    return response()->json([\r\n//                        'message' => \"Minus miqdori oxirgi to‘lovni oshib ketmasin! (Limit: {$lastPayment->amount})\"\r\n//                    ], 403);\r\n//                }\r\n//            }\r\n\r\n            $cashboxBalance = CashboxBalance::with('cashbox')\r\n                ->whereHas('cashbox', fn($q) =>\r\n                $q->where('branch_id', auth()->user()->employee->branch_id)\r\n                )\r\n                ->whereHas('currency', fn($q) =>\r\n                $q->where('name', \"So'm\")\r\n                )\r\n                ->firstOrFail();\r\n\r\n            $cashboxId = $cashboxBalance->cashbox_id;\r\n            $currency = Currency::where('name', \"So'm\")->firstOrFail();\r\n\r\n            // ✅ SalaryPayment yoziladi\r\n            $payment = SalaryPayment::create([\r\n                'employee_id' => $validated['employee_id'],\r\n                'amount' => $validated['amount'],\r\n                'month' => $validated['month'],\r\n                'type' => $validated['type'],\r\n                'comment' => $validated['comment'] ?? null,\r\n            ]);\r\n\r\n            // ✅ CashboxTransaction yoziladi\r\n            CashboxTransaction::create([\r\n                'cashbox_id' => $cashboxId,\r\n                'currency_id' => $currency->id,\r\n                'type' => 'expense',\r\n                'amount' => $validated['amount'],\r\n                'date' => now()->toDateString(),\r\n                'destination_id' => $employee->id,\r\n                'via_id' => auth()->user()->employee->id,\r\n                'purpose' => $validated['type'] === 'advance' ? 'Avans to‘lovi' : 'Oylik to‘lovi',\r\n                'comment' => $validated['type'] === 'advance' ? $employee->name . ' uchun avans to‘lovi | '. $validated['comment'] ?? null : $employee->name . ' uchun avans to‘lovi | ' . $validated['comment'] ?? null,\r\n                'branch_id' => auth()->user()->employee->branch_id,\r\n            ]);\r\n\r\n            // ✅ Balanslarni yangilash\r\n            $employee->decrement('balance', $validated['amount']);\r\n            $cashboxBalance->decrement('amount', $validated['amount']);\r\n\r\n            // ✅ Telegram xabar\r\n            // ✅ Telegram xabar\r\n            DB::afterCommit(function () use ($employee, $validated, $cashboxBalance) {\r\n\r\n                $remainingBalance = number_format($cashboxBalance->amount, 0, '.', ' ');\r\n\r\n                $text = \"\uD83D\uDCB8 *To‘lov amalga oshirildi!*\\n\"\r\n                    . \"\uD83D\uDC64 Xodim: {$employee->name}\\n\"\r\n                    . \"\uD83D\uDCB0 Miqdor: \" . number_format($validated['amount'], 0, '.', ' ') . \" so‘m\\n\"\r\n                    . \"\uD83D\uDCC5 Oy: \" . $validated['month']->format('Y-m') . \"\\n\"\r\n                    . \"\uD83C\uDFF7\uFE0F Turi: \" . ($validated['type'] === 'advance' ? 'Avans' : 'Oylik') . \"\\n\"\r\n                    . \"\uD83C\uDFE6 Qolgan balans: *{$remainingBalance} so‘m*\\n\"\r\n                    . \"\\n\uD83D\uDCDD Izoh: \" . ($validated['comment'] ?? '-');\r\n\r\n                Http::post(\"https://api.telegram.org/bot\" . '7778276162:AAHVKgbh5mJlgp7jMhw_VNunvvR3qoDyjms' . \"/sendMessage\", [\r\n                    'chat_id' => -979504247,\r\n                    'text' => $text,\r\n                    'parse_mode' => 'Markdown',\r\n                ]);\r\n            });\r\n        });\r\n    }\r\n\r\n    public function getOrders(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n\r\n        $orders = \\App\\Models\\Order::with(['orderModel.submodels.submodel', 'orderModel.model', 'orderModel.submodels.group.group'])\r\n            ->where('branch_id', auth()->user()->employee->branch_id)\r\n            ->get();\r\n\r\n        return response()->json($orders);\r\n    }\r\n\r\n    public function exportEmployeeAttendance(Request $request)\r\n    {\r\n        $departmentId = $request->input('department_id');\r\n        $branchId = auth()->user()->employee->branch_id;\r\n        $groupId = $request->input('group_id');\r\n        $month = $request->input('month', date('Y-m')); // Format: 2024-01\r\n        $type = $request->input('type'); // aup, simple\r\n\r\n        // Oyning birinchi va oxirgi kunlarini aniqlash\r\n        $startDate = Carbon::createFromFormat('Y-m', $month)->startOfMonth();\r\n        $endDate = Carbon::createFromFormat('Y-m', $month)->endOfMonth();\r\n        $daysInMonth = $startDate->daysInMonth;\r\n\r\n        // Xodimlarni olish\r\n        $employeeQuery = Employee::select('id', 'name', 'group_id', 'department_id')\r\n            ->with(['group:id,name', 'department:id,name']);\r\n\r\n        $employeeQuery->where('status', 'working');\r\n\r\n        // Filtrlar\r\n        if ($departmentId) {\r\n            $employeeQuery->where('department_id', $departmentId);\r\n        } elseif ($branchId) {\r\n            $employeeQuery->whereHas('department', function ($query) use ($branchId) {\r\n                $query->where('branch_id', $branchId);\r\n            });\r\n        }\r\n\r\n        if ($groupId) {\r\n            $employeeQuery->where('group_id', $groupId);\r\n        }\r\n\r\n        if ($type === 'aup') {\r\n            $employeeQuery->where('type', 'aup');\r\n        } elseif ($type === 'simple') {\r\n            $employeeQuery->where('type', '!=', 'aup');\r\n        } else {\r\n            $employeeQuery->whereIn('type', ['aup', 'simple']);\r\n        }\r\n\r\n        $employees = $employeeQuery->orderBy('name')->get();\r\n\r\n        if ($employees->isEmpty()) {\r\n            return response()->json(['message' => 'Xodimlar topilmadi'], 404);\r\n        }\r\n\r\n        // Excel yaratish\r\n        $spreadsheet = new Spreadsheet();\r\n        $sheet = $spreadsheet->getActiveSheet();\r\n\r\n        // Sarlavha\r\n        $sheet->setCellValue('A1', '№');\r\n        $sheet->setCellValue('B1', 'Xodim ismi');\r\n\r\n        // Kunlarni qo'yish (C1 dan boshlab)\r\n        for ($day = 1; $day <= $daysInMonth; $day++) {\r\n            $column = \\PhpOffice\\PhpSpreadsheet\\Cell\\Coordinate::stringFromColumnIndex($day + 2); // C, D, E...\r\n            $sheet->setCellValue($column . '1', $day);\r\n        }\r\n\r\n        // Xodimlar ma'lumotlarini qo'yish\r\n        $row = 2;\r\n        foreach ($employees as $index => $employee) {\r\n            $sheet->setCellValue('A' . $row, $index + 1);\r\n            $sheet->setCellValue('B' . $row, $employee->name);\r\n\r\n            // Kunlar uchun bo'sh kataklar (istegancha to'ldirish mumkin)\r\n            for ($day = 1; $day <= $daysInMonth; $day++) {\r\n                $column = \\PhpOffice\\PhpSpreadsheet\\Cell\\Coordinate::stringFromColumnIndex($day + 2);\r\n                $sheet->setCellValue($column . $row, ''); // Bo'sh katak\r\n            }\r\n\r\n            $row++;\r\n        }\r\n\r\n        // Styling\r\n        $headerRange = 'A1:' . \\PhpOffice\\PhpSpreadsheet\\Cell\\Coordinate::stringFromColumnIndex($daysInMonth + 2) . '1';\r\n        $sheet->getStyle($headerRange)->applyFromArray([\r\n            'font' => ['bold' => true],\r\n            'alignment' => ['horizontal' => Alignment::HORIZONTAL_CENTER],\r\n            'borders' => ['allBorders' => ['borderStyle' => Border::BORDER_THIN]],\r\n            'fill' => [\r\n                'fillType' => \\PhpOffice\\PhpSpreadsheet\\Style\\Fill::FILL_SOLID,\r\n                'startColor' => ['rgb' => 'E2E8F0']\r\n            ]\r\n        ]);\r\n\r\n        // Barcha ma'lumotlar uchun border\r\n        $dataRange = 'A1:' . \\PhpOffice\\PhpSpreadsheet\\Cell\\Coordinate::stringFromColumnIndex($daysInMonth + 2) . ($row - 1);\r\n        $sheet->getStyle($dataRange)->applyFromArray([\r\n            'borders' => ['allBorders' => ['borderStyle' => Border::BORDER_THIN]]\r\n        ]);\r\n\r\n        // Column width\r\n        $sheet->getColumnDimension('A')->setWidth(5);\r\n        $sheet->getColumnDimension('B')->setWidth(25);\r\n        for ($day = 1; $day <= $daysInMonth; $day++) {\r\n            $column = \\PhpOffice\\PhpSpreadsheet\\Cell\\Coordinate::stringFromColumnIndex($day + 2);\r\n            $sheet->getColumnDimension($column)->setWidth(4);\r\n        }\r\n\r\n        // Fayl nomini yaratish\r\n        $fileName = 'Xodimlar_Davomat_' . $month . '_' . date('YmdHis') . '.xlsx';\r\n\r\n        // Response headers\r\n        $response = response()->streamDownload(function () use ($spreadsheet) {\r\n            $writer = new Xlsx($spreadsheet);\r\n            $writer->save('php://output');\r\n        }, $fileName, [\r\n            'Content-Type' => 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\r\n            'Content-Disposition' => 'attachment; filename=\"' . $fileName . '\"',\r\n        ]);\r\n\r\n        return $response;\r\n    }\r\n\r\n    public function getGroupsByDepartmentId(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $departmentId = $request->input('department_id');\r\n        $branchId = auth()->user()->employee->branch_id;\r\n        $startDate = $request->input('start_date');\r\n        $endDate = $request->input('end_date');\r\n        $group_id = $request->input('group_id');\r\n        $orderIds = $request->input('order_ids', []); // array\r\n        $type = $request->input('type'); // normal yoki aup\r\n\r\n        // Agar department_id ham, branch_id ham kelmasa xato\r\n        if (!$departmentId && !$branchId) {\r\n            return response()->json(['message' => '❌ department_id yoki branch_id kiritilishi shart.'], 422);\r\n        }\r\n\r\n        // Guruhlarni olish\r\n        $groupQuery = Group::query();\r\n\r\n        if ($departmentId) {\r\n            // Agar department_id berilgan bo'lsa\r\n            $groupQuery->where('department_id', $departmentId);\r\n        } elseif ($branchId) {\r\n            // Agar faqat branch_id berilgan bo'lsa, shu branchdagi barcha departmentlar\r\n            $groupQuery->whereHas('department', function ($query) use ($branchId) {\r\n                $query->where('branch_id', $branchId);\r\n            });\r\n        }\r\n\r\n        $groupQuery->with(['employees' => function ($query) use ($type) {\r\n            $query->select('id', 'name', 'position_id', 'group_id', 'salary', 'balance', 'payment_type', 'status')\r\n                ->with('salaryPayments');\r\n            if ($type === 'aup') {\r\n                $query->where('type', 'aup');\r\n            } elseif ($type === 'simple') {\r\n                $query->where('type', '!=', 'aup');\r\n            } else {\r\n                $query->whereIn('type', ['aup','simple']);\r\n            }\r\n        }]);\r\n\r\n        if (!empty($group_id)) {\r\n            $groupQuery->where('id', $group_id);\r\n        }\r\n\r\n        $groups = $groupQuery->get();\r\n\r\n        $result = $groups->map(function ($group) use ($startDate, $endDate, $orderIds) {\r\n            $employees = $group->employees\r\n                ->map(function ($employee) use ($startDate, $endDate, $orderIds) {\r\n                    return $this->getEmployeeEarnings($employee, $startDate, $endDate, $orderIds);\r\n                })\r\n                ->filter();\r\n\r\n            $groupTotal = $employees->sum(fn($e) => $e['balance'] ?? 0);\r\n\r\n            return [\r\n                'id' => $group->id,\r\n                'name' => $group->name,\r\n                'total_balance' => $groupTotal,\r\n                'employees' => $employees->values()->toArray(),\r\n            ];\r\n        })->values()->toArray();\r\n\r\n        // Guruhsiz xodimlarni olish\r\n        $ungroupedQuery = Employee::whereNull('group_id');\r\n\r\n        if ($departmentId) {\r\n            $ungroupedQuery->where('department_id', $departmentId);\r\n        } elseif ($branchId) {\r\n            $ungroupedQuery->whereHas('department', function ($query) use ($branchId) {\r\n                $query->where('branch_id', $branchId);\r\n            });\r\n        }\r\n\r\n        $ungroupedEmployees = $ungroupedQuery\r\n            ->when($type === 'aup', fn($q) => $q->where('type', 'aup'))\r\n            ->when($type === 'simple', fn($q) => $q->where('type', '!=', 'aup'))\r\n            ->when(!$type || !in_array($type, ['aup', 'simple']), fn($q) => $q->whereIn('type', ['aup','simple']))\r\n            ->select('id', 'name', 'group_id', 'position_id', 'balance', 'salary', 'payment_type', 'status')\r\n            ->with('salaryPayments')\r\n            ->get()\r\n            ->map(function ($employee) use ($startDate, $endDate, $orderIds) {\r\n                return $this->getEmployeeEarnings($employee, $startDate, $endDate, $orderIds);\r\n            })\r\n            ->filter();\r\n\r\n        if ($ungroupedEmployees->isNotEmpty()) {\r\n            $ungroupedTotal = $ungroupedEmployees->sum(fn($e) => $e['balance'] ?? 0);\r\n\r\n            $result[] = [\r\n                'id' => null,\r\n                'name' => 'Guruhsiz',\r\n                'total_balance' => $ungroupedTotal,\r\n                'employees' => $ungroupedEmployees->values()->toArray(),\r\n            ];\r\n        }\r\n\r\n        return response()->json($result);\r\n    }\r\n\r\n    //2-usul\r\n\r\n    public function getGroupsOrdersEarnings(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $departmentId = $request->input('department_id');\r\n        $branchId = auth()->user()->employee->branch_id ?? null;\r\n        $groupId = $request->input('group_id');\r\n        $type = $request->input('type');\r\n        $month = $request->input('month', date('Y-m'));\r\n\r\n        if (!$departmentId && !$branchId) {\r\n            return response()->json(['message' => '❌ department_id yoki branch_id kiritilishi shart.'], 422);\r\n        }\r\n\r\n        $monthDate = Carbon::createFromFormat('Y-m', $month)->startOfMonth()->toDateString();\r\n        $startDate = Carbon::createFromFormat('Y-m', $month)->startOfMonth()->toDateString();\r\n        $endDate = Carbon::createFromFormat('Y-m', $month)->endOfMonth()->toDateString();\r\n\r\n        // BULK: Barcha kerakli order ID'larni bir marta olamiz\r\n        $addOrderIds = MonthlySelectedOrder::where('month', $monthDate)\r\n            ->pluck('order_id')\r\n            ->toArray();\r\n\r\n        $allOrderIds = Order::pluck('id')->toArray();\r\n        $minusOrderIds = array_diff($allOrderIds, $addOrderIds);\r\n\r\n        // BULK: Employee ID'larni olish\r\n        $employeeQuery = Employee::select('id', 'name', 'position_id', 'group_id', 'salary', 'balance', 'payment_type', 'status', 'department_id');\r\n\r\n        if ($departmentId) {\r\n            $employeeQuery->where('department_id', $departmentId);\r\n        } elseif ($branchId) {\r\n            $employeeQuery->whereHas('department', function ($q) use ($branchId) {\r\n                $q->where('branch_id', $branchId);\r\n            });\r\n        }\r\n\r\n        if ($type === 'aup') {\r\n            $employeeQuery->where('type', 'aup');\r\n        } elseif ($type === 'simple') {\r\n            $employeeQuery->where('type', '!=', 'aup');\r\n        } else {\r\n            $employeeQuery->whereIn('type', ['aup', 'simple']);\r\n        }\r\n\r\n        if (!empty($groupId)) {\r\n            $employeeQuery->where('group_id', $groupId);\r\n        }\r\n\r\n        $employees = $employeeQuery->get();\r\n        $employeeIds = $employees->pluck('id')->toArray();\r\n\r\n        if (empty($employeeIds)) {\r\n            return response()->json([]);\r\n        }\r\n\r\n        // BULK: Barcha kerakli ma'lumotlarni bir marta olamiz\r\n\r\n        // 1. Attendance salaries - BULK\r\n        $attendanceData = DB::table('attendance_salary')\r\n            ->whereIn('employee_id', $employeeIds)\r\n            ->whereBetween('date', [$startDate, $endDate])\r\n            ->selectRaw('employee_id, SUM(amount) as total_amount, COUNT(*) as days_count')\r\n            ->groupBy('employee_id')\r\n            ->get()\r\n            ->keyBy('employee_id');\r\n\r\n        // 2. Tarification logs with all relations - BULK\r\n        $tarificationData = DB::table('employee_tarification_logs as etl')\r\n            ->join('tarifications as t', 'etl.tarification_id', '=', 't.id')\r\n            ->join('tarification_categories as tc', 't.tarification_category_id', '=', 'tc.id')\r\n            ->join('order_sub_models as sm', 'tc.submodel_id', '=', 'sm.id')\r\n            ->join('order_models as om', 'sm.order_model_id', '=', 'om.id')\r\n            ->join('orders as o', 'om.order_id', '=', 'o.id')\r\n            ->whereIn('etl.employee_id', $employeeIds)\r\n            ->whereNotIn('o.id', $minusOrderIds)\r\n            ->select('etl.employee_id', 'etl.amount_earned', 'o.id as order_id')\r\n            ->get()\r\n            ->groupBy('employee_id');\r\n\r\n        // 3. Salary payments - BULK\r\n        $paymentsData = DB::table('salary_payments')\r\n            ->whereIn('employee_id', $employeeIds)\r\n            ->whereBetween('month', [$startDate, $endDate])\r\n            ->select('employee_id', 'type', 'amount', 'date', 'comment', 'month')\r\n            ->get()\r\n            ->groupBy('employee_id');\r\n\r\n        // 4. Monthly Pieceworks - BULK\r\n        $monthlyPieceworksData = DB::table('employee_monthly_pieceworks as emp')\r\n            ->leftJoin('users as u', 'emp.created_by', '=', 'u.id')\r\n            ->leftJoin('employees as e', 'emp.employee_id', '=', 'e.id')\r\n            ->whereIn('emp.employee_id', $employeeIds)\r\n            ->where('emp.month', $monthDate)\r\n            ->select('emp.id', 'emp.employee_id', 'emp.amount', 'emp.comment', 'emp.status', 'e.name as created_by_name')\r\n            ->get()\r\n            ->keyBy('employee_id');\r\n\r\n        // 5. Monthly Salaries - BULK\r\n        $monthlySalariesData = DB::table('employee_monthly_salaries as ems')\r\n            ->leftJoin('users as u', 'ems.created_by', '=', 'u.id')\r\n            ->leftJoin('employees as e', 'ems.employee_id', '=', 'e.id')\r\n            ->whereIn('ems.employee_id', $employeeIds)\r\n            ->where('ems.month', $monthDate)\r\n            ->select( 'ems.id', 'ems.employee_id', 'ems.comment', 'ems.amount', 'ems.status', 'e.name as created_by_name')\r\n            ->get()\r\n            ->keyBy('employee_id');\r\n\r\n        // 6. Extra orders data if needed\r\n        $extraOrdersData = [];\r\n        if (!empty($addOrderIds)) {\r\n            $extraOrdersData = Order::whereIn('id', $addOrderIds)\r\n                ->pluck('id')\r\n                ->toArray();\r\n        }\r\n\r\n        // BULK: Positions va Groups - bir marta olamiz\r\n        $positions = DB::table('positions')\r\n            ->whereIn('id', $employees->pluck('position_id')->filter()->unique())\r\n            ->pluck('name', 'id');\r\n\r\n        $groups = DB::table('groups')\r\n            ->whereIn('id', $employees->pluck('group_id')->filter()->unique())\r\n            ->pluck('name', 'id');\r\n\r\n        // PROCESSING: Har bir employee uchun ma'lumotlarni process qilamiz\r\n        $processedEmployees = [];\r\n\r\n        foreach ($employees as $employee) {\r\n            // Attendance\r\n            $attendanceInfo = $attendanceData->get($employee->id);\r\n            $attendanceTotal = $attendanceInfo ? (float)$attendanceInfo->total_amount : 0;\r\n            $attendanceDays = $attendanceInfo ? (int)$attendanceInfo->days_count : 0;\r\n\r\n            // Tarification\r\n            $empTarificationLogs = $tarificationData->get($employee->id, collect());\r\n            $tarificationTotal = $empTarificationLogs->sum('amount_earned');\r\n            $orderIds = $empTarificationLogs->pluck('order_id')->unique()->merge($extraOrdersData)->unique()->values();\r\n\r\n            // Monthly Piecework\r\n            $monthlyPiecework = $monthlyPieceworksData->get($employee->id);\r\n            $monthlyPieceworkData = null;\r\n            if ($monthlyPiecework) {\r\n                $monthlyPieceworkData = [\r\n                    'id' => $monthlyPiecework->id,\r\n                    'amount' => (float) $monthlyPiecework->amount,\r\n                    'status' => (bool) $monthlyPiecework->status,\r\n                    'created_by' => $monthlyPiecework->created_by_name,\r\n                    'comment' => $monthlyPiecework->comment,\r\n                ];\r\n            }\r\n\r\n            // Monthly Salary\r\n            $monthlySalary = $monthlySalariesData->get($employee->id);\r\n            $monthlySalaryData = null;\r\n            if ($monthlySalary) {\r\n                $monthlySalaryData = [\r\n                    'id' => $monthlySalary->id,\r\n                    'amount' => (float) $monthlySalary->amount,\r\n                    'status' => (bool) $monthlySalary->status,\r\n                    'created_by' => $monthlySalary->created_by_name,\r\n                    'comment' => $monthlySalary->comment,\r\n                ];\r\n            }\r\n\r\n            $totalEarned = $tarificationTotal + $attendanceTotal;\r\n\r\n            // Agar xodim hech narsa topmagan bo'lsa, skip qilamiz\r\n            if ($totalEarned <= 0) {\r\n                continue;\r\n            }\r\n\r\n            // Payments\r\n            $empPayments = $paymentsData->get($employee->id, collect());\r\n            $paidAmountsByType = [];\r\n            $paidTotal = 0;\r\n\r\n            foreach ($empPayments->groupBy('type') as $ptype => $payments) {\r\n                $paidAmountsByType[$ptype] = $payments->map(function ($payment) use (&$paidTotal) {\r\n                    $paidTotal += (float) $payment->amount;\r\n                    return [\r\n                        'amount' => (float) $payment->amount,\r\n                        'date' => $payment->date,\r\n                        'comment' => $payment->comment,\r\n                        'month' => $payment->month ? Carbon::parse($payment->month)->format('Y-m') : null,\r\n                    ];\r\n                })->values()->toArray();\r\n            }\r\n\r\n            // Status check\r\n            if ($employee->status === 'kicked' && $totalEarned < 0) {\r\n                continue;\r\n            }\r\n\r\n            $processedEmployees[] = [\r\n                'id' => $employee->id,\r\n                'name' => $employee->name,\r\n                'position' => $positions->get($employee->position_id) ?? 'N/A',\r\n                'group' => $employee->group_id ? ($groups->get($employee->group_id) ?? 'N/A') : 'N/A',\r\n                'group_id' => $employee->group_id,\r\n                'balance' => (float) $employee->balance,\r\n                'payment_type' => $employee->payment_type,\r\n                'salary' => (float) $employee->salary,\r\n                'status' => $employee->status,\r\n                'attendance_salary' => $attendanceTotal,\r\n                'attendance_days' => $attendanceDays,\r\n                'tarification_salary' => $tarificationTotal,\r\n                'total_earned' => $totalEarned,\r\n                'paid_amounts' => $paidAmountsByType,\r\n                'total_paid' => round($paidTotal, 2),\r\n                'net_balance' => round($totalEarned - $paidTotal, 2),\r\n                'orders' => $orderIds->toArray(),\r\n                'monthly_piecework' => $monthlyPieceworkData,\r\n                'monthly_salary' => $monthlySalaryData,\r\n            ];\r\n        }\r\n\r\n        // GROUPING: Employee'larni group bo'yicha guruhlash\r\n        $groupedEmployees = collect($processedEmployees)->groupBy('group_id');\r\n\r\n        $result = [];\r\n\r\n        foreach ($groupedEmployees as $groupId => $groupEmployees) {\r\n            $groupName = $groupId ? ($groups->get($groupId) ?? 'N/A') : 'Guruhsiz';\r\n            $groupTotal = $groupEmployees->sum('total_earned');\r\n\r\n            // group_id ni employee ma'lumotlaridan olib tashlaymiz\r\n            $cleanEmployees = $groupEmployees->map(function ($emp) {\r\n                unset($emp['group_id']);\r\n                return $emp;\r\n            })->values()->toArray();\r\n\r\n            $result[] = [\r\n                'id' => $groupId,\r\n                'name' => $groupName,\r\n                'total_balance' => $groupTotal,\r\n                'employees' => $cleanEmployees,\r\n            ];\r\n        }\r\n\r\n        return response()->json(array_values($result));\r\n    }\r\n    //2-usul excel\r\n\r\n    public function exportGroupsOrdersEarnings(Request $request)\r\n    {\r\n        $data = $this->getGroupsOrdersEarnings($request)->getData(true);\r\n\r\n        $department = DB::table('departments')\r\n            ->select('name')\r\n            ->where('id', $request->input('department_id'))\r\n            ->first();\r\n        $group = DB::table('groups')\r\n            ->select('name')\r\n            ->where('id', $request->input('group_id'))\r\n            ->first();\r\n        $month = $request->input('month', date('Y-m'));\r\n\r\n        $departmentName = $department->name ?? '';\r\n        $groupName = $group->name ?? '';\r\n\r\n        $fileName = 'groups_orders_earnings_' . now()->format('Y-m-d_H-i-s') . '.xlsx';\r\n\r\n        return Excel::download(\r\n            new GroupsOrdersEarningsExport($data, $departmentName, $groupName, $month),\r\n            $fileName\r\n        );\r\n    }\r\n\r\n    /**\r\n     * $employee — Employee eloquent modeli (salaryPayments eager-load qilingan bo‘lishi mumkin)\r\n     * $startDate, $endDate — 'Y-m-d' formatdagi string (yoki null)\r\n     */\r\n    \r\n    public function getEmployeeEarnings($employee, $startDate, $endDate, $orderIds = [])\r\n    {\r\n        if ($employee->status === 'kicked' && ((float) $employee->balance) === 0.0) {\r\n            return null;\r\n        }\r\n\r\n        $employee->loadMissing(['position', 'branch', 'group']);\r\n\r\n        // AttendanceSalary (oylikchilar uchun)\r\n        $attendanceQuery = $employee->attendanceSalaries();\r\n        if ($startDate && $endDate) {\r\n            $attendanceQuery->whereBetween('date', [$startDate, $endDate]);\r\n        }\r\n        $attendanceTotal = $attendanceQuery->sum('amount');\r\n        $attendanceDays = $attendanceQuery->count();\r\n\r\n        // EmployeeSalary\r\n        $employeeSalaryQuery = $employee->employeeSalaries();\r\n        if ($startDate && $endDate) {\r\n            $start = \\Carbon\\Carbon::parse($startDate);\r\n            $end = \\Carbon\\Carbon::parse($endDate);\r\n\r\n            $employeeSalaryQuery->where(function ($q) use ($start, $end) {\r\n                $q->whereBetween('year', [$start->year, $end->year])\r\n                    ->where(function ($q) use ($start, $end) {\r\n                        $q->where(function ($q) use ($start) {\r\n                            $q->where('year', $start->year)\r\n                                ->where('month', '>=', $start->month);\r\n                        })\r\n                            ->orWhere(function ($q) use ($end) {\r\n                                $q->where('year', $end->year)\r\n                                    ->where('month', '<=', $end->month);\r\n                            })\r\n                            ->orWhere(function ($q) use ($start, $end) {\r\n                                $q->whereBetween('year', [$start->year + 1, $end->year - 1]);\r\n                            });\r\n                    });\r\n            });\r\n        }\r\n        $employeeSalaryTotal = $employeeSalaryQuery->sum('amount');\r\n\r\n        // TarificationLogs (piece_work uchun)\r\n        $tarificationQuery = $employee->employeeTarificationLogs();\r\n\r\n        if (!empty($orderIds)) {\r\n            $tarificationIds = \\App\\Models\\Order::whereIn('id', $orderIds)\r\n                ->with('orderModel.submodels.tarificationCategories.tarifications:id,tarification_category_id')\r\n                ->get()\r\n                ->flatMap(function ($order) {\r\n                    return optional($order->orderModel)->submodels?->flatMap(function ($submodel) {\r\n                        return optional($submodel->tarificationCategories)->flatMap(function ($category) {\r\n                            return optional($category->tarifications)->pluck('id');\r\n                        }) ?? collect();\r\n                    }) ?? collect();\r\n                })\r\n                ->unique()\r\n                ->values();\r\n\r\n            if ($tarificationIds->isNotEmpty()) {\r\n                $tarificationQuery->whereIn('tarification_id', $tarificationIds);\r\n            } else {\r\n                return null;\r\n            }\r\n        } elseif ($startDate && $endDate) {\r\n            $tarificationQuery->whereBetween('date', [$startDate, $endDate]);\r\n        }\r\n\r\n        $tarificationTotal = $tarificationQuery->sum('amount_earned');\r\n\r\n        // Umumiy hisob\r\n        if ($employee->payment_type === 'piece_work') {\r\n            $totalEarned = $employeeSalaryTotal + $tarificationTotal;\r\n        } else {\r\n            $totalEarned = $attendanceTotal + $employeeSalaryTotal;\r\n        }\r\n\r\n        // To'lovlar\r\n        $paidQuery = $employee->salaryPayments();\r\n        if ($startDate && $endDate) {\r\n            $paidQuery->whereBetween('month', [$startDate, $endDate]);\r\n        }\r\n        $paymentsGrouped = $paidQuery->get()->groupBy('type');\r\n\r\n        $paidAmountsByType = [];\r\n        $paidTotal = 0;\r\n\r\n        foreach ($paymentsGrouped as $type => $payments) {\r\n            $paidAmountsByType[$type] = $payments->map(function ($payment) use (&$paidTotal) {\r\n                $paidTotal += (float) $payment->amount;\r\n                return [\r\n                    'amount' => (float) $payment->amount,\r\n                    'date' => $payment->date,\r\n                    'comment' => $payment->comment,\r\n                    'month' => $payment->month->format('Y-m'),\r\n                ];\r\n            })->values();\r\n        }\r\n\r\n        if ($totalEarned === 0){\r\n            return null;\r\n        }\r\n\r\n        return [\r\n            'id' => $employee->id,\r\n            'name' => $employee->name,\r\n            'position' => $employee->position->name ?? 'N/A',\r\n            'group' => optional($employee->group)->name ?? 'N/A',\r\n            'balance' => (float) $employee->balance,\r\n            'payment_type' => $employee->payment_type,\r\n            'salary' => (float) $employee->salary,\r\n\r\n            'attendance_salary' => $attendanceTotal,\r\n            'attendance_days' => $attendanceDays,\r\n            'employee_salary' => $employeeSalaryTotal,\r\n            'tarification_salary' => $tarificationTotal,\r\n            'total_earned' => $totalEarned,\r\n\r\n            'paid_amounts' => $paidAmountsByType,\r\n            'total_paid' => round($paidTotal, 2),\r\n            'net_balance' => round($totalEarned - $paidTotal, 2),\r\n        ];\r\n    }\r\n\r\n    public function getSource(): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $sources = \\App\\Models\\IncomeSource::all();\r\n        return response()->json($sources);\r\n    }\r\n\r\n    public function getVia(): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $via = \\App\\Models\\IncomeVia::all();\r\n        return response()->json($via);\r\n    }\r\n\r\n    public function getDestination(): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $destinations = \\App\\Models\\IncomeDestination::all();\r\n        return response()->json($destinations);\r\n    }\r\n\r\n    public function storeIncome(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $data = $request->validate([\r\n            'currency_id' => 'required|exists:currencies,id',\r\n            'amount' => 'required|numeric|min:0.01',\r\n            'source' => 'nullable|string|max:255',\r\n        //            'via_id' => 'required|exists:employees,id',\r\n            'comment' => 'nullable|string|max:1000',\r\n            'date' => 'nullable|date',\r\n            'purpose' => 'nullable|string|max:1000',\r\n        ]);\r\n\r\n        try {\r\n            $data['type'] = 'income';\r\n            $data['date'] = $data['date'] ?? now()->toDateString();\r\n            $data['branch_id'] = auth()->user()->employee->branch_id;\r\n\r\n            $data['via_id'] = auth()->user()->employee->id;\r\n\r\n            DB::transaction(function () use (&$data) {\r\n                // ✅ 1. Branch bo‘yicha bitta Cashbox topamiz yoki yaratamiz\r\n                $cashbox = \\App\\Models\\Cashbox::firstOrCreate(\r\n                    ['branch_id' => $data['branch_id']],\r\n                    ['name' => 'Avto Cashbox: ' . now()->format('Y-m-d H:i:s')]\r\n                );\r\n\r\n                $data['cashbox_id'] = $cashbox->id;\r\n\r\n                // ✅ 2. Transaction yozamiz\r\n                \\App\\Models\\CashboxTransaction::create($data);\r\n\r\n                // ✅ 3. Cashbox balanceni yangilaymiz (currency_id bo‘yicha)\r\n                $balance = \\App\\Models\\CashboxBalance::firstOrCreate(\r\n                    [\r\n                        'cashbox_id' => $cashbox->id,\r\n                        'currency_id' => $data['currency_id'],\r\n                    ],\r\n                    ['amount' => 0]\r\n                );\r\n\r\n                $balance->increment('amount', $data['amount']);\r\n\r\n                // ✅ 4. Telegramga xabar yuborish (faqat transaction commit bo‘lgandan so‘ng)\r\n                DB::afterCommit(function () use ($data, $balance) {\r\n                    $currency = \\App\\Models\\Currency::find($data['currency_id']);\r\n                    $branch = \\App\\Models\\Branch::find($data['branch_id']);\r\n                    $user = auth()->user()->employee;\r\n\r\n                    $remainingBalance = number_format($balance->amount, 0, '.', ' ');\r\n\r\n                    $text = \"\uD83D\uDCB0 *Kirim qo‘shildi!*\\n\"\r\n                        . \"\uD83C\uDFE2 Filial: {$branch->name}\\n\"\r\n                        . \"\uD83D\uDC64 Xodim: {$user->name}\\n\"\r\n                        . \"\uD83D\uDCB5 Miqdor: \" . number_format($data['amount'], 0, '.', ' ') . \" {$currency->name}\\n\"\r\n                        . \"\uD83D\uDCC5 Sana: {$data['date']}\\n\"\r\n                        . \"\uD83C\uDFE6 Qolgan balans: *{$remainingBalance} {$currency->name}*\\n\"\r\n                        . \"\uD83D\uDCD8 Maqsad: \" . ($data['purpose'] ?? 'Noma’lum') . \"\\n\"\r\n                        . \"\uD83D\uDCAC Izoh: \" . ($data['comment'] ?? '-');\r\n\r\n                    $botToken = \"7778276162:AAHVKgbh5mJlgp7jMhw_VNunvvR3qoDyjms\";\r\n                    $chatId = -979504247;\r\n\r\n                    Http::post(\"https://api.telegram.org/bot{$botToken}/sendMessage\", [\r\n                        'chat_id' => $chatId,\r\n                        'text' => $text,\r\n                        'parse_mode' => 'Markdown',\r\n                    ]);\r\n                });\r\n            });\r\n\r\n        } catch (\\Exception $e) {\r\n            return response()->json([\r\n                'message' => '❌ Kirim muvaffaqiyatsiz.' . $e->getMessage(),\r\n            ], 500);\r\n        }\r\n\r\n        return response()->json(['message' => '✅ Kirim muvaffaqiyatli qo‘shildi.']);\r\n    }\r\n\r\n    public function storeExpense(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $data = $request->validate([\r\n            'currency_id' => 'required|exists:currencies,id',\r\n            'amount' => 'required|numeric|min:0.01',\r\n            //            'destination_id' => 'nullable|exists:employees,id',\r\n            //            'via_id' => 'required|exists:employees,id',\r\n            'purpose' => 'nullable|string|max:1000',\r\n            'comment' => 'nullable|string|max:1000',\r\n            'date' => 'nullable|date',\r\n        ]);\r\n\r\n        $data['type'] = 'expense';\r\n        $data['date'] = $data['date'] ?? now()->toDateString();\r\n        $data['branch_id'] = auth()->user()->employee->branch_id;\r\n\r\n        try {\r\n            DB::transaction(function () use (&$data) {\r\n                // ✅ Branch bo‘yicha bitta Cashbox topamiz yoki yaratamiz\r\n                $cashbox = \\App\\Models\\Cashbox::firstOrCreate(\r\n                    ['branch_id' => $data['branch_id']],\r\n                    ['name' => 'Avto Cashbox: ' . now()->format('Y-m-d H:i:s')]\r\n                );\r\n\r\n                $data['cashbox_id'] = $cashbox->id;\r\n\r\n                $data['via_id'] = auth()->user()->employee->id;\r\n\r\n                // ✅ Balansni tekshiramiz\r\n                $balance = \\App\\Models\\CashboxBalance::firstOrCreate(\r\n                    [\r\n                        'cashbox_id' => $cashbox->id,\r\n                        'currency_id' => $data['currency_id'],\r\n                    ],\r\n                    ['amount' => 0]\r\n                );\r\n\r\n                if ($balance->amount < $data['amount']) {\r\n                    throw new \\Exception('❌ Kassada yetarli mablag‘ mavjud emas.');\r\n                }\r\n\r\n                // ✅ Transaction yozamiz\r\n                \\App\\Models\\CashboxTransaction::create($data);\r\n\r\n                // ✅ Balansni kamaytiramiz\r\n                $balance->decrement('amount', $data['amount']);\r\n\r\n                DB::afterCommit(function () use ($data, $balance) {\r\n                    $currency = \\App\\Models\\Currency::find($data['currency_id']);\r\n                    $branch = \\App\\Models\\Branch::find($data['branch_id']);\r\n                    $user = auth()->user()->employee;\r\n\r\n                    $remainingBalance = number_format($balance->amount, 0, '.', ' ');\r\n\r\n                    $text = \"\uD83D\uDCE4 *Chiqim amalga oshirildi!*\\n\"\r\n                        . \"\uD83C\uDFE2 Filial: {$branch->name}\\n\"\r\n                        . \"\uD83D\uDC64 Xodim: {$user->name}\\n\"\r\n                        . \"\uD83D\uDCB8 Miqdor: \" . number_format($data['amount'], 0, '.', ' ') . \" {$currency->name}\\n\"\r\n                        . \"\uD83D\uDCC5 Sana: {$data['date']}\\n\"\r\n                        . \"\uD83C\uDFE6 Qolgan balans: *{$remainingBalance} {$currency->name}*\\n\"\r\n                        . \"\uD83D\uDCD8 Maqsad: \" . ($data['purpose'] ?? 'Noma’lum') . \"\\n\"\r\n                        . \"\uD83D\uDCAC Izoh: \" . ($data['comment'] ?? '-');\r\n\r\n                    $botToken = \"7778276162:AAHVKgbh5mJlgp7jMhw_VNunvvR3qoDyjms\";\r\n                    $chatId = -979504247;\r\n\r\n                    Http::post(\"https://api.telegram.org/bot{$botToken}/sendMessage\", [\r\n                        'chat_id' => $chatId,\r\n                        'text' => $text,\r\n                        'parse_mode' => 'Markdown',\r\n                    ]);\r\n                });\r\n            });\r\n\r\n        } catch (\\Exception $e) {\r\n            return response()->json([\r\n                'message' => '❌ Chiqim muvaffaqiyatsiz.' . $e->getMessage(),\r\n            ], 500);\r\n        }\r\n\r\n        return response()->json(['message' => '✅ Chiqim muvaffaqiyatli yozildi.']);\r\n    }\r\n\r\n    public function getBalances(): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $cashboxes = Cashbox::with(['balances.currency'])\r\n            ->where('branch_id', auth()->user()->employee->branch_id)\r\n            ->get();\r\n\r\n        return response()->json([\r\n            'cashboxes' => $cashboxes->map(function ($cashbox) {\r\n                return [\r\n                    'id' => $cashbox->id,\r\n                    'name' => $cashbox->name,\r\n                    'balance' => $cashbox->balances->map(function ($balance) {\r\n                        return [\r\n                            'currency' => $balance->currency->name,\r\n                            'amount' => number_format($balance->amount, 2, '.', ' '),\r\n                        ];\r\n                    })\r\n                ];\r\n            })\r\n        ]);\r\n    }\r\n\r\n    public function getTransactions(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $query = CashboxTransaction::with('currency', 'cashbox')\r\n            ->where('branch_id', auth()->user()->employee->branch_id);\r\n\r\n        if ($request->filled('cashbox_id')) {\r\n            $query->where('cashbox_id', $request->cashbox_id);\r\n        }\r\n\r\n        if ($request->filled('type')) {\r\n            $query->where('type', $request->type);\r\n        }\r\n\r\n        if ($request->filled('currency_id')) {\r\n            $query->where('currency_id', $request->currency_id);\r\n        }\r\n\r\n        if ($request->filled('date')) {\r\n            $query->whereDate('date', $request->date);\r\n        }\r\n\r\n        if ($request->filled('start_date') && $request->filled('end_date')) {\r\n            $query->whereBetween('date', [$request->start_date, $request->end_date]);\r\n        }\r\n\r\n        if ($request->filled('search')) {\r\n            $search = mb_strtolower($request->search); // PHP tomonda lowercase qilish\r\n            $query->where(function ($q) use ($search) {\r\n                $q->orWhereHas('via', function ($q3) use ($search) {\r\n                        $q3->whereRaw('LOWER(name) LIKE ?', [\"%{$search}%\"]);\r\n                    })\r\n                    ->orWhereHas('destination', function ($q4) use ($search) {\r\n                        $q4->whereRaw('LOWER(name) LIKE ?', [\"%{$search}%\"]);\r\n                    })\r\n                    ->orWhereRaw('LOWER(purpose) LIKE ?', [\"%{$search}%\"])\r\n                    ->orWhereRaw('LOWER(source) LIKE ?', [\"%{$search}%\"])\r\n                    ->orWhereRaw('LOWER(comment) LIKE ?', [\"%{$search}%\"]);\r\n            });\r\n        }\r\n\r\n        $transactions = $query->orderBy('date', 'desc')->get();\r\n\r\n        return response()->json([\r\n            'transactions' => $transactions->map(function ($tx) {\r\n                return [\r\n                    'cashbox' => $tx->cashbox,\r\n                    'type' => $tx->type,\r\n                    'amount' => $tx->amount,\r\n                    'currency' => $tx->currency,\r\n                    'date' => $tx->date,\r\n                    'source' => $tx->source,\r\n                    'destination' => $tx->destination,\r\n                    'via' => $tx->via,\r\n                    'purpose' => $tx->purpose,\r\n                    'comment' => $tx->comment,\r\n                    'created_at' => $tx->created_at->format('Y-m-d H:i:s'),\r\n                ];\r\n            })\r\n        ]);\r\n    }\r\n\r\n    public function exportTransactions1(Request $request)\r\n    {\r\n        $fileName = 'transactions_' . now()->format('Y-m-d_His') . '.xlsx';\r\n        return Excel::download(new TransactionsExport($request), $fileName);\r\n    }\r\n\r\n    public function transferBetweenCashboxes(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        try {\r\n            $data = $request->validate([\r\n                'from_currency_id' => 'required|exists:currencies,id',\r\n                'to_currency_id' => 'required|exists:currencies,id|different:from_currency_id',\r\n                'from_amount' => 'required|numeric|min:0.01',\r\n                'to_amount' => 'required|numeric|min:0.01',\r\n                'exchange_rate' => 'required|numeric|min:0.0000001',\r\n                'date' => 'nullable|date',\r\n                'comment' => 'nullable|string|max:1000',\r\n            ]);\r\n\r\n            $data['date'] = $data['date'] ?? now()->toDateString();\r\n\r\n            $branchId = auth()->user()->employee->branch_id;\r\n\r\n            // Har ikkala kassani bir xil filialdan olish\r\n            $cashbox = Cashbox::where('branch_id', $branchId)->firstOrFail();\r\n\r\n            // Balansni tekshirish\r\n            $fromBalance = CashboxBalance::where('cashbox_id', $cashbox->id)\r\n                ->where('currency_id', $data['from_currency_id'])\r\n                ->value('amount');\r\n\r\n            if ($fromBalance === null || $fromBalance < $data['from_amount']) {\r\n                return response()->json([\r\n                    'message' => '❌ Kassada yetarli mablag‘ mavjud emas.'\r\n                ], 422);\r\n            }\r\n\r\n            DB::transaction(function () use ($data, $cashbox) {\r\n                // Chiqim\r\n                CashboxTransaction::create([\r\n                    'cashbox_id' => $cashbox->id,\r\n                    'type' => 'expense',\r\n                    'currency_id' => $data['from_currency_id'],\r\n                    'amount' => $data['from_amount'],\r\n                    'target_cashbox_id' => $cashbox->id,\r\n                    'exchange_rate' => $data['exchange_rate'],\r\n                    'target_amount' => $data['to_amount'],\r\n                    'date' => $data['date'],\r\n                    'comment' => '\uD83D\uDD01 Valyuta ayirboshlash',\r\n                    'branch_id' => $cashbox->branch_id,\r\n                    'via_id' => auth()->user()->employee->id, // Hozirgi foydalanuvchi\r\n                    'purpose' => $data['comment'] ?? null,\r\n                ]);\r\n\r\n                // Kirim\r\n                CashboxTransaction::create([\r\n                    'cashbox_id' => $cashbox->id,\r\n                    'type' => 'income',\r\n                    'currency_id' => $data['to_currency_id'],\r\n                    'amount' => $data['to_amount'],\r\n                    'target_cashbox_id' => $cashbox->id,\r\n                    'exchange_rate' => $data['exchange_rate'],\r\n                    'target_amount' => $data['from_amount'],\r\n                    'date' => $data['date'],\r\n                    'comment' => '\uD83D\uDD01 Valyuta ayirboshlash',\r\n                    'branch_id' => $cashbox->branch_id,\r\n                    'via_id' => auth()->user()->employee->id, // Hozirgi foydalanuvchi\r\n                    'purpose' => $data['comment'] ?? null,\r\n                ]);\r\n\r\n                // From balans kamayadi\r\n                CashboxBalance::where('cashbox_id', $cashbox->id)\r\n                    ->where('currency_id', $data['from_currency_id'])\r\n                    ->decrement('amount', $data['from_amount']);\r\n\r\n                // To balans oshadi\r\n                CashboxBalance::updateOrCreate(\r\n                    [\r\n                        'cashbox_id' => $cashbox->id,\r\n                        'currency_id' => $data['to_currency_id'],\r\n                    ],\r\n                    [\r\n                        'amount' => DB::raw(\"amount + {$data['to_amount']}\")\r\n                    ]\r\n                );\r\n            });\r\n\r\n            return response()->json([\r\n                'message' => \"✅ Pul muvaffaqiyatli ayirboshlanib saqlandi:\\n{$data['from_amount']} → {$data['to_amount']}\"\r\n            ]);\r\n        } catch (\\Throwable $e) {\r\n            return response()->json([\r\n                'message' => '❌ Xatolik yuz berdi.',\r\n                'error' => $e->getMessage()\r\n            ], 500);\r\n        }\r\n    }\r\n\r\n    public function storeRequestForm(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $validated = $request->validate([\r\n            'employee_id' => 'required|exists:employees,id',\r\n            'currency_id' => 'required|exists:currencies,id',\r\n            'amount' => 'required|numeric|min:0.01',\r\n            'purpose' => 'nullable|string|max:1000',\r\n            'comment' => 'nullable|string|max:1000',\r\n            'deadline' => 'required|date|after_or_equal:today',\r\n        ]);\r\n\r\n        try {\r\n            $requestForm = \\App\\Models\\RequestForm::create([\r\n                'employee_id' => $validated['employee_id'],\r\n                'currency_id' => $validated['currency_id'],\r\n                'amount' => $validated['amount'],\r\n                'purpose' => $validated['purpose'] ?? null,\r\n                'comment' => $validated['comment'] ?? null,\r\n                'status' => 'pending',\r\n                'created_by' => auth()->id(),\r\n                'branch_id' => auth()->user()->employee->branch_id,\r\n                'deadline' => $validated['deadline'],\r\n            ]);\r\n\r\n            return response()->json([\r\n                'message' => '✅ Talabnoma muvaffaqiyatli yaratildi.',\r\n                'request_id' => $requestForm->id\r\n            ], 201);\r\n        } catch (\\Throwable $e) {\r\n            return response()->json([\r\n                'message' => '❌ Talabnoma yaratishda xatolik yuz berdi.',\r\n                'error' => $e->getMessage(),\r\n            ], 500);\r\n        }\r\n    }\r\n\r\n    public function getRequestForm(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $query = \\App\\Models\\RequestForm::with('employee', 'currency', 'creator', 'approver')\r\n            ->where('branch_id', auth()->user()->employee->branch_id);\r\n\r\n        // \uD83D\uDD0D Search\r\n        if ($request->filled('search')) {\r\n            $search = mb_strtolower($request->search);\r\n            $query->where(function ($q) use ($search) {\r\n                $q->whereHas('employee', fn($q2) => $q2->whereRaw('LOWER(name) LIKE ?', [\"%{$search}%\"]))\r\n                    ->orWhereRaw('LOWER(purpose) LIKE ?', [\"%{$search}%\"])\r\n                    ->orWhereRaw('LOWER(comment) LIKE ?', [\"%{$search}%\"]);\r\n            });\r\n        }\r\n\r\n        // \uD83D\uDCC5 Deadline sanasi bo‘yicha filter\r\n        if ($request->filled('start_date') && $request->filled('end_date')) {\r\n            $query->whereBetween('deadline', [$request->start_date, $request->end_date]);\r\n        } elseif ($request->filled('start_date')) {\r\n            $query->whereDate('deadline', '>=', $request->start_date);\r\n        } elseif ($request->filled('end_date')) {\r\n            $query->whereDate('deadline', '<=', $request->end_date);\r\n        }\r\n\r\n        // \uD83D\uDCCB Status bo‘yicha filter\r\n        if ($request->filled('status')) {\r\n            $query->where('status', $request->status);\r\n        }\r\n\r\n        $requestForms = $query->orderBy('deadline', 'desc')->paginate(10);\r\n\r\n        return response()->json([\r\n            'data' => $requestForms->getCollection()->transform(function ($form) {\r\n                return [\r\n                    'id' => $form->id,\r\n                    'employee' => $form->employee->name,\r\n                    'currency' => $form->currency->name,\r\n                    'amount' => number_format($form->amount, 2, '.', ' '),\r\n                    'purpose' => $form->purpose,\r\n                    'comment' => $form->comment,\r\n                    'status' => $form->status,\r\n                    'created_at' => $form->created_at->format('Y-m-d H:i:s'),\r\n                    'created_by' => $form->creator->employee->name ?? 'N/A',\r\n                    'approved_by' => $form->approver->employee->name ?? 'N/A',\r\n                    'approved_at' => $form->approved_at ? $form->approved_at->format('Y-m-d H:i:s') : null,\r\n                    'deadline' => $form->deadline,\r\n                ];\r\n            }),\r\n            'current_page' => $requestForms->currentPage(),\r\n            'last_page' => $requestForms->lastPage(),\r\n            'per_page' => $requestForms->perPage(),\r\n            'total' => $requestForms->total(),\r\n            'from' => $requestForms->firstItem(),\r\n            'to' => $requestForms->lastItem(),\r\n        ]);\r\n    }\r\n\r\n    public function storeGroupPlan(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $validated = $request->validate([\r\n            'group_id' => 'required|exists:groups,id',\r\n            'month' => 'required|integer|min:1|max:12',\r\n            'year' => 'required|integer|min:2000|max:2100',\r\n            'quantity' => 'required|integer|min:0',\r\n        ]);\r\n\r\n        $groupPlan = \\App\\Models\\GroupPlan::updateOrCreate(\r\n            [\r\n                'group_id' => $validated['group_id'],\r\n                'month' => $validated['month'],\r\n                'year' => $validated['year'],\r\n            ],\r\n            ['quantity' => $validated['quantity']]\r\n        );\r\n\r\n        return response()->json([\r\n            'message' => '✅ Guruh rejasi muvaffaqiyatli saqlandi.',\r\n            'data' => $groupPlan,\r\n        ]);\r\n    }\r\n\r\n    public function getGroupPlans(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $query = \\App\\Models\\GroupPlan::whereHas('group.department.mainDepartment', function ($q) {\r\n            $q->where('branch_id', auth()->user()->employee->branch_id);\r\n        });\r\n\r\n        $query->whereHas('group.orders.order', function ($q){\r\n            $q->whereIn('status', ['tailored', 'tailoring']);\r\n        });\r\n\r\n        if ($request->filled('group_id')) {\r\n            $query->where('group_id', $request->group_id);\r\n        }\r\n\r\n        if ($request->filled('month') && $request->filled('year')) {\r\n            $query->where('month', $request->month)\r\n                ->where('year', $request->year)\r\n                ->with('group.orders.order.orderModel.submodels.sewingOutPuts', function ($q) use ($request) {\r\n                    $q->whereBetween('created_at', [\r\n                        Carbon::create($request->year, $request->month, 1)->startOfMonth(),\r\n                        Carbon::create($request->year, $request->month, 1)->endOfMonth()\r\n                    ]);\r\n                });\r\n        }\r\n\r\n        $query->with('group.orders.order.orderModel.submodels');\r\n\r\n        $plans = $query->get();\r\n\r\n        return response()->json(GroupPlanResource::collection($plans));\r\n    }\r\n\r\n    public function editGroupPlan(Request $request, $id): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $groupPlan = \\App\\Models\\GroupPlan::findOrFail($id);\r\n\r\n        $validated = $request->validate([\r\n            'group_id' => 'sometimes|exists:groups,id',\r\n            'month' => 'sometimes|integer|min:1|max:12',\r\n            'year' => 'sometimes|integer|min:2000|max:2100',\r\n            'quantity' => 'sometimes|integer|min:0',\r\n        ]);\r\n\r\n        $groupPlan->update($validated);\r\n\r\n        return response()->json([\r\n            'message' => '✅ Guruh rejasi muvaffaqiyatli yangilandi.',\r\n            'data' => $groupPlan,\r\n        ]);\r\n    }\r\n\r\n    public function exportGroupsByDepartmentId(Request $request)\r\n    {\r\n        $departmentId = $request->input('department_id');\r\n        $startDate = $request->input('start_date');\r\n        $endDate = $request->input('end_date');\r\n        $group_id = $request->input('group_id');\r\n        $orderIds = $request->input('order_ids', []);\r\n\r\n        if (!$departmentId) {\r\n            return response()->json(['message' => '❌ department_id kiritilmadi.'], 422);\r\n        }\r\n\r\n        return Excel::download(\r\n            new DepartmentGroupsExport($departmentId, $startDate, $endDate, $group_id, $orderIds),\r\n            'department_groups.xlsx'\r\n        );\r\n    }\r\n\r\n    public function getLatestPurposes(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $purposes = CashboxTransaction::where('type', $request->type)\r\n            ->where('branch_id', auth()->user()->employee->branch_id)\r\n            ->whereNotNull('purpose')\r\n            ->orderByDesc('created_at')\r\n            ->pluck('purpose')\r\n            ->unique()\r\n            ->take(1000)\r\n            ->values();\r\n\r\n        return response()->json($purposes);\r\n    }\r\n\r\n    public function getLatestComments(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $comments = CashboxTransaction::where('type', $request->type)\r\n            ->where('branch_id', auth()->user()->employee->branch_id)\r\n            ->whereNotNull('comment')\r\n            ->orderByDesc('created_at')\r\n            ->pluck('comment')\r\n            ->unique()\r\n            ->take(1000)\r\n            ->values();\r\n\r\n        return response()->json($comments);\r\n    }\r\n\r\n    public function getLatestSources(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $sources = CashboxTransaction::where('type', 'income')\r\n            ->where('branch_id', auth()->user()->employee->branch_id)\r\n            ->whereNotNull('source')\r\n            ->orderByDesc('created_at')\r\n            ->pluck('source')\r\n            ->unique()\r\n            ->take(1000)\r\n            ->values();\r\n\r\n        return response()->json($sources);\r\n    }\r\n\r\n    public function exportTransactions(Request $request)\r\n    {\r\n        $request->validate([\r\n            'start_date' => 'required|date',\r\n            'end_date'   => 'required|date',\r\n            'type'       => 'nullable|string',\r\n        ]);\r\n\r\n        return Excel::download(new CashboxTransactionsExport(\r\n            auth()->user()->employee->branch_id,\r\n            $request->start_date,\r\n            $request->end_date,\r\n            $request->type\r\n        ), 'cashbox_transactions.xlsx');\r\n    }\r\n\r\n    public function recalculateDailyPayments(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $data = $request->validate([\r\n            'year' => 'required|integer',\r\n            'month' => 'required|integer|min:1|max:12',\r\n        ]);\r\n\r\n        ini_set('memory_limit', '3G');\r\n        set_time_limit(0);\r\n\r\n        DB::beginTransaction();\r\n        try {\r\n            $year = $data['year'];\r\n            $month = $data['month'];\r\n            $branchId = auth()->user()->employee->branch_id;\r\n\r\n            $startDate = Carbon::create($year, $month, 1)->startOfMonth();\r\n            $endDate = Carbon::create($year, $month, 1)->endOfMonth();\r\n\r\n            $log = [\r\n                'processed_cuts' => 0,\r\n                'processed_sewings' => 0,\r\n                'updated_payments' => 0,\r\n                'created_payments' => 0,\r\n                'skipped_no_attendance' => 0,\r\n                'errors' => []\r\n            ];\r\n\r\n            // ============================================\r\n            // 1\uFE0F⃣ CUTTING natijalarini qayta hisoblash\r\n            // ============================================\r\n            $orderCuts = OrderCut::whereBetween('created_at', [$startDate, $endDate])\r\n                ->whereHas('order', function($q) use ($branchId) {\r\n                    $q->where('branch_id', $branchId);\r\n                })\r\n                ->with(['order.orderModel.model'])\r\n                ->get();\r\n\r\n            foreach ($orderCuts as $cut) {\r\n                try {\r\n                    $order = $cut->order;\r\n                    $cutDate = Carbon::parse($cut->created_at)->toDateString();\r\n                    $cutTime = Carbon::parse($cut->created_at);\r\n\r\n                    // \uD83D\uDCCC Ombor va Kroy bo'limlari uchun hisoblash\r\n                    $cuttingDepartments = [\r\n                        \"Markaziy ombor\",\r\n                        \"Kroy bo'limi\"\r\n                    ];\r\n\r\n                    foreach ($cuttingDepartments as $deptName) {\r\n                        $department = Department::where('name', $deptName)\r\n                            ->whereHas('mainDepartment', function($q) use($branchId) {\r\n                                $q->where('branch_id', $branchId);\r\n                            })->first();\r\n\r\n                        if (!$department) continue;\r\n\r\n                        $departmentBudget = DB::table('department_budgets')\r\n                            ->where('department_id', $department->id)\r\n                            ->first();\r\n\r\n                        if (!$departmentBudget || $departmentBudget->type !== 'minute_based') continue;\r\n\r\n                        $modelMinute = $order->orderModel->model->minute ?? 0;\r\n                        if ($modelMinute <= 0) continue;\r\n\r\n                        $totalMinutes = $modelMinute * $cut->quantity;\r\n                        $totalEarned = $departmentBudget->quantity * $totalMinutes;\r\n\r\n                        // ✅ Faqat o'sha kun davomatda bo'lgan va cut vaqtidan OLDIN kelgan xodimlar\r\n                        $employees = Employee::where('department_id', $department->id)\r\n                            ->where('status', 'working')\r\n                            ->whereHas('attendances', function ($q) use ($cutDate, $cutTime) {\r\n                                $q->whereDate('date', $cutDate)\r\n                                    ->where('status', 'present')\r\n                                    ->where(function($q2) use ($cutTime) {\r\n                                        // Agar arrival_time NULL bo'lsa yoki cut vaqtidan oldin bo'lsa\r\n                                        $q2->whereNull('check_in')\r\n                                            ->orWhereTime('check_in', '<=', $cutTime->format('H:i:s'));\r\n                                    });\r\n                            })\r\n                            ->get();\r\n\r\n                        foreach ($employees as $emp) {\r\n                            // ✅ Percentage olish: avval daily_payment'dan, yo'q bo'lsa employee'dan\r\n                            $existingPayment = DB::table('daily_payments')\r\n                                ->where('employee_id', $emp->id)\r\n                                ->where('order_id', $order->id)\r\n                                ->where('model_id', $order->orderModel->model->id)\r\n                                ->whereDate('payment_date', $cutDate)\r\n                                ->first();\r\n\r\n                            $percentage = $existingPayment\r\n                                ? $existingPayment->employee_percentage\r\n                                : ($emp->percentage ?? 0);\r\n\r\n                            if ($percentage == 0) continue;\r\n\r\n                            $earned = round(($totalEarned * $percentage) / 100, 2);\r\n                            if ($earned == 0) continue;\r\n\r\n                            if ($existingPayment) {\r\n                                // ✅ Agar mavjud bo'lsa va to'g'ri bo'lsa, tekshirish\r\n                                $expectedAmount = round(($totalMinutes * $departmentBudget->quantity * $percentage) / 100, 2);\r\n\r\n                                if (abs($existingPayment->calculated_amount - $expectedAmount) > 0.01) {\r\n                                    DB::table('daily_payments')\r\n                                        ->where('id', $existingPayment->id)\r\n                                        ->update([\r\n                                            'quantity_produced' => $cut->quantity,\r\n                                            'calculated_amount' => $earned,\r\n                                            'employee_percentage' => $percentage,\r\n                                            'updated_at' => now(),\r\n                                        ]);\r\n                                    $log['updated_payments']++;\r\n                                }\r\n                            } else {\r\n                                DB::table('daily_payments')->insert([\r\n                                    'employee_id' => $emp->id,\r\n                                    'model_id' => $order->orderModel->model->id,\r\n                                    'order_id' => $order->id,\r\n                                    'department_id' => $department->id,\r\n                                    'payment_date' => $cutDate,\r\n                                    'quantity_produced' => $cut->quantity,\r\n                                    'calculated_amount' => $earned,\r\n                                    'employee_percentage' => $percentage,\r\n                                    'created_at' => now(),\r\n                                    'updated_at' => now(),\r\n                                ]);\r\n                                $log['created_payments']++;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    $log['processed_cuts']++;\r\n                } catch (\\Throwable $e) {\r\n                    $log['errors'][] = \"Cut ID {$cut->id}: {$e->getMessage()}\";\r\n                }\r\n            }\r\n\r\n            // ============================================\r\n            // 2\uFE0F⃣ SEWING natijalarini qayta hisoblash\r\n            // ============================================\r\n\r\n            $sewingOutputs = SewingOutputs::whereBetween('created_at', [$startDate, $endDate])\r\n                ->whereHas('orderSubmodel.orderModel.order', function($q) use ($branchId) {\r\n                    $q->where('branch_id', $branchId);\r\n                })\r\n                ->with([\r\n                    'orderSubmodel.orderModel.model',\r\n                    'orderSubmodel.orderModel.order'\r\n                ])\r\n                ->get();\r\n\r\n            foreach ($sewingOutputs as $sewing) {\r\n                try {\r\n                    $orderSubModel = $sewing->orderSubmodel;\r\n                    $orderModel = $orderSubModel->orderModel;\r\n                    $order = $orderModel->order;\r\n\r\n                    $sewingDate = Carbon::parse($sewing->created_at)->toDateString();\r\n                    $sewingTime = Carbon::parse($sewing->created_at);\r\n                    $newQuantity = $sewing->quantity;\r\n\r\n                    // \uD83D\uDCCC Sewing asosidagi bo'limlar\r\n                    $sewingDepartments = [\r\n                        \"Sifat nazorati va qadoqlash bo'limi\",\r\n                        \"Texnik bo'lim\",\r\n                        \"Ho'jalik ishlari bo'limi\",\r\n                        \"Rejalashtirish va iqtisod bo'limi\",\r\n                        \"Ma'muriy boshqaruv\"\r\n                    ];\r\n\r\n                    foreach ($sewingDepartments as $deptName) {\r\n                        $department = Department::where('name', $deptName)\r\n                            ->whereHas('mainDepartment', function($q) use($branchId) {\r\n                                $q->where('branch_id', $branchId);\r\n                            })->first();\r\n\r\n                        if (!$department) continue;\r\n\r\n                        $budget = DB::table('department_budgets')\r\n                            ->where('department_id', $department->id)\r\n                            ->first();\r\n\r\n                        if (!$budget) continue;\r\n\r\n                        $modelMinute = $orderModel->model->minute ?? 0;\r\n                        $usdRate = getUsdRate();\r\n                        $orderUsdPrice = $order->price ?? 0;\r\n                        $orderUzsPrice = $orderUsdPrice * $usdRate;\r\n\r\n                        if ($budget->type == 'minute_based' && $modelMinute > 0) {\r\n                            $totalAmount = $modelMinute * $newQuantity * $budget->quantity;\r\n                        } elseif ($budget->type == 'percentage_based') {\r\n                            $percentage = $budget->quantity ?? 0;\r\n                            $totalAmount = round(($orderUzsPrice * $percentage) / 100, 2);\r\n                        } else {\r\n                            $totalAmount = $newQuantity * $budget->quantity;\r\n                        }\r\n\r\n                        // ✅ Faqat o'sha kun davomatda va sewing vaqtidan OLDIN kelgan xodimlar\r\n                        $employees = Employee::where('department_id', $department->id)\r\n                            ->where('status', 'working')\r\n                            ->whereHas('attendances', function ($q) use ($sewingDate, $sewingTime) {\r\n                                $q->whereDate('date', $sewingDate)\r\n                                    ->where('status', 'present')\r\n                                    ->where(function($q2) use ($sewingTime) {\r\n                                        $q2->whereNull('arrival_time')\r\n                                            ->orWhereTime('arrival_time', '<=', $sewingTime->format('H:i:s'));\r\n                                    });\r\n                            })\r\n                            ->get();\r\n\r\n                        foreach ($employees as $emp) {\r\n                            $existingPayment = DB::table('daily_payments')\r\n                                ->where('employee_id', $emp->id)\r\n                                ->where('order_id', $order->id)\r\n                                ->where('model_id', $orderModel->model->id)\r\n                                ->whereDate('payment_date', $sewingDate)\r\n                                ->first();\r\n\r\n                            $percentage = $existingPayment\r\n                                ? $existingPayment->employee_percentage\r\n                                : ($emp->percentage ?? 0);\r\n\r\n                            if ($percentage == 0) continue;\r\n\r\n                            $earned = round(($totalAmount * $percentage) / 100, 2);\r\n                            if ($earned == 0) continue;\r\n\r\n                            if ($existingPayment) {\r\n                                $expectedAmount = round(($totalAmount * $percentage) / 100, 2);\r\n\r\n                                if (abs($existingPayment->calculated_amount - $expectedAmount) > 0.01) {\r\n                                    DB::table('daily_payments')->where('id', $existingPayment->id)\r\n                                        ->update([\r\n                                            'quantity_produced' => $newQuantity,\r\n                                            'calculated_amount' => $earned,\r\n                                            'employee_percentage' => $percentage,\r\n                                            'updated_at' => now(),\r\n                                        ]);\r\n                                    $log['updated_payments']++;\r\n                                }\r\n                            } else {\r\n                                DB::table('daily_payments')->insert([\r\n                                    'employee_id' => $emp->id,\r\n                                    'model_id' => $orderModel->model->id,\r\n                                    'order_id' => $order->id,\r\n                                    'department_id' => $department->id,\r\n                                    'payment_date' => $sewingDate,\r\n                                    'quantity_produced' => $newQuantity,\r\n                                    'calculated_amount' => $earned,\r\n                                    'employee_percentage' => $percentage,\r\n                                    'created_at' => now(),\r\n                                    'updated_at' => now(),\r\n                                ]);\r\n                                $log['created_payments']++;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    $log['processed_sewings']++;\r\n                } catch (\\Throwable $e) {\r\n                    $log['errors'][] = \"Sewing ID {$sewing->id}: {$e->getMessage()}\";\r\n                }\r\n            }\r\n\r\n            DB::commit();\r\n\r\n            return response()->json([\r\n                'message' => 'To\\'lovlar muvaffaqiyatli qayta hisoblandi ✅',\r\n                'summary' => $log\r\n            ]);\r\n\r\n        } catch (\\Throwable $e) {\r\n            DB::rollBack();\r\n            return response()->json([\r\n                'error' => $e->getMessage(),\r\n                'line' => $e->getLine()\r\n            ], 500);\r\n        }\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/Http/Controllers/CasherController.php b/app/Http/Controllers/CasherController.php
--- a/app/Http/Controllers/CasherController.php	(revision f68ea360d0ccc0cd5e8e17942d0740f3cb7f80c1)
+++ b/app/Http/Controllers/CasherController.php	(date 1763034557023)
@@ -931,11 +931,13 @@
 //                }
 
                  //QOIDA #2: 5 daqiqa o'tgan bo'lsa — Block
-                 if ($lastPayment->created_at->lt(now()->subMinutes(5))) {
-                     return response()->json([
-                         'message' => "Oxirgi to‘lovdan 5 daqiqa o‘tib ketgan 😉"
-                     ], 500);
-                 }
+//                 if ($lastPayment->created_at->lt(now()->subMinutes(5))) {
+//                     return response()->json([
+//                         'message' => "Oxirgi to‘lovdan 5 daqiqa o‘tib ketgan 😉"
+//                     ], 500);
+//                 }
+
+
 
                 // QOIDA #3: Minus kattalik check
 //                if (abs($validated['amount']) > abs($lastPayment->amount)) {
Index: app/Providers/RouteServiceProvider.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?php\r\n\r\nnamespace App\\Providers;\r\n\r\nuse Illuminate\\Cache\\RateLimiting\\Limit;\r\nuse Illuminate\\Foundation\\Support\\Providers\\RouteServiceProvider as ServiceProvider;\r\nuse Illuminate\\Http\\Request;\r\nuse Illuminate\\Support\\Facades\\RateLimiter;\r\nuse Illuminate\\Support\\Facades\\Route;\r\n\r\nclass RouteServiceProvider extends ServiceProvider\r\n{\r\n    /**\r\n     * The path to your application's \"home\" route.\r\n     *\r\n     * Typically, users are redirected here after authentication.\r\n     *\r\n     * @var string\r\n     */\r\n    public const HOME = '/home';\r\n\r\n    /**\r\n     * Define your route model bindings, pattern filters, and other route configuration.\r\n     */\r\n    public function boot(): void\r\n    {\r\n        RateLimiter::for('api', function (Request $request) {\r\n            return Limit::perMinute(300000)->by($request->user()?->id ?: $request->ip());\r\n        });\r\n\r\n        $this->routes(function () {\r\n            Route::middleware('api')\r\n                ->prefix('api')\r\n                ->group(base_path('routes/api.php'));\r\n\r\n            Route::middleware('web')\r\n                ->group(base_path('routes/web.php'));\r\n        });\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/Providers/RouteServiceProvider.php b/app/Providers/RouteServiceProvider.php
--- a/app/Providers/RouteServiceProvider.php	(revision f68ea360d0ccc0cd5e8e17942d0740f3cb7f80c1)
+++ b/app/Providers/RouteServiceProvider.php	(date 1763034557041)
@@ -25,7 +25,7 @@
     public function boot(): void
     {
         RateLimiter::for('api', function (Request $request) {
-            return Limit::perMinute(300000)->by($request->user()?->id ?: $request->ip());
+            return Limit::perMinute(1000)->by($request->user()?->id ?: $request->ip());
         });
 
         $this->routes(function () {
Index: .idea/data_source_mapping.xml
===================================================================
diff --git a/.idea/data_source_mapping.xml b/.idea/data_source_mapping.xml
deleted file mode 100644
--- a/.idea/data_source_mapping.xml	(revision f68ea360d0ccc0cd5e8e17942d0740f3cb7f80c1)
+++ /dev/null	(revision f68ea360d0ccc0cd5e8e17942d0740f3cb7f80c1)
@@ -1,6 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<project version="4">
-  <component name="DataSourcePerFileMappings">
-    <file url="file://$APPLICATION_CONFIG_DIR$/consoles/db/e6cf56dc-6987-40b1-a4db-d4b70804e1ba/console.sql" value="e6cf56dc-6987-40b1-a4db-d4b70804e1ba" />
-  </component>
-</project>
\ No newline at end of file
Index: .idea/phpunit.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<project version=\"4\">\r\n  <component name=\"PHPUnit\">\r\n    <option name=\"directories\">\r\n      <list>\r\n        <option value=\"$PROJECT_DIR$/tests/Unit\" />\r\n        <option value=\"$PROJECT_DIR$/tests/Feature\" />\r\n      </list>\r\n    </option>\r\n  </component>\r\n</project>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/.idea/phpunit.xml b/.idea/phpunit.xml
--- a/.idea/phpunit.xml	(revision f68ea360d0ccc0cd5e8e17942d0740f3cb7f80c1)
+++ b/.idea/phpunit.xml	(date 1763034557019)
@@ -3,8 +3,7 @@
   <component name="PHPUnit">
     <option name="directories">
       <list>
-        <option value="$PROJECT_DIR$/tests/Unit" />
-        <option value="$PROJECT_DIR$/tests/Feature" />
+        <option value="$PROJECT_DIR$/tests" />
       </list>
     </option>
   </component>
Index: app/Http/Controllers/HikvisionEventController.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?php\r\n\r\nnamespace App\\Http\\Controllers;\r\n\r\nuse App\\Models\\EmployeeTransportDaily;\r\nuse App\\Models\\Log;\r\nuse Illuminate\\Http\\Request;\r\nuse Carbon\\Carbon;\r\nuse App\\Models\\Employee;\r\nuse App\\Models\\Attendance;\r\nuse Illuminate\\Support\\Facades\\Storage;\r\nuse Illuminate\\Support\\Facades\\Http;\r\nuse Symfony\\Component\\HttpKernel\\DataCollector\\LoggerDataCollector;\r\n\r\n// <— ⚠\uFE0F BU YO‘Q EDI, Telegram POST uchun kerak\r\n\r\nclass HikvisionEventController extends Controller\r\n{\r\n    public function handleEvent(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $contentType = $request->header('Content-Type');\r\n\r\n        // Qurilma → filial mapping\r\n        $deviceBranchMap = [\r\n            255 => 4,\r\n            105 => 5,\r\n        ];\r\n\r\n        $branchChatMap = [\r\n            4 => -1003041140850,\r\n            5 => -1001883536528,\r\n        ];\r\n\r\n//        Log::add(\r\n//            null,\r\n//            'Hikvision event qabul qilindi',\r\n//            'info',\r\n//            null,\r\n//            ['event_log' => $request->event_log ?? $request->all()]\r\n//        );\r\n\r\n        if (str_contains($contentType, 'multipart/form-data')) {\r\n            $eventLogRaw = $request->input('event_log');\r\n            $outerEvent = null;\r\n\r\n            if ($eventLogRaw) {\r\n                $outerEvent = json_decode($eventLogRaw, true);\r\n                $accessData = $outerEvent['AccessControllerEvent'] ?? [];\r\n            } elseif ($request->has('AccessControllerEvent')) {\r\n                $outerEvent = json_decode($request->input('AccessControllerEvent'), true);\r\n                $accessData = $outerEvent['AccessControllerEvent'] ?? [];\r\n            } else {\r\n                Log::add(null, 'Hikvision event: format aniqlanmadi', 'error', null, [\r\n                    'request_data' => $request->all(),\r\n                ]);\r\n                return response()->json(['status' => 'unknown_format']);\r\n            }\r\n\r\n            $employeeNo = $accessData['employeeNoString'] ?? null;\r\n            $deviceId = isset($outerEvent['deviceID']) ? (int)$outerEvent['deviceID'] : null;\r\n            $eventTime = $outerEvent['dateTime'] ?? now()->toDateTimeString();\r\n\r\n            $branchFromDevice = $deviceBranchMap[$deviceId] ?? null;\r\n            if (!$branchFromDevice) {\r\n                return response()->json(['status' => 'unknown_device']);\r\n            }\r\n\r\n            $employee = Employee::with(['transports', 'department', 'group'])->find($employeeNo); // ⚠\uFE0F department/group ham kerak edi\r\n\r\n            if (!$employee || (int)$employee->branch_id !== (int)$branchFromDevice) {\r\n                Log::add($employee->user_id ?? null, 'Branch mos kelmadi yoki employee topilmadi', 'branch_mismatch', null, [\r\n                    'employee_id' => $employeeNo,\r\n                    'employee_branch' => $employee->branch_id ?? null,\r\n                    'device_branch' => $branchFromDevice,\r\n                    'device_id' => $deviceId,\r\n                ]);\r\n                return response()->json(['status' => 'branch_mismatch']);\r\n            }\r\n\r\n            $eventCarbon = Carbon::parse($eventTime)->setTimezone('Asia/Tashkent'); // ⚠\uFE0F vaqtni to‘g‘ri zona bilan olish\r\n            $today = $eventCarbon->toDateString();\r\n\r\n            $attendance = Attendance::firstOrCreate(\r\n                ['employee_id' => $employee->id, 'date' => $today],\r\n                ['source_type' => 'device']\r\n            );\r\n\r\n            // === CHECK-IN ===\r\n            if ($deviceId === 255 || $deviceId === 105) {\r\n                if (!$attendance->check_in) {\r\n                    $image = $request->file('Picture');\r\n                    $imagePath = null;\r\n\r\n                    if ($image && $image->isValid()) {\r\n                        $filename = uniqid($employeeNo . '_') . '.' . $image->getClientOriginalExtension();\r\n                        $path = $image->storeAs('hikvisionImages', $filename, 's3');\r\n                        Storage::disk('s3')->setVisibility($path, 'public');\r\n                        $imagePath = Storage::disk('s3')->url($path);\r\n                    }\r\n\r\n                    $attendance->check_in = $eventCarbon;\r\n                    $attendance->check_in_image = $imagePath;\r\n                    $attendance->status = 'present';\r\n                    $attendance->save();\r\n\r\n                    // Transport davomat\r\n                    if (!$employee->transports->isEmpty()) {\r\n                        $transport = $employee->transports->first();\r\n\r\n                        $exists = EmployeeTransportDaily::where('employee_id', $employee->id)\r\n                            ->where('transport_id', $transport->id)\r\n                            ->whereDate('date', now())\r\n                            ->exists();\r\n\r\n                        if (!$exists) {\r\n                            EmployeeTransportDaily::create([\r\n                                'employee_id' => $employee->id,\r\n                                'transport_id' => $transport->id,\r\n                                'date' => now(),\r\n                            ]);\r\n                        }\r\n                    }\r\n\r\n                    // === AUP kechikish tekshiruvi ===\r\n                    if ($employee->type === 'aup') {\r\n                        $lateTime = Carbon::createFromTime(7, 30, 0, 'Asia/Tashkent');\r\n\r\n                        if ($eventCarbon->gt($lateTime)) {\r\n                            $lateChatId = -4832517980;\r\n                            $botToken = '8466233197:AAFpW34maMs_2y5-Ro_2FQNxniLBaWwLRD8';\r\n                            $checkInTime = $eventCarbon; // ✅ Shu qatorda aniqlaymiz\r\n\r\n                            $msg = sprintf(\r\n                                \"⚠\uFE0F *%s* (AUP) kechikib keldi.\\n\\n\" .\r\n                                \"\uD83D\uDCF1 *Telefon:* %s\\n\" .\r\n                                \"\uD83D\uDD52 *Kirish vaqti:* %s\\n\" .\r\n                                \"\uD83C\uDFE2 *Bo‘lim:* %s\\n\" .\r\n                                \"\uD83D\uDC65 *Guruh:* %s\",\r\n                                $employee->name ?? '-',\r\n                                $employee->phone ?? '-',\r\n                                $checkInTime->format('H:i:s'),\r\n                                $employee->department->name ?? '-',\r\n                                $employee->group->name ?? '-'\r\n                            );\r\n\r\n                            // Default employee rasmi\r\n                            $imageUrl = !empty($employee->img)\r\n                                ? (str_starts_with($employee->img, 'http') ? $employee->img : url($employee->img))\r\n                                : null;\r\n\r\n                            // Hikvision eventdan kelgan rasm (S3 dan)\r\n                            if (!empty($imagePath)) {\r\n                                $imageUrl = $imagePath; // bu allaqachon to‘liq public URL\r\n                            }\r\n\r\n                            // Fon jarayon sifatida yuborish\r\n                            dispatch(function () use ($botToken, $lateChatId, $msg, $imageUrl) {\r\n                                try {\r\n                                    if ($imageUrl) {\r\n                                        // Telegramga rasm bilan yuborish\r\n                                        \\Http::post(\"https://api.telegram.org/bot{$botToken}/sendPhoto\", [\r\n                                            'chat_id' => $lateChatId,\r\n                                            'photo' => $imageUrl,\r\n                                            'caption' => $msg,\r\n                                            'parse_mode' => 'Markdown',\r\n                                        ]);\r\n                                    } else {\r\n                                        // Agar rasm yo‘q bo‘lsa, faqat matn yuborish\r\n                                        \\Http::post(\"https://api.telegram.org/bot{$botToken}/sendMessage\", [\r\n                                            'chat_id' => $lateChatId,\r\n                                            'text' => $msg,\r\n                                            'parse_mode' => 'Markdown',\r\n                                        ]);\r\n                                    }\r\n                                } catch (\\Throwable $e) {\r\n                                    \\Log::error('Telegram kechikish xabar yuborilmadi: ' . $e->getMessage());\r\n                                }\r\n                            });\r\n                        }\r\n                    }\r\n\r\n\r\n\r\n\r\n                    Log::add($employee->user_id ?? null, 'Hodim ishga keldi', 'Check In', null, [\r\n                        'employee_id' => $employee->id,\r\n                        'image_path' => $imagePath,\r\n                        'device_id' => $deviceId,\r\n                        'time' => $eventTime,\r\n                    ]);\r\n\r\n                    // Branchning umumiy hisobotini yangilash\r\n                    $branchId = $employee->branch_id;\r\n                    $chatId = $branchChatMap[$branchId] ?? null;\r\n\r\n                    if ($chatId) {\r\n                        $employees = Employee::with(['department', 'group'])\r\n                            ->where('branch_id', $branchId)\r\n                            ->whereHas('attendances', function ($query) use ($today) {\r\n                                $query->whereDate('check_in', $today);\r\n                            })\r\n                            ->get();\r\n\r\n                        app(\\App\\Services\\TelegramService::class)\r\n                            ->updateDailyReport($branchId, $chatId, $employees);\r\n                    }\r\n                } else {\r\n                    Log::add($employee->user_id ?? null, 'Qaytadan faceId aniqlandi', 'already_checkin', null, [\r\n                        'employee_id' => $employee->id,\r\n                        'device_id' => $deviceId,\r\n                        'time' => $eventTime,\r\n                    ]);\r\n                }\r\n            }\r\n\r\n            // === CHECK-OUT ===\r\n            elseif ($deviceId === 256) {\r\n                if (!$attendance->check_out) {\r\n                    $attendance->check_out = $eventCarbon;\r\n                    $attendance->save();\r\n\r\n                    Log::add($employee->user_id ?? null, 'Hodim ishdan ketdi', 'Check Out', null, [\r\n                        'employee_id' => $employee->id,\r\n                        'device_id' => $deviceId,\r\n                        'time' => $eventTime,\r\n                    ]);\r\n                } else {\r\n                    Log::add($employee->user_id ?? null, 'Qaytadan faceId aniqlandi', 'already_checkout', null, [\r\n                        'employee_id' => $employee->id,\r\n                        'device_id' => $deviceId,\r\n                        'time' => $eventTime,\r\n                    ]);\r\n                }\r\n            }\r\n        }\r\n\r\n        return response()->json(['status' => 'received']);\r\n    }\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/Http/Controllers/HikvisionEventController.php b/app/Http/Controllers/HikvisionEventController.php
--- a/app/Http/Controllers/HikvisionEventController.php	(revision f68ea360d0ccc0cd5e8e17942d0740f3cb7f80c1)
+++ b/app/Http/Controllers/HikvisionEventController.php	(date 1763034557024)
@@ -31,6 +31,15 @@
             5 => -1001883536528,
         ];
 
+//        Log::add(
+//            null,
+//            "Usha krisa ishladi",
+//            'attendance',
+//            $request->ip(),
+//            $request->all()
+//        );
+
+
 //        Log::add(
 //            null,
 //            'Hikvision event qabul qilindi',
@@ -77,7 +86,8 @@
                 return response()->json(['status' => 'branch_mismatch']);
             }
 
-            $eventCarbon = Carbon::parse($eventTime)->setTimezone('Asia/Tashkent'); // ⚠️ vaqtni to‘g‘ri zona bilan olish
+//            $eventCarbon = Carbon::parse($eventTime)->setTimezone('Asia/Tashkent'); // ⚠️ vaqtni to‘g‘ri zona bilan olish
+            $eventCarbon = Carbon::parse($eventTime);
             $today = $eventCarbon->toDateString();
 
             $attendance = Attendance::firstOrCreate(
Index: app/Http/Controllers/SuperHRController.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?php\r\n\r\nnamespace App\\Http\\Controllers;\r\n\r\nuse App\\Exports\\EmployeeAttendanceExport;\r\nuse App\\Http\\Resources\\GetEmployeeResourceCollection;\r\nuse App\\Models\\Attendance;\r\nuse App\\Models\\Department;\r\nuse App\\Models\\Employee;\r\nuse App\\Models\\EmployeeAbsence;\r\nuse App\\Models\\EmployeeHolidays;\r\nuse App\\Models\\Lid;\r\nuse App\\Models\\Log;\r\nuse App\\Models\\MainDepartment;\r\nuse App\\Models\\Region;\r\nuse App\\Models\\Role;\r\nuse App\\Models\\User;\r\nuse Illuminate\\Http\\Request;\r\nuse Illuminate\\Support\\Carbon;\r\nuse Illuminate\\Support\\Facades\\DB;\r\nuse App\\Exports\\EmployeeExport;\r\nuse Illuminate\\Support\\Facades\\Http;\r\nuse Illuminate\\Support\\Facades\\Storage;\r\nuse Illuminate\\Support\\Str;\r\nuse Maatwebsite\\Excel\\Facades\\Excel;\r\nuse Barryvdh\\DomPDF\\Facade\\Pdf;\r\n\r\n\r\nclass SuperHRController extends Controller\r\n{\r\n\r\n    public function storeEmployeeAbsence(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $request->validate([\r\n            'employee_id' => 'required|integer|exists:employees,id',\r\n            'start_date' => 'required|date',\r\n            'end_date' => 'required|date|after_or_equal:start_date',\r\n            'comment' => 'nullable|string|max:255',\r\n            'image' => 'nullable|image|mimes:jpeg,png,jpg,gif|max:20480',\r\n        ]);\r\n\r\n        try {\r\n            DB::beginTransaction();\r\n\r\n            $filename = null;\r\n            if ($request->hasFile('image')) {\r\n                $file = $request->file('image');\r\n                $filename = time() . '.' . $file->getClientOriginalExtension();\r\n\r\n                $path = $file->storeAs('employeeAbsences', $filename, 's3');\r\n\r\n                Storage::disk('s3')->setVisibility($path, 'public');\r\n            }\r\n\r\n            $absence = EmployeeAbsence::create([\r\n                'employee_id' => $request->employee_id,\r\n                'start_date' => $request->start_date,\r\n                'end_date' => $request->end_date,\r\n                'comment' => $request->comment,\r\n                'image' => $filename ? Storage::disk('s3')->url($path) : null,\r\n            ]);\r\n\r\n            DB::commit();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Xodimning sababsiz kelmaganligi aniqlandi',\r\n                'create',\r\n                null,\r\n                $absence\r\n            );\r\n\r\n            // \uD83D\uDFE2 Telegramga yuborish\r\n            $employee = \\App\\Models\\Employee::find($request->employee_id);\r\n            $messageText = \"\uD83D\uDEAB *Sababsiz:*\\n\\n\"\r\n                . \"*Ismi:* {$employee->name}\\n\"\r\n                . \"*Telefon:* {$employee->phone}\\n\"\r\n                . \"*Sanalar:* {$request->start_date} - {$request->end_date}\\n\"\r\n                . \"*Izoh:* \" . ($request->comment ?? 'Yo‘q');\r\n\r\n            // \uD83D\uDD3D Guruh va masʼul shaxs haqida qo‘shimcha\r\n            if ($employee->group_id) {\r\n                $group = \\App\\Models\\Group::with('responsibleUser')->find($employee->group_id);\r\n                if ($group) {\r\n                    $messageText .= \"\\n*Guruh:* {$group->name}\";\r\n                    if ($group->responsibleUser) {\r\n                        $messageText .= \"\\n*Masʼul:* {$group->responsibleUser->employee->name}\";\r\n                    }\r\n                }\r\n            }\r\n\r\n\r\n            $telegramToken = \"8055327076:AAEDwAlq1mvZiEbAi_ofnUwnJeIm4P6tE1A\";\r\n            $chatIdMap = [\r\n                5 => -1002655761088,\r\n                4 => -1003041140850,\r\n            ];\r\n\r\n            $chatId = $chatIdMap[$employee->branch_id] ?? null;\r\n\r\n            if ($filename) {\r\n                $fileContent = Storage::disk('s3')->get($path);\r\n                $fileName = basename($path);\r\n\r\n                Http::attach('photo', $fileContent, $filename)\r\n                    ->post(\"https://api.telegram.org/bot{$telegramToken}/sendPhoto\", [\r\n                        'chat_id' => $chatId,\r\n                        'caption' => $messageText,\r\n                        'parse_mode' => 'Markdown',\r\n                    ]);\r\n            } else {\r\n                // Faqat matn\r\n                Http::post(\"https://api.telegram.org/bot{$telegramToken}/sendMessage\", [\r\n                    'chat_id' => $chatId,\r\n                    'text' => $messageText,\r\n                    'parse_mode' => 'Markdown',\r\n                ]);\r\n            }\r\n\r\n            return response()->json([\r\n                'status' => 'success',\r\n                'message' => 'Xodimning yo‘qligi muvaffaqiyatli qo‘shildi',\r\n                'absence' => $absence,\r\n            ], 201);\r\n        }\r\n        catch (\\Exception $e) {\r\n            DB::rollBack();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Xodimning yo‘qligini qo‘shishda xatolik',\r\n                'error',\r\n                null,\r\n                $e->getMessage()\r\n            );\r\n\r\n            return response()->json([\r\n                'status' => 'error',\r\n                'message' => 'Xodimning yo‘qligini qo‘shishda xatolik: ' . $e->getMessage()\r\n            ], 500);\r\n        }\r\n    }\r\n\r\n    public function getPotentialAbsents(): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $user = auth()->user();\r\n        $branchId = $user?->employee?->branch_id;\r\n\r\n        if (!$branchId) {\r\n            return response()->json(['message' => '❌ Foydalanuvchining filial (branch) aniqlanmadi.'], 422);\r\n        }\r\n\r\n        $today = Carbon::today();\r\n\r\n        // 1. Bugungi attendance yozilgan hodimlar\r\n        $presentIds = Attendance::whereDate('date', $today)\r\n            ->pluck('employee_id')\r\n            ->toArray();\r\n\r\n        // 2. Bugungi ruxsatda (holiday) bo‘lgan employee_id lar\r\n        $holidayIds = EmployeeHolidays::whereDate('start_date', '<=', $today)\r\n            ->whereDate('end_date', '>=', $today)\r\n            ->pluck('employee_id')\r\n            ->toArray();\r\n\r\n        // 3. Bugungi ruxsatli yo'qlik (absence) bo'lganlar\r\n        $absenceIds = EmployeeAbsence::whereDate('start_date', '<=', $today)\r\n            ->whereDate('end_date', '>=', $today)\r\n            ->pluck('employee_id')\r\n            ->toArray();\r\n\r\n        // 4. Bugun attendance yozilmaganlar (lekin kicked bo‘lmaganlar)\r\n        $notCheckedIds = Employee::where('branch_id', $branchId)\r\n            ->whereNotIn('id', $presentIds)\r\n            ->where('status', '!=', 'kicked')\r\n            ->pluck('id')\r\n            ->toArray();\r\n\r\n        // 5. Holiday + Absence + Not checked larni birlashtiramiz\r\n        $allIds = array_unique(array_merge($notCheckedIds, $holidayIds, $absenceIds));\r\n\r\n        $employees = Employee::whereIn('id', $allIds)\r\n            ->where('branch_id', $branchId)\r\n            ->where('status', '!=', 'kicked')\r\n            ->with(['department', 'group', 'position'])\r\n            ->get();\r\n\r\n        // 6. Natija\r\n        $result = $employees->map(function ($employee) use ($today, $holidayIds, $absenceIds) {\r\n            $wasOnHoliday = in_array($employee->id, $holidayIds);\r\n            $wasOnAbsence = in_array($employee->id, $absenceIds);\r\n\r\n            $comment = null;\r\n            $image = null;\r\n\r\n            if ($wasOnHoliday) {\r\n                $holiday = EmployeeHolidays::where('employee_id', $employee->id)\r\n                    ->whereDate('start_date', '<=', $today)\r\n                    ->whereDate('end_date', '>=', $today)\r\n                    ->first();\r\n\r\n                $comment = $holiday?->comment;\r\n                $image = $holiday?->image ?? null;\r\n            } elseif ($wasOnAbsence) {\r\n                $absence = EmployeeAbsence::where('employee_id', $employee->id)\r\n                    ->whereDate('start_date', '<=', $today)\r\n                    ->whereDate('end_date', '>=', $today)\r\n                    ->first();\r\n\r\n                $comment = $absence?->comment;\r\n                $image = $absence?->image ?? null;\r\n            }\r\n\r\n            return [\r\n                'id' => $employee->id,\r\n                'name' => $employee->name,\r\n                'phone' => $employee->phone,\r\n                'department' => $employee->department->name ?? null,\r\n                'group' => $employee->group->name ?? null,\r\n                'position' => $employee->position->name ?? null,\r\n                'absent_date' => $today->toDateString(),\r\n                'was_on_holiday' => $wasOnHoliday,\r\n                'was_on_absence' => $wasOnAbsence,\r\n                'comment' => $comment,\r\n                'image' => (!empty($image) && Str::contains($image, '/')) ? url('storage/' . $image) : null,\r\n            ];\r\n        });\r\n\r\n        return response()->json($result);\r\n    }\r\n\r\n    public function getYesterdayAbsent(): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $user = auth()->user();\r\n        $branchId = $user?->employee?->branch_id;\r\n\r\n        if (!$branchId) {\r\n            return response()->json(['message' => '❌ Foydalanuvchining filial (branch) aniqlanmadi.'], 422);\r\n        }\r\n\r\n        $today = Carbon::today();\r\n        $yesterday = $today->copy()->subDay();\r\n\r\n        if ($yesterday->isSunday()) {\r\n            $yesterday = $yesterday->copy()->subDay();\r\n        }\r\n\r\n        $todayPresentIds = Attendance::whereDate('date', $today)\r\n            ->where('status', 'present')\r\n            ->pluck('employee_id')\r\n            ->toArray();\r\n\r\n        $yesterdayAbsentIds = Attendance::whereDate('date', $yesterday)\r\n            ->where('status', 'absent')\r\n            ->pluck('employee_id')\r\n            ->toArray();\r\n\r\n        $filteredIds = array_intersect($yesterdayAbsentIds, $todayPresentIds);\r\n\r\n        $holidayIds = \\App\\Models\\EmployeeHolidays::whereDate('start_date', '<=', $yesterday)\r\n            ->whereDate('end_date', '>=', $yesterday)\r\n            ->pluck('employee_id')\r\n            ->toArray();\r\n\r\n        $absenceIds = \\App\\Models\\EmployeeAbsence::whereDate('start_date', '<=', $yesterday)\r\n            ->whereDate('end_date', '>=', $yesterday)\r\n            ->pluck('employee_id')\r\n            ->toArray();\r\n\r\n        $allIds = array_unique(array_merge($filteredIds, $holidayIds, $absenceIds));\r\n\r\n        $employees = \\App\\Models\\Employee::whereIn('id', $allIds)\r\n            ->where('branch_id', $branchId)\r\n            ->with(['department', 'group', 'position'])\r\n            ->get();\r\n\r\n        $absentEmployees = $employees->map(function ($employee) use ($yesterday, $holidayIds, $absenceIds) {\r\n            $wasOnHoliday = in_array($employee->id, $holidayIds);\r\n            $wasOnAbsence = in_array($employee->id, $absenceIds);\r\n\r\n            $comment = null;\r\n            $image = null;\r\n\r\n            if ($wasOnHoliday) {\r\n                $holiday = \\App\\Models\\EmployeeHolidays::where('employee_id', $employee->id)\r\n                    ->whereDate('start_date', '<=', $yesterday)\r\n                    ->whereDate('end_date', '>=', $yesterday)\r\n                    ->first();\r\n\r\n                $comment = $holiday?->comment;\r\n                $image = $holiday?->image ?? null;\r\n            } elseif ($wasOnAbsence) {\r\n                $absence = \\App\\Models\\EmployeeAbsence::where('employee_id', $employee->id)\r\n                    ->whereDate('start_date', '<=', $yesterday)\r\n                    ->whereDate('end_date', '>=', $yesterday)\r\n                    ->first();\r\n\r\n                $comment = $absence?->comment;\r\n                $image = $absence?->image ?? null;\r\n            }\r\n\r\n            return [\r\n                'id' => $employee->id,\r\n                'name' => $employee->name,\r\n                'phone' => $employee->phone,\r\n                'department' => $employee->department->name ?? null,\r\n                'group' => $employee->group->name ?? null,\r\n                'position' => $employee->position->name ?? null,\r\n                'absent_date' => $yesterday->toDateString(),\r\n                'was_on_holiday' => $wasOnHoliday,\r\n                'was_on_absence' => $wasOnAbsence,\r\n                'comment' => $comment,\r\n                'image' => $image ?? null\r\n            ];\r\n        });\r\n\r\n        return response()->json($absentEmployees);\r\n    }\r\n\r\n    public function getEmployeeHolidays(): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $user = auth()->user();\r\n        $branchId = $user->employee->branch_id;\r\n        $startDate = request()->get('start_date');\r\n        $endDate = request()->get('end_date');\r\n        $search = request()->get('search');\r\n\r\n        $query = EmployeeHolidays::whereHas('employee', function ($q) use ($branchId) {\r\n            $q->where('branch_id', $branchId);\r\n        });\r\n\r\n        if ($startDate && $endDate) {\r\n            $query->whereBetween('start_date', [$startDate, $endDate])\r\n                ->orWhereBetween('end_date', [$startDate, $endDate]);\r\n        }\r\n\r\n        if ($search) {\r\n            $query->whereHas('employee', function ($q) use ($search) {\r\n                $q->where('name', 'like', '%' . $search . '%');\r\n            });\r\n\r\n            $query->orWhere('comment', 'like', '%' . $search . '%');\r\n        }\r\n\r\n        $holidays = $query->with('employee.department','employee.group')->orderBy('id', 'DESC')->paginate(10);\r\n\r\n        $holidays->getCollection()->transform(function ($holiday) {\r\n            $holiday->image = $holiday->image ?? null;\r\n            return $holiday;\r\n        });\r\n\r\n        return response()->json($holidays, 200);\r\n    }\r\n\r\n    public function editEmployeeHoliday(Request $request, $id): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $holiday = EmployeeHolidays::findOrFail($id);\r\n\r\n        if (!$holiday){\r\n            return response()->json(['status' => 'error', 'message' => 'Xodim ta‘tili topilmadi'], 404);\r\n        }\r\n\r\n        $request->validate([\r\n            'start_date' => 'sometimes|date',\r\n            'end_date' => 'sometimes|date|after_or_equal:start_date',\r\n            'comment' => 'sometimes|nullable|string|max:255',\r\n        ]);\r\n\r\n        try {\r\n            DB::beginTransaction();\r\n\r\n            $holiday->update([\r\n                'start_date' => $request->start_date ?? $holiday->start_date,\r\n                'end_date' => $request->end_date ?? $holiday->end_date,\r\n                'comment' => $request->comment ?? $holiday->comment,\r\n            ]);\r\n\r\n            DB::commit();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Xodim ta‘tili yangilandi',\r\n                'edit',\r\n                null,\r\n                $holiday\r\n            );\r\n\r\n            return response()->json(['status' => 'success', 'message' => 'Xodim ta‘tili muvaffaqiyatli yangilandi', 'holiday' => $holiday], 200);\r\n        } catch (\\Exception $e) {\r\n            DB::rollBack();\r\n            Log::add(\r\n                auth()->user()->id,\r\n                \"Xodim ta‘tilini yangilashda xatolik\",\r\n                \"error\",\r\n                null,\r\n                $e->getMessage()\r\n            );\r\n            return response()->json(['status' => 'error', 'message' => 'Xodim ta‘tilini yangilashda xatolik: ' . $e->getMessage()], 500);\r\n        }\r\n    }\r\n\r\n    public function storeEmployeeHoliday(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $request->validate([\r\n            'employee_id' => 'required|integer|exists:employees,id',\r\n            'start_date' => 'required|date',\r\n            'end_date' => 'required|date|after_or_equal:start_date',\r\n            'comment' => 'nullable|string|max:255',\r\n            'image' => 'nullable|image|mimes:jpeg,png,jpg,gif|max:20480',\r\n        ]);\r\n\r\n        try {\r\n            DB::beginTransaction();\r\n\r\n            $fileUrl = null;\r\n\r\n            if ($request->hasFile('image')) {\r\n                $file = $request->file('image');\r\n                $path = $file->store('employeeHolidays', 's3'); // faylni joylaymiz\r\n                Storage::disk('s3')->setVisibility($path, 'public'); // umumiy qilish\r\n                $fileUrl = Storage::disk('s3')->url($path); // URL ni olish\r\n            }\r\n\r\n            $holiday = \\App\\Models\\EmployeeHolidays::create([\r\n                'employee_id' => $request->employee_id,\r\n                'start_date' => $request->start_date,\r\n                'end_date' => $request->end_date,\r\n                'comment' => $request->comment,\r\n                'image' => $fileUrl,\r\n            ]);\r\n\r\n            DB::commit();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Xodim ta‘tili qo‘shildi',\r\n                'create',\r\n                null,\r\n                $holiday\r\n            );\r\n\r\n            // \uD83D\uDFE2 Telegramga yuborish\r\n            $employee = \\App\\Models\\Employee::find($request->employee_id);\r\n\r\n            $messageText = \"\uD83C\uDF34 \uFE0F*Sababli:*\\n\\n\"\r\n                . \"*Ismi:* {$employee->name}\\n\"\r\n                . \"*Telefon:* {$employee->phone}\\n\"\r\n                . \"*Sanalar:* {$request->start_date} - {$request->end_date}\\n\"\r\n                . \"*Izoh:* \" . ($request->comment ?? 'Yo‘q');\r\n\r\n            if ($employee->group_id) {\r\n                $group = \\App\\Models\\Group::with('responsibleUser')->find($employee->group_id);\r\n                if ($group) {\r\n                    $messageText .= \"\\n*Guruh:* {$group->name}\";\r\n                    if ($group->responsibleUser) {\r\n                        $messageText .= \"\\n*Masʼul:* {$group->responsibleUser->employee->name}\";\r\n                    }\r\n                }\r\n            }\r\n\r\n            $telegramToken = \"8055327076:AAEDwAlq1mvZiEbAi_ofnUwnJeIm4P6tE1A\";\r\n            $chatIdMap = [\r\n                5 => -1002655761088,\r\n                4 => -1003041140850,\r\n            ];\r\n\r\n            $chatId = $chatIdMap[$employee->branch_id] ?? null;\r\n\r\n            $photos = [];\r\n\r\n            if ($fileUrl) {\r\n                $photos[] = $fileUrl;\r\n            }\r\n\r\n            $attendance = \\App\\Models\\Attendance::where('employee_id', $request->employee_id)\r\n                ->whereDate('date', $request->start_date)\r\n                ->first();\r\n\r\n            if ($attendance && $attendance->check_in_image) {\r\n                $photos[] = $attendance->check_in_image;\r\n            }\r\n\r\n            if ($employee->img && (!$attendance || !$attendance->check_in_image)) {\r\n                $photos[] = $employee->img;\r\n            }\r\n\r\n            if (!empty($photos)) {\r\n                $media = [];\r\n                foreach ($photos as $index => $photoUrl) {\r\n                    $media[] = [\r\n                        'type' => 'photo',\r\n                        'media' => $photoUrl,\r\n                        'caption' => $index === 0 ? (string) $messageText : \"\",\r\n                        'parse_mode' => 'Markdown',\r\n                    ];\r\n                }\r\n\r\n                Http::post(\"https://api.telegram.org/bot{$telegramToken}/sendMediaGroup\", [\r\n                    'chat_id' => $chatId,\r\n                    'media' => json_encode($media, JSON_UNESCAPED_UNICODE),\r\n                ]);\r\n            } else {\r\n                Http::post(\"https://api.telegram.org/bot{$telegramToken}/sendMessage\", [\r\n                    'chat_id' => $chatId,\r\n                    'text' => $messageText,\r\n                    'parse_mode' => 'Markdown',\r\n                ]);\r\n            }\r\n\r\n            return response()->json([\r\n                'status' => 'success',\r\n                'message' => 'Xodim ta‘tili muvaffaqiyatli qo‘shildi',\r\n                'holiday' => $holiday,\r\n            ], 201);\r\n        } catch (\\Exception $e) {\r\n            DB::rollBack();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                \"Xodim ta‘tilini qo‘shishda xatolik\",\r\n                \"error\",\r\n                null,\r\n                $e->getMessage()\r\n            );\r\n\r\n            return response()->json([\r\n                'status' => 'error',\r\n                'message' => 'Xodim ta‘tilini qo‘shishda xatolik: ' . $e->getMessage()\r\n            ], 500);\r\n        }\r\n    }\r\n\r\n    public function exportAttendancePdf(Request $request): \\Illuminate\\Http\\Response|\\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $startDate = $request->get('start_date');\r\n        $endDate = $request->get('end_date');\r\n        $groupId = $request->get('group_id');\r\n        $departmentId = $request->get('department_id');\r\n        $statusFilter = $request->get('status'); // 'all' or 'absent'\r\n\r\n        ini_set('memory_limit', '2G');\r\n        set_time_limit(120);\r\n\r\n        $branchId = auth()->user()?->employee?->branch_id;\r\n        if (!$branchId) {\r\n            return response()->json(['message' => '❌ Foydalanuvchining filial aniqlanmadi'], 422);\r\n        }\r\n\r\n        if (!$startDate || !$endDate) {\r\n            return response()->json(['message' => '❌ Sana noto‘g‘ri yoki to‘liq emas'], 422);\r\n        }\r\n\r\n        $employees = \\App\\Models\\Employee::where('branch_id', $branchId)\r\n            ->where('status', '!=', 'kicked')\r\n            ->when($groupId, fn($q) => $q->where('group_id', $groupId))\r\n            ->when($departmentId, fn($q) => $q->where('department_id', $departmentId))\r\n            ->select('id', 'name', 'department_id', 'group_id')\r\n            ->get();\r\n\r\n        $attendances = \\App\\Models\\Attendance::whereBetween('date', [$startDate, $endDate])\r\n            ->whereIn('employee_id', $employees->pluck('id'))\r\n            ->get()\r\n            ->groupBy('employee_id');\r\n\r\n        $dateRange = collect();\r\n        $current = \\Carbon\\Carbon::parse($startDate);\r\n        $end = \\Carbon\\Carbon::parse($endDate);\r\n        while ($current->lte($end)) {\r\n            $dateRange->push($current->toDateString());\r\n            $current->addDay();\r\n        }\r\n\r\n        $result = $employees->map(function ($employee) use ($attendances, $dateRange) {\r\n            $employeeAttendances = $attendances[$employee->id] ?? collect();\r\n            $presentCount = 0;\r\n            $absentCount = 0;\r\n            $status = [];\r\n\r\n            foreach ($dateRange as $date) {\r\n                $att = $employeeAttendances->firstWhere('date', $date);\r\n                if ($att && $att->status === 'present') {\r\n                    $presentCount++;\r\n                    $status[] = ['date' => $date, 'status' => 'Kelgan'];\r\n                } else {\r\n                    $absentCount++;\r\n                    $status[] = ['date' => $date, 'status' => 'Kelmagan'];\r\n                }\r\n            }\r\n\r\n            return [\r\n                'employee_id' => $employee->id,\r\n                'name' => $employee->name,\r\n                'department' => $employee->department->name ?? null,\r\n                'group' => $employee->group->name ?? null,\r\n                'present_count' => $presentCount,\r\n                'absent_count' => $absentCount,\r\n                'status_detail' => $status,\r\n            ];\r\n        });\r\n\r\n        // \uD83E\uDDE0 Faqat to'liq \"Kelmagan\"lar uchun filtr\r\n        if ($statusFilter === 'absent') {\r\n            $result = $result->filter(fn($emp) => $emp['present_count'] === 0 && $emp['absent_count'] > 0)->values();\r\n        }\r\n\r\n        $pdf = PDF::loadView('pdf.attendance-report', [\r\n            'employees' => $result,\r\n            'date_range' => [$startDate, $endDate],\r\n        ])->setPaper('a4', 'portrait');\r\n\r\n        return $pdf->download(\"attendance_{$startDate}_{$endDate}.pdf\");\r\n    }\r\n\r\n    public function filterAttendance(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $startDate = $request->get('start_date');\r\n        $endDate = $request->get('end_date');\r\n        $groupId = $request->get('group_id');\r\n        $departmentId = $request->get('department_id');\r\n        $statusFilter = $request->get('status');\r\n\r\n        $branchId = auth()->user()?->employee?->branch_id;\r\n        if (!$branchId) {\r\n            return response()->json(['message' => '❌ Foydalanuvchining filial aniqlanmadi'], 422);\r\n        }\r\n\r\n        if (!$startDate || !$endDate) {\r\n            return response()->json(['message' => '❌ Sana noto‘g‘ri yoki to‘liq emas'], 422);\r\n        }\r\n\r\n        // ✅ Eager loading ishlatyapmiz (department, group, holidays)\r\n        $employees = \\App\\Models\\Employee::with(['department:id,name', 'group:id,name', 'employeeHolidays' => function ($q) use ($startDate, $endDate) {\r\n            $q->where(function ($sub) use ($startDate, $endDate) {\r\n                $sub->whereBetween('start_date', [$startDate, $endDate])\r\n                    ->orWhereBetween('end_date', [$startDate, $endDate]);\r\n            })->select('id','employee_id','start_date','end_date','comment');\r\n        }])\r\n            ->where('branch_id', $branchId)\r\n            ->where('status', '!=', 'kicked')\r\n            ->when($groupId, fn($q) => $q->where('group_id', $groupId))\r\n            ->when($departmentId, fn($q) => $q->where('department_id', $departmentId))\r\n            ->select('id','name','department_id','group_id')\r\n            ->get();\r\n\r\n        // ✅ Attendanceni faqat kerakli xodimlar uchun olib kelamiz\r\n        $attendances = \\App\\Models\\Attendance::whereBetween('date', [$startDate, $endDate])\r\n            ->whereIn('employee_id', $employees->pluck('id'))\r\n            ->select('id','employee_id','date','status','check_in','check_out','check_in_image')\r\n            ->get()\r\n            ->groupBy('employee_id');\r\n\r\n        // ✅ Sana oralig‘ini array qilib olish\r\n        $dateRange = collect();\r\n        $current = \\Carbon\\Carbon::parse($startDate);\r\n        $end = \\Carbon\\Carbon::parse($endDate);\r\n\r\n        while ($current->lte($end)) {\r\n            $dateRange->push($current->toDateString());\r\n            $current->addDay();\r\n        }\r\n\r\n        // ✅ Barcha hisob-kitobni PHP tarafda bajarish\r\n        $result = $employees->map(function ($employee) use ($attendances, $dateRange) {\r\n            $employeeAttendances = $attendances[$employee->id] ?? collect();\r\n\r\n            $present = [];\r\n            $absent = [];\r\n\r\n            foreach ($dateRange as $date) {\r\n                $att = $employeeAttendances->firstWhere('date', $date);\r\n\r\n                if ($att && $att->status === 'present') {\r\n                    $present[] = [\r\n                        'date' => $att->date,\r\n                        'status' => $att->status,\r\n                        'check_in' => $att->check_in,\r\n                        'check_out' => $att->check_out,\r\n                        'check_in_image' => $att->check_in_image,\r\n                    ];\r\n                } elseif ($att && $att->status === 'absent') {\r\n                    $absent[] = [\r\n                        'date' => $date,\r\n                        'status' => 'absent',\r\n                        'check_in' => null,\r\n                        'check_out' => null,\r\n                        'check_in_image' => null,\r\n                    ];\r\n                }\r\n            }\r\n\r\n            return [\r\n                'employee_id' => $employee->id,\r\n                'name' => $employee->name,\r\n                'department' => $employee->department->name ?? null,\r\n                'group' => $employee->group->name ?? null,\r\n                'attendances' => [\r\n                    'present' => $present,\r\n                    'absent' => $absent,\r\n                ],\r\n                'holidays' => $employee->employeeHolidays\r\n                    ? $employee->employeeHolidays->map(fn($h) => [\r\n                        'start_date' => $h->start_date,\r\n                        'end_date' => $h->end_date,\r\n                        'comment' => $h->comment,\r\n                    ])->toArray()\r\n                    : [],\r\n            ];\r\n        });\r\n\r\n        if ($statusFilter === 'absent') {\r\n            $result = $result->filter(function ($emp) {\r\n                return count($emp['attendances']['absent']) > 0 && count($emp['attendances']['present']) === 0;\r\n            })->values();\r\n        }\r\n\r\n        return response()->json([\r\n            'date_range' => [$startDate, $endDate],\r\n            'data' => $result,\r\n        ]);\r\n    }\r\n\r\n    public function getRegions(): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $regions = Region::all();\r\n        return response()->json($regions);\r\n    }\r\n\r\n    public function exportToExcel(Request $request): \\Symfony\\Component\\HttpFoundation\\BinaryFileResponse\r\n    {\r\n        ini_set('memory_limit', '-1');\r\n        return Excel::download(new EmployeeExport($request), 'xodimlar.xlsx');\r\n    }\r\n\r\n    public function getWorkingEmployees(): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $user = auth()->user();\r\n        $employees = Employee::where('branch_id', $user->employee->branch_id)\r\n            ->where('status', '!=','kicked')\r\n            ->with('position')\r\n            ->orderByDesc('updated_at')\r\n            ->get();\r\n\r\n        return response()->json($employees);\r\n    }\r\n\r\n    public function getEmployees(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $request->validate([\r\n            'search' => 'nullable|string',\r\n            'department_id' => 'nullable|integer|exists:departments,id',\r\n            'group_id' => 'nullable|integer|exists:groups,id',\r\n            'status' => 'nullable|string|in:working,kicked,reserv',\r\n            'role_id' => 'nullable|integer|exists:roles,id',\r\n            'type' => 'nullable|string|in:simple,aup', // <-- type validatsiyasi\r\n            'payment_type' => 'nullable|string', // <-- payment_type validatsiyasi\r\n        ]);\r\n\r\n        $filters = $request->only(['search', 'payment_type','department_id', 'group_id', 'status', 'role_id', 'type']);\r\n        $user = auth()->user();\r\n        $oneMonthAgo = Carbon::now()->subMonth();\r\n\r\n        $query = Employee::with('user.role', 'position')\r\n            ->where('employees.branch_id', $user->employee->branch_id)\r\n            ->leftJoin('employee_absences as ea', function ($join) use ($oneMonthAgo) {\r\n                $join->on('ea.employee_id', '=', 'employees.id')\r\n                    ->where(function ($q) use ($oneMonthAgo) {\r\n                        $q->whereDate('ea.start_date', '>=', $oneMonthAgo)\r\n                            ->orWhereDate('ea.end_date', '>=', $oneMonthAgo);\r\n                    });\r\n            })\r\n            ->leftJoin('employee_holidays as eh', function ($join) use ($oneMonthAgo) {\r\n                $join->on('eh.employee_id', '=', 'employees.id')\r\n                    ->where(function ($q) use ($oneMonthAgo) {\r\n                        $q->whereDate('eh.start_date', '>=', $oneMonthAgo)\r\n                            ->orWhereDate('eh.end_date', '>=', $oneMonthAgo);\r\n                    });\r\n            })\r\n            ->leftJoin('attendance as a', function ($join) use ($oneMonthAgo) {\r\n                $join->on('a.employee_id', '=', 'employees.id')\r\n                    ->where('a.status', 'absent')\r\n                    ->whereDate('a.date', '>=', $oneMonthAgo)\r\n                    ->whereRaw('EXTRACT(DOW FROM a.date) != 0');\r\n            })\r\n            ->select('employees.*')\r\n            ->selectRaw('COUNT(DISTINCT ea.id) as absence_count')\r\n            ->selectRaw('COUNT(DISTINCT eh.id) as holidays_count')\r\n            ->selectRaw('COUNT(DISTINCT a.id) as attendance_absent_count')\r\n            ->groupBy('employees.id')\r\n            ->orderByRaw('(COUNT(DISTINCT a.id) - COUNT(DISTINCT eh.id)) DESC');\r\n\r\n\r\n        if (!empty($filters['search'])) {\r\n            $search = strtolower($filters['search']);\r\n            $searchLatin = transliterate_to_latin($search);\r\n            $searchCyrillic = transliterate_to_cyrillic($search);\r\n\r\n            $query->where(function ($q) use ($search, $searchLatin, $searchCyrillic) {\r\n                foreach ([$search, $searchLatin, $searchCyrillic] as $term) {\r\n                    $q->orWhereRaw('LOWER(employees.name) LIKE ?', [\"%$term%\"])\r\n                        ->orWhereRaw('CAST(employees.id AS TEXT) LIKE ?', [\"%$term%\"])\r\n                        ->orWhereHas('position', function ($q) use ($term) {\r\n                            $q->whereRaw('LOWER(positions.name) LIKE ?', [\"%$term%\"]);\r\n                        })\r\n                        ->orWhereHas('user', function ($q) use ($term) {\r\n                            $q->whereRaw('LOWER(users.username) LIKE ?', [\"%$term%\"])\r\n                                ->orWhereHas('role', function ($q) use ($term) {\r\n                                    $q->whereRaw('LOWER(roles.description) LIKE ?', [\"%$term%\"]);\r\n                                });\r\n                        });\r\n                }\r\n            });\r\n        }\r\n\r\n\r\n        $query->when($filters['department_id'] ?? false, fn($q) => $q->where('employees.department_id', $filters['department_id']))\r\n            ->when(\r\n                true,\r\n                function ($q) use ($user, $filters) {\r\n                    if ($user->role->name === 'groupMaster') {\r\n                        // group_id ni user->employee ichidan olish kerak\r\n                        $q->where('employees.group_id', $user->employee->group_id);\r\n                    } elseif (!empty($filters['group_id'])) {\r\n                        $q->where('employees.group_id', $filters['group_id']);\r\n                    }\r\n                }\r\n            )\r\n            //            ->when($filters['group_id'] ?? false, fn($q) => $q->where('group_id', $filters['group_id']))\r\n            ->when($filters['status'] ?? false, fn($q) => $q->where('employees.status', $filters['status']))\r\n            ->when($filters['type'] ?? false, fn($q) => $q->where('employees.type', $filters['type']))\r\n            ->when($filters['role_id'] ?? false, function ($q) use ($filters) {\r\n                $q->whereHas('user', fn($q) => $q->where('role_id', $filters['role_id']));\r\n            })\r\n            ->when($filters['payment_type'] ?? false, function ($q) use ($filters) {\r\n                $q->where('employees.payment_type', $filters['payment_type']);\r\n            });\r\n\r\n        $employees = $query->orderBy('name')->paginate(10);\r\n\r\n        return (new GetEmployeeResourceCollection($employees))->response();\r\n    }\r\n\r\n    public function showEmployee($id): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $user = auth()->user();\r\n\r\n        $employee = Employee::with('user.role', 'position', 'department', 'group')\r\n            ->where('id', $id)\r\n            ->where('branch_id', $user->employee->branch_id)\r\n            ->firstOrFail();\r\n\r\n        return (new \\App\\Http\\Resources\\GetEmployeeResource($employee))->response();\r\n    }\r\n\r\n    public function storeEmployees(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $request->validate([\r\n            'name' => 'required|string',\r\n            'phone' => 'required|string',\r\n            'group_id' => 'nullable|integer|exists:groups,id',\r\n            'position_id' => 'nullable|integer|exists:positions,id',\r\n            'department_id' => 'nullable|integer|exists:departments,id',\r\n            'hiring_date' => 'nullable|date',\r\n            'address' => 'nullable|string',\r\n            'passport_number' => 'nullable|string',\r\n            'passport_code' => 'nullable|string',\r\n            'payment_type' => 'nullable|string',\r\n            'comment' => 'nullable|string',\r\n            'type' => 'nullable|string',\r\n            'birthday' => 'nullable|date',\r\n            'role_id' => 'nullable|integer|exists:roles,id',\r\n            'status' => 'nullable|string|in:working,kicked,reserv',\r\n            'img' => 'nullable|image|mimes:jpeg,png,jpg,gif|max:20480',\r\n            'salary' => 'nullable|numeric',\r\n            'gender'=> 'required|string',\r\n            'salary_visible' => 'nullable|boolean',\r\n        ]);\r\n\r\n        try {\r\n            DB::beginTransaction();\r\n\r\n            $username = $this->generateCodeWithBranch(auth()->user()->employee->branch_id);\r\n\r\n            $userId = DB::table('users')->insertGetId([\r\n                'username' => $username,\r\n                'password' => $this->hashPassword($request->phone),\r\n                'role_id' => $request->role_id ?? null,\r\n            ]);\r\n\r\n            if ($request->hasFile('img')) {\r\n                $file = $request->file('img');\r\n                $filename = time() . '.' . $file->getClientOriginalExtension();\r\n\r\n                // S3 ga yuklaymiz\r\n                $path = $file->storeAs('images', $filename, 's3');\r\n\r\n                Storage::disk('s3')->setVisibility($path, 'public');\r\n                $img = Storage::disk('s3')->url($path);\r\n            } else {\r\n                $img = null;\r\n            }\r\n\r\n            $employee = DB::table('employees')->insert([\r\n                'name' => $request->name,\r\n                'phone' => $request->phone,\r\n                'group_id' => $request->group_id ?? null,\r\n                'position_id' => $request->position_id,\r\n                'department_id' => $request->department_id,\r\n                'hiring_date' => $request->hiring_date,\r\n                'address' => $request->address,\r\n                'passport_number' => $request->passport_number ?? null,\r\n                'passport_code' => $request->passport_code ?? null,\r\n                'payment_type' => $request->payment_type,\r\n                'comment' => $request->comment ?? null,\r\n                'type' => $request->type,\r\n                'birthday' => $request->birthday ?? null,\r\n                'branch_id' => auth()->user()->employee->branch_id,\r\n                'user_id' => $userId, // <-- endi bu joyda xatolik bo‘lmaydi\r\n                'status' => $request->status,\r\n                'img' => $img,\r\n                'salary' => $request->salary ?? null,\r\n                'gender' => $request->gender,\r\n                'salary_visible' => $request->salary_visible ?? true,\r\n            ]);\r\n\r\n\r\n            DB::commit();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Yangi xodim qo‘shildi',\r\n                'create',\r\n                null,\r\n                $employee\r\n            );\r\n\r\n            return response()->json(['status' => 'success', 'message' => 'Xodim muvaffaqiyatli qo‘shildi', 'employee' => $employee], 201);\r\n        } catch (\\Exception $e) {\r\n            DB::rollBack();\r\n\r\n             Log::add(\r\n                auth()->user()->id,\r\n                'Xodim qo‘shishda xatolik',\r\n                'error',\r\n                null,\r\n                $e->getMessage()\r\n             );\r\n\r\n            return response()->json(['status' => 'error', 'message' => 'Xodimni qo‘shishda xatolik: ' . $e->getMessage()], 500);\r\n        }\r\n\r\n    }\r\n\r\n    public function storeFastEmployee(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $request->validate([\r\n            'name' => 'required|string',\r\n            'group_id' => 'nullable|integer|exists:groups,id',\r\n            'department_id' => 'nullable|integer|exists:departments,id',\r\n            'position_id' => 'nullable|integer|exists:positions,id',\r\n        ]);\r\n\r\n        try {\r\n            DB::beginTransaction();\r\n\r\n            $branchId = auth()->user()->employee->branch_id;\r\n\r\n            // Doimiy ishlatiladigan telefon raqam yoki random\r\n            $phone = '+998991111111'; // yoki uniq qilish uchun: '+99899' . rand(1000000, 9999999);\r\n\r\n            // Username avtomatik\r\n            $username = $this->generateCodeWithBranch($branchId);\r\n\r\n            // Foydalanuvchi yaratish\r\n            $userId = DB::table('users')->insertGetId([\r\n                'username' => $username,\r\n                'password' => $this->hashPassword($phone),\r\n                'role_id' => null,\r\n            ]);\r\n\r\n            // Xodim yaratish\r\n            $employee = DB::table('employees')->insert([\r\n                'name' => $request->name,\r\n                'phone' => $phone,\r\n                'group_id' => $request->group_id,\r\n                'position_id' => $request->position_id, // masalan, default pozitsiya ID\r\n                'department_id' => $request->department_id,\r\n                'hiring_date' => now(),\r\n                'address' => null,\r\n                'passport_number' => null,\r\n                'passport_code' => null,\r\n                'payment_type' => 'piece_work',\r\n                'comment' => null,\r\n                'type' => 'simple',\r\n                'birthday' => null,\r\n                'branch_id' => $branchId,\r\n                'user_id' => $userId,\r\n                'status' => 'working',\r\n                'img' => null,\r\n                'gender' => $request->gender ?? null,\r\n                'salary_visible' => true,\r\n            ]);\r\n\r\n            DB::commit();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Tezkor xodim qo‘shildi',\r\n                'create',\r\n                null,\r\n                $employee\r\n            );\r\n\r\n            return response()->json([\r\n                'status' => 'success',\r\n                'message' => 'Tezkor xodim muvaffaqiyatli qo‘shildi',\r\n                'employee' => $employee\r\n            ], 201);\r\n\r\n        } catch (\\Exception $e) {\r\n            DB::rollBack();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Tezkor xodim qo‘shishda xatolik',\r\n                'error',\r\n                null,\r\n                $e->getMessage()\r\n            );\r\n\r\n            return response()->json([\r\n                'status' => 'error',\r\n                'message' => 'Xatolik: ' . $e->getMessage()\r\n            ], 500);\r\n        }\r\n    }\r\n\r\n    public function updateEmployees(Request $request, $id): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $request->validate([\r\n            'name' => 'nullable|string',\r\n            'phone' => 'nullable|string',\r\n            'group_id' => 'nullable|integer|exists:groups,id',\r\n            'position_id' => 'nullable|integer|exists:positions,id',\r\n            'department_id' => 'nullable|integer|exists:departments,id',\r\n            'hiring_date' => 'nullable|date',\r\n            'address' => 'nullable|string',\r\n            'passport_number' => 'nullable|string',\r\n            'passport_code' => 'nullable|string',\r\n            'payment_type' => 'nullable|string',\r\n            'comment' => 'nullable|string',\r\n            'type' => 'nullable|string',\r\n            'birthday' => 'nullable|date',\r\n            'role_id' => 'nullable',\r\n            'status' => 'nullable|string|in:working,kicked,reserv',\r\n            'salary' => 'nullable|numeric',\r\n            'gender'=> 'nullable|string',\r\n            'img' => 'nullable|image|mimes:jpeg,png,jpg,gif|max:20480',\r\n            'salary_visible' => 'nullable|boolean',\r\n        ]);\r\n\r\n        try {\r\n            DB::beginTransaction();\r\n\r\n            if ($request->hasFile('img')) {\r\n                $file = $request->file('img');\r\n                $filename = time() . '.' . $file->getClientOriginalExtension();\r\n\r\n                $path = $file->storeAs('employees', $filename, 's3');\r\n\r\n                Storage::disk('s3')->setVisibility($path, 'public');\r\n                $img = Storage::disk('s3')->url($path);\r\n            } else {\r\n                $img = null;\r\n            }\r\n\r\n            $employee = Employee::findOrFail($id);\r\n            $oldData = $employee->toArray();\r\n            $user = User::findOrFail($employee->user_id);\r\n            $data = [];\r\n\r\n            if ($request->has('role_id')) {\r\n                // Agar role_id kelsa, lekin qiymati bo'sh bo'lsa -> null\r\n                $data['role_id'] = $request->input('role_id') !== null\r\n                    ? (int) $request->role_id\r\n                    : null;\r\n            }\r\n\r\n            $user->update($data);\r\n\r\n            if ($request->status === 'kicked') {\r\n                $employee->update([\r\n                    'name' => $request->name ?? $employee->name,\r\n                    'phone' => $request->phone ?? $employee->phone,\r\n                    'group_id' => $request->group_id ?? $employee->group_id,\r\n                    'position_id' => $request->position_id ?? $employee->position_id,\r\n                    'department_id' => $request->department_id ?? $employee->department_id,\r\n                    'hiring_date' => $request->hiring_date ?? $employee->hiring_date,\r\n                    'address' => $request->address ?? $employee->address,\r\n                    'passport_number' => $request->passport_number ?? $employee->passport_number,\r\n                    'passport_code' => $request->passport_code ?? $employee->passport_code,\r\n                    'payment_type' => $request->payment_type ?? $employee->payment_type,\r\n                    'comment' => $request->comment ?? $employee->comment,\r\n                    'type' => $request->type ?? $employee->type,\r\n                    'birthday' => $request->birthday ?? $employee->birthday,\r\n                    'img' => $img ?? $employee->img ?? null,\r\n                    'status' => $request->status ?? 'kicked',\r\n                    'kicked_date' => now(),\r\n                    'salary' => $request->salary ?? $employee->salary,\r\n                    'gender' => $request->gender ?? $employee->gender,\r\n                    'bonus' => $request->bonus ?? $employee->bonus,\r\n                    'salary_visible' => $request->salary_visible ?? $employee->salary_visible,\r\n                ]);\r\n            } else {\r\n                $employee->update([\r\n                    'name' => $request->name ?? $employee->name,\r\n                    'phone' => $request->phone ?? $employee->phone,\r\n                    'group_id' => $request->filled('group_id') ? (int) $request->group_id : null,\r\n                    'position_id' => $request->position_id ?? $employee->position_id,\r\n                    'department_id' => $request->department_id ?? $employee->department_id,\r\n                    'hiring_date' => $request->hiring_date ?? $employee->hiring_date,\r\n                    'address' => $request->address ?? $employee->address,\r\n                    'passport_number' => $request->passport_number ?? $employee->passport_number,\r\n                    'passport_code' => $request->passport_code ?? $employee->passport_code,\r\n                    'payment_type' => $request->payment_type ?? $employee->payment_type,\r\n                    'comment' => $request->comment ?? $employee->comment,\r\n                    'type' => $request->type ?? $employee->type,\r\n                    'birthday' => $request->birthday ?? $employee->birthday,\r\n                    'img' => $img ?? $employee->img ?? null,\r\n                    'salary' => $request->salary ?? $employee->salary,\r\n                    'kicked_date' => null,\r\n                    'gender' => $request->gender ?? $employee->gender,\r\n                    'status' => $request->status ?? 'working',\r\n                    'bonus' => $request->bonus ?? $employee->bonus,\r\n                    'salary_visible' => $request->salary_visible ?? $employee->salary_visible,\r\n                ]);\r\n            }\r\n            // endi groupChanges jadvaliga yozish kerak\r\n            if ($request->group_id != $oldData['group_id'] || $request->department_id != $oldData['department_id']) {\r\n                DB::table('group_changes')->insert([\r\n                    'employee_id' => $employee->id,\r\n                    'changed_by' => auth()->id(),\r\n                    'old_group_id' => $oldData['group_id'],\r\n                    'new_group_id' => $request->group_id,\r\n                    'old_department_id' => $oldData['department_id'],\r\n                    'new_department_id' => $request->department_id,\r\n                    'created_at' => now(),\r\n                    'updated_at' => now(),\r\n                    'ip' => $request->ip(),\r\n                    'device' => $request->header('User-Agent'),\r\n                ]);\r\n            }\r\n\r\n            // \uD83D\uDD39 Salary o‘zgarganini tekshiramiz\r\n            if ($request->filled('salary') && $request->salary != $oldData['salary']) {\r\n                // 1. Jadvalga yozish\r\n                \\DB::table('salary_changes')->insert([\r\n                    'employee_id' => $employee->id,\r\n                    'changed_by' => auth()->id(),\r\n                    'old_salary' => $oldData['salary'],\r\n                    'new_salary' => $request->salary,\r\n                    'old_type' => $oldData['payment_type'],\r\n                    'new_type' => $employee->payment_type,\r\n                    'created_at' => now(),\r\n                    'updated_at' => now(),\r\n                    'ip' => $request->ip(),\r\n                    'device' => $request->header('User-Agent'),\r\n                ]);\r\n\r\n                // 2. Telegramga yuborish\r\n                $botToken = '8356632904:AAGNr0sI2ClfY7-J76tPMEeC1KP1UO_ZdGU';\r\n                $chatId = '5228018221';\r\n\r\n                $message = sprintf(\r\n                    \"\uD83D\uDCB0 *Ish haqi o‘zgartirildi!*\\n\\n\" .\r\n                    \"\uD83D\uDC68\u200D\uD83C\uDFED *Xodim:* %s\\n\" .\r\n                    \"\uD83D\uDCDE *Tel:* %s\\n\" .\r\n                    \"\uD83D\uDCB5 *Eski:* %s so‘m\\n\" .\r\n                    \"\uD83D\uDCB5 *Yangi:* %s so‘m\\n\" .\r\n                    \"\uD83D\uDD04 *Eski to‘lov turi:* %s\\n\" .\r\n                    \"\uD83D\uDD04 *Yangi to‘lov turi:* %s\\n\" .\r\n                    \"\uD83D\uDC64 *O‘zgartirgan:* %s\\n\" .\r\n                    \"\uD83C\uDF10 *IP:* %s\\n\" .\r\n                    \"\uD83D\uDCBB *Qurilma:* %s\\n\" .\r\n                    \"\uD83D\uDD52 *%s*\",\r\n                    $employee->name ?? '-',\r\n                    $employee->phone ?? '-',\r\n                    number_format($oldData['salary'], 0, '.', ' '),\r\n                    number_format($request->salary, 0, '.', ' '),\r\n                    $oldData['payment_type'] ?? '-',\r\n                    $employee->payment_type ?? '-',\r\n                    auth()->user()->employee->name ?? '-',\r\n                    $request->ip(),\r\n                    $request->header('User-Agent'),\r\n                    now()->format('Y-m-d H:i')\r\n                );\r\n\r\n                // ✅ Xodim rasmi (to‘liq URL shaklida)\r\n                $imageUrl = !empty($employee->img)\r\n                    ? (str_starts_with($employee->img, 'http') ? $employee->img : url($employee->img))\r\n                    : null;\r\n\r\n                try {\r\n                    if ($imageUrl) {\r\n                        // Rasm bilan caption yuborish\r\n                        \\Illuminate\\Support\\Facades\\Http::post(\"https://api.telegram.org/bot{$botToken}/sendPhoto\", [\r\n                            'chat_id' => $chatId,\r\n                            'photo' => $imageUrl,\r\n                            'caption' => $message,\r\n                            'parse_mode' => 'Markdown'\r\n                        ]);\r\n                    } else {\r\n                        // Oddiy xabar yuborish\r\n                        \\Illuminate\\Support\\Facades\\Http::post(\"https://api.telegram.org/bot{$botToken}/sendMessage\", [\r\n                            'chat_id' => $chatId,\r\n                            'text' => $message,\r\n                            'parse_mode' => 'Markdown'\r\n                        ]);\r\n                    }\r\n                } catch (\\Throwable $e) {\r\n                return response()->json(['status' => 'error', 'message' => 'Telegramga xabar yuborishda xatolik: ' . $e->getMessage()], 500);\r\n                }\r\n            }\r\n\r\n            DB::commit();\r\n\r\n             Log::add(\r\n                auth()->user()->id,\r\n                'Xodim yangilandi',\r\n                'edit',\r\n                $oldData,\r\n                $employee\r\n             );\r\n\r\n            return response()->json(['status' => 'success', 'message' => 'Xodim muvaffaqiyatli yangilandi', 200]);\r\n        } catch (\\Exception $e) {\r\n            DB::rollBack();\r\n             Log::add(\r\n                auth()->user()->id,\r\n                \"Xodimni yangilashda xatolik\",\r\n                \"error\",\r\n                null,\r\n                $e->getMessage()\r\n             );\r\n            return response()->json(['status' => 'error', 'message' => 'Xodimni yangilashda xatolik: ' . $e->getMessage()], 500);\r\n        }\r\n    }\r\n\r\n    protected function hashPassword($password): string\r\n    {\r\n        $options = ['cost' => 12];\r\n        return password_hash($password, PASSWORD_BCRYPT, $options);\r\n    }\r\n\r\n    private function generateCodeWithBranch(int $branchId): string\r\n    {\r\n        $baseCode = $branchId;\r\n\r\n        // Oxirgi kodni topish\r\n        $lastUser = User::where('username', 'like', $baseCode . '%')\r\n            ->whereHas('employee', function ($query) use ($branchId) {\r\n                $query->where('branch_id', $branchId);\r\n            })\r\n            ->orderByDesc('id')\r\n            ->first();\r\n\r\n        if ($lastUser && preg_match('/^' . $baseCode . '(\\d{4})$/', $lastUser->username, $matches)) {\r\n            $lastCode = (int) $matches[1];\r\n        } else {\r\n            $lastCode = 999;\r\n        }\r\n\r\n        // Unique username topilguncha qayta urinish\r\n        do {\r\n            $lastCode++;\r\n            $newUsername = $baseCode . str_pad($lastCode, 4, '0', STR_PAD_LEFT);\r\n        } while (User::where('username', $newUsername)->exists());\r\n\r\n        return $newUsername;\r\n    }\r\n\r\n    public function getRoles(): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $roles = Role::orderBy('name')\r\n            ->get();\r\n\r\n        return response()->json($roles, 200);\r\n    }\r\n\r\n    public function getAupEmployee(): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $user = auth()->user();\r\n        $employees = Employee::where('branch_id', $user->employee->branch_id)\r\n            ->where('type', 'aup')\r\n            ->where('status', 'working')\r\n            ->with('department', 'position', 'group')\r\n            ->get();\r\n\r\n        return response()->json($employees, 200);\r\n    }\r\n\r\n    public function getPositions(): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $positions = DB::table('positions')\r\n            ->orderBy('name', 'desc')\r\n            ->get();\r\n\r\n        return response()->json($positions, 200);\r\n    }\r\n\r\n    public function storePositions(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $request->validate([\r\n            'name' => 'required|string|max:255',\r\n            'department_id' => 'required|integer|exists:departments,id',\r\n            'duties' => 'nullable|string',\r\n        ]);\r\n\r\n        try {\r\n            DB::beginTransaction();\r\n\r\n            $position = DB::table('positions')->insert([\r\n                'name' => $request->name,\r\n                'department_id' => $request->department_id,\r\n                'duties' => $request->duties ?? null,\r\n            ]);\r\n\r\n            DB::commit();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Yangi lavozim qo‘shildi',\r\n                'create',\r\n                null,\r\n                $position\r\n            );\r\n\r\n            return response()->json(['status' => 'success', 'message' => 'Lavozim muvaffaqiyatli qo‘shildi'], 201);\r\n        } catch (\\Exception $e) {\r\n            DB::rollBack();\r\n            return response()->json(['status' => 'error', 'message' => 'Lavozimni qo‘shishda xatolik: ' . $e->getMessage()], 500);\r\n        }\r\n    }\r\n\r\n    public function updatePositions(Request $request, $id): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $request->validate([\r\n            'name' => 'required|string|max:255',\r\n            'duties' => 'nullable|string',\r\n        ]);\r\n\r\n        try {\r\n            DB::beginTransaction();\r\n\r\n            $position = DB::table('positions')->where('id', $id)->update([\r\n                'name' => $request->name,\r\n                'department_id' => $request->department_id ?? null,\r\n                'duties' => $request->duties ?? null,\r\n            ]);\r\n\r\n            DB::commit();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Lavozim yangilandi',\r\n                'edit',\r\n                null,\r\n                $position\r\n            );\r\n\r\n            return response()->json(['status' => 'success', 'message' => 'Lavozim muvaffaqiyatli yangilandi'], 200);\r\n        } catch (\\Exception $e) {\r\n            DB::rollBack();\r\n            return response()->json(['status' => 'error', 'message' => 'Lavozimni yangilashda xatolik: ' . $e->getMessage()], 500);\r\n        }\r\n    }\r\n\r\n    public function getDepartments(): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        try {\r\n            $departments = MainDepartment::where('branch_id', auth()->user()->employee->branch_id)\r\n                ->with(\r\n                    'departments',\r\n                    'departments.groups',\r\n                    'departments.groups.responsibleUser',\r\n                )\r\n                ->get();\r\n            return response()->json($departments, 200);\r\n        } catch (\\Exception $e) {\r\n            return response()->json(['status' => 'error', 'message' => 'Bo‘limlarni olishda xatolik: ' . $e->getMessage()], 500);\r\n        }\r\n    }\r\n\r\n    public function storeDepartments(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $request->validate([\r\n            'name' => 'required|string|max:255',\r\n            'responsible_user_id' => 'nullable|integer|exists:users,id',\r\n            'main_department_id' => 'nullable|integer|exists:main_department,id',\r\n            'start_time' => 'nullable|date_format:H:i',\r\n            'end_time' => 'nullable|date_format:H:i',\r\n            'break_time' => 'nullable|integer|min:0',\r\n            'groups' => 'nullable|array',\r\n            'groups.*.name' => 'required|string|max:255',\r\n            'groups.*.responsible_user_id' => 'nullable|integer|exists:users,id',\r\n        ]);\r\n\r\n        try {\r\n            DB::beginTransaction();\r\n\r\n            $department = Department::create([\r\n                'name' => $request->name,\r\n                'branch_id' => auth()->user()->employee->branch_id,\r\n                'responsible_user_id' => $request->responsible_user_id ?? null,\r\n                'main_department_id' => $request->main_department_id ?? null,\r\n                'start_time' => $request->start_time ?? \"07:30:00\",\r\n                'end_time' => $request->end_time ?? \"17:30:00\",\r\n                'break_time' => $request->break_time ?? 0,\r\n            ]);\r\n\r\n            if ($request->filled('groups')) {\r\n                foreach ($request->groups as $groupData) {\r\n                    $department->groups()->create([\r\n                        'name' => $groupData['name'],\r\n                        'department_id' => $department->id,\r\n                        'responsible_user_id' => $groupData['responsible_user_id'] ?? 1,\r\n                    ]);\r\n                }\r\n            }\r\n\r\n            DB::commit();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Yangi bo‘lim va guruhlari qo‘shildi',\r\n                'create',\r\n                null,\r\n                $department->load('groups')->toArray()\r\n            );\r\n\r\n            return response()->json([\r\n                'status' => 'success',\r\n                'message' => 'Bo‘lim va guruhlari muvaffaqiyatli qo‘shildi',\r\n                'department' => $department->load('groups')\r\n            ], 201);\r\n        } catch (\\Exception $e) {\r\n            DB::rollBack();\r\n            return response()->json([\r\n                'status' => 'error',\r\n                'message' => 'Bo‘limni qo‘shishda xatolik: ' . $e->getMessage()\r\n            ], 500);\r\n        }\r\n    }\r\n\r\n    public function updateDepartments(Request $request, $id): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $request->validate([\r\n            'name' => 'required|string|max:255',\r\n            'responsible_user_id' => 'sometimes|integer|exists:users,id',\r\n            'main_department_id' => 'sometimes|integer|exists:main_department,id',\r\n            'start_time' => 'sometimes|date_format:H:i',\r\n            'end_time' => 'sometimes|date_format:H:i',\r\n            'break_time' => 'sometimes|integer|min:0',\r\n            'groups' => 'nullable|array',\r\n            'groups.*.name' => 'required|string|max:255',\r\n            'groups.*.id' => 'nullable|integer|exists:groups,id',\r\n            'groups.*.responsible_user_id' => 'nullable|integer|exists:users,id',\r\n        ]);\r\n\r\n        try {\r\n            DB::beginTransaction();\r\n\r\n            $department = Department::findOrFail($id);\r\n            $oldData = $department->load('groups')->toArray();\r\n\r\n            $department->update([\r\n                'name' => $request->name,\r\n                'responsible_user_id' => $request->responsible_user_id ?? $department->responsible_user_id,\r\n                'main_department_id' => $request->main_department_id ?? $department->main_department_id,\r\n                'start_time' => $request->start_time ?? $department->start_time,\r\n                'end_time' => $request->end_time ?? $department->end_time,\r\n                'break_time' => $request->break_time ?? $department->break_time,\r\n                'branch_id' => auth()->user()->employee->branch_id,\r\n            ]);\r\n\r\n            if ($request->filled('groups')) {\r\n                foreach ($request->groups as $groupData) {\r\n                    if (!empty($groupData['id'])) {\r\n                        // Update existing group\r\n                        $group = $department->groups()->where('id', $groupData['id'])->first();\r\n                        if ($group) {\r\n                            $group->update([\r\n                                'name' => $groupData['name'],\r\n                                'responsible_user_id' => $groupData['responsible_user_id'] ?? $group->responsible_user_id,\r\n                            ]);\r\n                        }\r\n                    } else {\r\n                        // Create new group\r\n                        $department->groups()->create([\r\n                            'name' => $groupData['name'],\r\n                            'responsible_user_id' => $groupData['responsible_user_id'] ?? 1,\r\n                        ]);\r\n                    }\r\n                }\r\n            }\r\n\r\n            DB::commit();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Bo‘lim va guruhlari yangilandi',\r\n                'edit',\r\n                $oldData,\r\n                $department->load('groups')->toArray()\r\n            );\r\n\r\n            return response()->json([\r\n                'status' => 'success',\r\n                'message' => 'Bo‘lim muvaffaqiyatli yangilandi',\r\n                'department' => $department->load('groups')\r\n            ], 200);\r\n        } catch (\\Exception $e) {\r\n            DB::rollBack();\r\n            return response()->json([\r\n                'status' => 'error',\r\n                'message' => 'Bo‘limni yangilashda xatolik: ' . $e->getMessage()\r\n            ], 500);\r\n        }\r\n    }\r\n\r\n    public function resetPassword($id): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        try {\r\n            $employee = Employee::findOrFail($id);\r\n\r\n            $user = User::findOrFail($employee->user_id);\r\n\r\n            $user->password = $this->hashPassword($employee->phone);\r\n\r\n            $user->save();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Parol tiklandi',\r\n                'edit',\r\n                null,\r\n                $user\r\n            );\r\n\r\n            return response()->json(['status' => 'success', 'message' => 'Parol tiklandi'], 200);\r\n        } catch (\\Exception $e) {\r\n            return response()->json(['status' => 'error', 'message' => 'Parolni tiklashda xatolik: ' . $e->getMessage()], 500);\r\n        }\r\n    }\r\n\r\n    public function getLids(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $request->validate([\r\n            'search' => 'nullable|string|max:255',\r\n            'status' => 'nullable|string|in:active,inactive',\r\n        ]);\r\n\r\n        $query = Lid::where('branch_id', auth()->user()->employee->branch_id);\r\n\r\n        if ($request->filled('search')) {\r\n            $search = strtolower($request->search);\r\n            $query->where(function ($q) use ($search) {\r\n                $q->whereRaw('LOWER(name) LIKE ?', [\"%$search%\"])\r\n                    ->orWhereRaw('LOWER(phone) LIKE ?', [\"%$search%\"])\r\n                    ->orWhereRaw('LOWER(address) LIKE ?', [\"%$search%\"])\r\n                    ->orWhereRaw('LOWER(comment) LIKE ?', [\"%$search%\"]);\r\n            });\r\n        }\r\n\r\n        if ($request->filled('status')) {\r\n            $query->where('status', $request->status);\r\n        }\r\n\r\n        $lids = $query->orderByDesc('id')->paginate(10);\r\n\r\n        return response()->json($lids, 200);\r\n    }\r\n\r\n    public function storeLid(Request $request): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        $request->validate([\r\n            'name' => 'required|string|max:255',\r\n            'phone' => 'required|string|max:20',\r\n            'address' => 'nullable|string|max:255',\r\n            'comment' => 'nullable|string|max:500',\r\n            'birth_day' => 'nullable|date',\r\n            'image' => 'nullable|image|mimes:jpeg,png,jpg,gif|max:20480',\r\n        ]);\r\n\r\n\r\n        try {\r\n            DB::beginTransaction();\r\n\r\n            $lid = new Lid();\r\n            $lid->name = $request->name;\r\n            $lid->phone = $request->phone;\r\n            $lid->address = $request->address;\r\n            $lid->comment = $request->comment;\r\n            $lid->birth_day = $request->birth_day;\r\n            $lid->status = 'active';\r\n            $lid->branch_id = auth()->user()->employee->branch_id;\r\n\r\n            if ($request->hasFile('image')) {\r\n                $image = $request->file('image');\r\n                $fileName = time() . '_' . $image->getClientOriginalName();\r\n                $path = $image->storeAs('lids', $fileName, 's3');\r\n                Storage::disk('s3')->setVisibility($path, 'public');\r\n\r\n                $lid->image = Storage::disk('s3')->url($path);\r\n            }\r\n\r\n            $lid->save();\r\n\r\n            DB::commit();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Yangi lid qo‘shildi',\r\n                'create',\r\n                null,\r\n                $lid\r\n            );\r\n\r\n            return response()->json(['status' => 'success', 'message' => 'Lid muvaffaqiyatli qo‘shildi', 'lid' => $lid], 201);\r\n        } catch (\\Exception $e) {\r\n            DB::rollBack();\r\n            return response()->json(['status' => 'error', 'message' => 'Lidni qo‘shishda xatolik: ' . $e->getMessage()], 500);\r\n        }\r\n    }\r\n\r\n    public function updateLid(Request $request, $id): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        //PATH bo'lishi kerak\r\n        $request->validate([\r\n            'name' => 'sometimes|string|max:255',\r\n            'phone' => 'sometimes|string|max:20',\r\n            'address' => 'nullable|string|max:255',\r\n            'comment' => 'nullable|string|max:500',\r\n            'birth_day' => 'nullable|date',\r\n            'image' => 'nullable|image|mimes:jpeg,png,jpg,gif|max:20480',\r\n        ]);\r\n\r\n        try {\r\n            DB::beginTransaction();\r\n\r\n            $lid = Lid::findOrFail($id);\r\n            $oldData = $lid->toArray();\r\n\r\n            if ($request->hasFile('image')) {\r\n                $image = $request->file('image');\r\n                $fileName = time() . '_' . $image->getClientOriginalName();\r\n                $path = $image->storeAs('lids', $fileName, 's3');\r\n                Storage::disk('s3')->setVisibility($path, 'public');\r\n                $lid->image = Storage::disk('s3')->url($path);\r\n            }\r\n\r\n            $lid->name = $request->name ?? $lid->name;\r\n            $lid->phone = $request->phone ?? $lid->phone;\r\n            $lid->address = $request->address ?? $lid->address;\r\n            $lid->comment = $request->comment ?? $lid->comment;\r\n            $lid->birth_day = $request->birth_day ?? $lid->birth_day;\r\n\r\n            if ($request->has('status')) {\r\n                if ($request->status === 'active') {\r\n                    $lid->status = 'active';\r\n                } elseif ($request->status === 'inactive') {\r\n                    $lid->status = 'inactive';\r\n                }\r\n            }\r\n\r\n            $lid->save();\r\n\r\n            DB::commit();\r\n\r\n            Log::add(\r\n                auth()->user()->id,\r\n                'Lid yangilandi',\r\n                'edit',\r\n                $oldData,\r\n                $lid\r\n            );\r\n\r\n            return response()->json(['status' => 'success', 'message' => 'Lid muvaffaqiyatli yangilandi', 'lid' => $lid], 200);\r\n        } catch (\\Exception $e) {\r\n            DB::rollBack();\r\n            return response()->json(['status' => 'error', 'message' => 'Lidni yangilashda xatolik: ' . $e->getMessage()], 500);\r\n        }\r\n    }\r\n\r\n    public function showLid(Lid $lid): \\Illuminate\\Http\\JsonResponse\r\n    {\r\n        return response()->json($lid);\r\n    }\r\n\r\n    public function exportEmployeeAttendance(Request $request)\r\n    {\r\n        $request->validate([\r\n            'start_date' => 'required|date',\r\n            'end_date'   => 'required|date|after_or_equal:start_date',\r\n        ]);\r\n\r\n        $fileName = 'employee_attendance_' . now()->format('Y_m_d_His') . '.xlsx';\r\n\r\n        return Excel::download(\r\n            new EmployeeAttendanceExport($request->start_date, $request->end_date),\r\n            $fileName\r\n        );\r\n    }\r\n\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/Http/Controllers/SuperHRController.php b/app/Http/Controllers/SuperHRController.php
--- a/app/Http/Controllers/SuperHRController.php	(revision f68ea360d0ccc0cd5e8e17942d0740f3cb7f80c1)
+++ b/app/Http/Controllers/SuperHRController.php	(date 1763034557033)
@@ -1097,7 +1097,7 @@
                     'hiring_date' => $request->hiring_date ?? $employee->hiring_date,
                     'address' => $request->address ?? $employee->address,
                     'passport_number' => $request->passport_number ?? $employee->passport_number,
-                    'passport_code' => $request->passport_code ?? $employee->passport_code,
+                    'passport_code' => $request->filled('passport_code') ? $request->passport_code : $employee->passport_code,
                     'payment_type' => $request->payment_type ?? $employee->payment_type,
                     'comment' => $request->comment ?? $employee->comment,
                     'type' => $request->type ?? $employee->type,
@@ -1120,7 +1120,7 @@
                     'hiring_date' => $request->hiring_date ?? $employee->hiring_date,
                     'address' => $request->address ?? $employee->address,
                     'passport_number' => $request->passport_number ?? $employee->passport_number,
-                    'passport_code' => $request->passport_code ?? $employee->passport_code,
+                    'passport_code' => $request->filled('passport_code') ? $request->passport_code : $employee->passport_code,
                     'payment_type' => $request->payment_type ?? $employee->payment_type,
                     'comment' => $request->comment ?? $employee->comment,
                     'type' => $request->type ?? $employee->type,
Index: app/Models/Employee.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?php\r\n\r\nnamespace App\\Models;\r\n\r\nuse Illuminate\\Database\\Eloquent\\Factories\\HasFactory;\r\nuse Illuminate\\Database\\Eloquent\\Model;\r\n\r\n/**\r\n * @method static whereIn(string $string, $groupIds)\r\n * @method static find($id)\r\n * @method static findOrFail($id)\r\n * @method static where(string $string, mixed $departmentId)\r\n * @property mixed $payment_type\r\n */\r\nclass Employee extends Model\r\n{\r\n    use HasFactory;\r\n\r\n    protected $table = 'employees';\r\n\r\n    protected $fillable = [\r\n        'name',\r\n        'phone',\r\n        'group_id',\r\n        'user_id',\r\n        'payment_type',\r\n        'salary',\r\n        'hiring_date',\r\n        'status',\r\n        'address',\r\n        'passport_number',\r\n        'branch_id',\r\n        'type',\r\n        'salary',\r\n        'birthday',\r\n        'img',\r\n        'position_id',\r\n        'department_id',\r\n        'comment',\r\n        'gender',\r\n        'kicked_date',\r\n        'balance',\r\n        'bonus',\r\n        'salary_visible',\r\n        'percentage'\r\n    ];\r\n\r\n    public function getImgAttribute($value): \\Illuminate\\Foundation\\Application|string|\\Illuminate\\Contracts\\Routing\\UrlGenerator|\\Illuminate\\Contracts\\Foundation\\Application|null\r\n    {\r\n        if (empty($value)) {\r\n            return null;\r\n        }\r\n\r\n        if (filter_var($value, FILTER_VALIDATE_URL)) {\r\n            return $value;\r\n        }\r\n\r\n        return url('storage/' . $value);\r\n    }\r\n\r\n    public function department(): \\Illuminate\\Database\\Eloquent\\Relations\\BelongsTo\r\n    {\r\n        return $this->belongsTo(Department::class, 'department_id');\r\n    }\r\n\r\n    public function group(): \\Illuminate\\Database\\Eloquent\\Relations\\BelongsTo\r\n    {\r\n        return $this->belongsTo(Group::class, 'group_id');\r\n    }\r\n\r\n    public function user(): \\Illuminate\\Database\\Eloquent\\Relations\\BelongsTo\r\n    {\r\n        return $this->belongsTo(User::class, 'user_id');\r\n    }\r\n\r\n    public function attendances(): \\Illuminate\\Database\\Eloquent\\Relations\\HasMany\r\n    {\r\n        return $this->hasMany(Attendance::class);\r\n    }\r\n\r\n    public function tarifications(): \\Illuminate\\Database\\Eloquent\\Relations\\HasMany\r\n    {\r\n        return $this->hasMany(Tarification::class, 'user_id');\r\n    }\r\n\r\n    public function branch(): \\Illuminate\\Database\\Eloquent\\Relations\\BelongsTo\r\n    {\r\n        return $this->belongsTo(Branch::class);\r\n    }\r\n\r\n    public function position(): \\Illuminate\\Database\\Eloquent\\Relations\\BelongsTo\r\n    {\r\n        return $this->belongsTo(Position::class);\r\n    }\r\n\r\n    public function stockEntries(): \\Illuminate\\Database\\Eloquent\\Relations\\HasMany\r\n    {\r\n        return $this->hasMany(StockEntry::class, 'user_id');\r\n    }\r\n\r\n    public function attendanceSalaries(): \\Illuminate\\Database\\Eloquent\\Relations\\HasMany\r\n    {\r\n        return $this->hasMany(AttendanceSalary::class, 'employee_id');\r\n    }\r\n\r\n    public function employeeTarificationLogs(): \\Illuminate\\Database\\Eloquent\\Relations\\HasMany\r\n    {\r\n        return $this->hasMany(EmployeeTarificationLog::class, 'employee_id');\r\n    }\r\n\r\n    public function salaryPayments(): \\Illuminate\\Database\\Eloquent\\Relations\\HasMany\r\n    {\r\n        return $this->hasMany(SalaryPayment::class);\r\n    }\r\n\r\n    public function employeeResults(): \\Illuminate\\Database\\Eloquent\\Relations\\HasMany\r\n    {\r\n        return $this->hasMany(EmployeeResult::class);\r\n    }\r\n\r\n    public function filteredTarifications($allowedIds): \\Illuminate\\Database\\Eloquent\\Relations\\HasMany\r\n    {\r\n        return $this->tarifications()->whereIn('tarifications.id', $allowedIds);\r\n    }\r\n\r\n    public function employeeHolidays(): \\Illuminate\\Database\\Eloquent\\Relations\\HasMany\r\n    {\r\n        return $this->hasMany(EmployeeHolidays::class, 'employee_id');\r\n    }\r\n\r\n    public function employeeAbsences(): \\Illuminate\\Database\\Eloquent\\Relations\\HasMany\r\n    {\r\n        return $this->hasMany(EmployeeAbsence::class, 'employee_id');\r\n    }\r\n\r\n    public function employeeSalaries(): \\Illuminate\\Database\\Eloquent\\Relations\\HasMany\r\n    {\r\n        return $this->hasMany(EmployeeSalary::class, 'employee_id');\r\n    }\r\n\r\n    public function transports()\r\n    {\r\n        return $this->belongsToMany(Transport::class, 'employee_transport');\r\n    }\r\n\r\n    public function dailyTransports()\r\n    {\r\n        return $this->hasMany(EmployeeTransportDaily::class);\r\n    }\r\n\r\n    public function monthlySalaries()\r\n    {\r\n        return $this->hasMany(EmployeeMonthlySalary::class);\r\n    }\r\n\r\n    public function monthlyPieceworks()\r\n    {\r\n        return $this->hasMany(EmployeeMonthlyPiecework::class);\r\n    }\r\n\r\n    public function salaryChanges()\r\n    {\r\n        return $this->hasMany(SalaryChange::class);    \r\n    }\r\n\r\n    public function groupChanges()\r\n    {\r\n        return $this->hasMany(GroupChange::class);    \r\n    }\r\n\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/Models/Employee.php b/app/Models/Employee.php
--- a/app/Models/Employee.php	(revision f68ea360d0ccc0cd5e8e17942d0740f3cb7f80c1)
+++ b/app/Models/Employee.php	(date 1763034557038)
@@ -42,7 +42,8 @@
         'balance',
         'bonus',
         'salary_visible',
-        'percentage'
+        'percentage',
+        'passport_code'
     ];
 
     public function getImgAttribute($value): \Illuminate\Foundation\Application|string|\Illuminate\Contracts\Routing\UrlGenerator|\Illuminate\Contracts\Foundation\Application|null
Index: .idea/workspace.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<project version=\"4\">\r\n  <component name=\"AutoImportSettings\">\r\n    <option name=\"autoReloadType\" value=\"SELECTIVE\" />\r\n  </component>\r\n  <component name=\"ChangeListManager\">\r\n    <list default=\"true\" id=\"6d7ca805-b105-4f4e-beb7-ef93e65f0a7f\" name=\"Changes\" comment=\"fix: correct join column name in sewing outputs query\">\r\n      <change beforePath=\"$PROJECT_DIR$/.idea/workspace.xml\" beforeDir=\"false\" afterPath=\"$PROJECT_DIR$/.idea/workspace.xml\" afterDir=\"false\" />\r\n      <change beforePath=\"$PROJECT_DIR$/app/Http/Controllers/CasherController.php\" beforeDir=\"false\" afterPath=\"$PROJECT_DIR$/app/Http/Controllers/CasherController.php\" afterDir=\"false\" />\r\n    </list>\r\n    <option name=\"SHOW_DIALOG\" value=\"false\" />\r\n    <option name=\"HIGHLIGHT_CONFLICTS\" value=\"true\" />\r\n    <option name=\"HIGHLIGHT_NON_ACTIVE_CHANGELIST\" value=\"false\" />\r\n    <option name=\"LAST_RESOLUTION\" value=\"IGNORE\" />\r\n  </component>\r\n  <component name=\"ComposerSettings\" synchronizationState=\"SYNCHRONIZE\">\r\n    <pharConfigPath>$PROJECT_DIR$/composer.json</pharConfigPath>\r\n    <execution>\r\n      <executable path=\"composer\" />\r\n    </execution>\r\n  </component>\r\n  <component name=\"Git.Settings\">\r\n    <option name=\"PUSH_AUTO_UPDATE\" value=\"true\" />\r\n    <option name=\"RECENT_GIT_ROOT_PATH\" value=\"$PROJECT_DIR$\" />\r\n  </component>\r\n  <component name=\"GitHubPullRequestSearchHistory\">{\r\n  &quot;lastFilter&quot;: {\r\n    &quot;state&quot;: &quot;OPEN&quot;,\r\n    &quot;assignee&quot;: &quot;Jamxon&quot;\r\n  }\r\n}</component>\r\n  <component name=\"GithubPullRequestsUISettings\">{\r\n  &quot;selectedUrlAndAccountId&quot;: {\r\n    &quot;accountId&quot;: &quot;5ba2bb65-faaf-4020-a7a3-dfbf96b21db6&quot;\r\n  }\r\n}</component>\r\n  <component name=\"HighlightingSettingsPerFile\">\r\n    <setting file=\"file://$PROJECT_DIR$/app/Http/Controllers/ItemController.php\" root0=\"FORCE_HIGHLIGHTING\" root1=\"FORCE_HIGHLIGHTING\" />\r\n    <setting file=\"file://$PROJECT_DIR$/app/Http/Controllers/OrderController.php\" root0=\"FORCE_HIGHLIGHTING\" root1=\"FORCE_HIGHLIGHTING\" />\r\n    <setting file=\"file://$PROJECT_DIR$/app/Http/Controllers/ResultCheckerController.php\" root0=\"FORCE_HIGHLIGHTING\" root1=\"FORCE_HIGHLIGHTING\" />\r\n    <setting file=\"file://$PROJECT_DIR$/routes/api.php\" root0=\"FORCE_HIGHLIGHTING\" root1=\"FORCE_HIGHLIGHTING\" />\r\n  </component>\r\n  <component name=\"PackageJsonUpdateNotifier\">\r\n    <dismissed value=\"$PROJECT_DIR$/package.json\" />\r\n  </component>\r\n  <component name=\"PhpDebugGeneral\" listening_started=\"true\" />\r\n  <component name=\"PhpWorkspaceProjectConfiguration\" interpreter_name=\"$PROJECT_DIR$/../php/php.exe\">\r\n    <include_path>\r\n      <path value=\"$PROJECT_DIR$/vendor/doctrine/cache\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/doctrine/lexer\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/doctrine/dbal\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/doctrine/inflector\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/doctrine/annotations\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/doctrine/event-manager\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/doctrine/deprecations\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/fakerphp/faker\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/hamcrest/hamcrest-php\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/lcobucci/jwt\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/lcobucci/clock\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/carbonphp/carbon-doctrine-types\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/fruitcake/php-cors\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/maennchen/zipstream-php\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/markbaker/complex\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/markbaker/matrix\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/phpoffice/phpspreadsheet\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/phpoption/phpoption\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/ralouphie/getallheaders\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/comparator\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/global-state\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/object-enumerator\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/object-reflector\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/complexity\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/code-unit-reverse-lookup\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/diff\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/recursion-context\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/lines-of-code\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/type\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/version\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/cli-parser\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/code-unit\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/environment\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sebastian/exporter\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/webmozart/assert\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/guzzlehttp/uri-template\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/guzzlehttp/promises\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/guzzlehttp/psr7\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/guzzlehttp/guzzle\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/nunomaduro/termwind\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/nunomaduro/collision\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/darkaonline/l5-swagger\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/maatwebsite/excel\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/swagger-api/swagger-ui\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/tijsverkoyen/css-to-inline-styles\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/dragonmantank/cron-expression\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/graham-campbell/result-type\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/composer\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/psr/cache\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/psr/event-dispatcher\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/psr/http-message\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/psr/container\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/psr/http-client\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/psr/log\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/psr/simple-cache\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/psr/clock\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/psr/http-factory\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/psy/psysh\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/filp/whoops\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/voku/portable-ascii\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/brick/math\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/nette/utils\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/nette/schema\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/nikic/php-parser\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/tymon/jwt-auth\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/ezyang/htmlpurifier\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/league/mime-type-detection\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/league/flysystem-local\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/league/config\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/league/flysystem\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/league/commonmark\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/nesbot/carbon\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/ramsey/collection\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/ramsey/uuid\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/vlucas/phpdotenv\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/dflydev/dot-access-data\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/egulias/email-validator\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/laravel/pint\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/laravel/tinker\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/laravel/framework\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/laravel/serializable-closure\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/laravel/sanctum\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/laravel/sail\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/laravel/prompts\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/mockery/mockery\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/monolog/monolog\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/myclabs/deep-copy\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/phar-io/manifest\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/phar-io/version\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/phpunit/php-timer\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/phpunit/phpunit\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/phpunit/php-text-template\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/phpunit/php-code-coverage\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/phpunit/php-invoker\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/phpunit/php-file-iterator\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/polyfill-php80\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/polyfill-ctype\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/translation\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/translation-contracts\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/uid\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/event-dispatcher\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/var-dumper\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/mailer\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/polyfill-intl-idn\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/polyfill-uuid\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/polyfill-intl-normalizer\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/css-selector\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/event-dispatcher-contracts\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/finder\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/polyfill-php83\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/http-kernel\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/yaml\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/mime\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/string\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/deprecation-contracts\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/routing\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/service-contracts\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/http-foundation\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/error-handler\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/process\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/console\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/polyfill-mbstring\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/polyfill-intl-grapheme\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/theseer/tokenizer\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/zircote/swagger-php\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/spatie/flare-client-php\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/spatie/backtrace\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/spatie/error-solutions\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/spatie/ignition\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/spatie/laravel-ignition\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/spatie/data-transfer-object\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/erusev/parsedown\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/shalvah/clara\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/shalvah/upgrader\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/knuckleswtf/scribe\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/symfony/var-exporter\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/mpociot/reflection-docblock\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/dompdf/php-svg-lib\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/masterminds/html5\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/dompdf/php-font-lib\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/dompdf/dompdf\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sabberworm/php-css-parser\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/barryvdh/laravel-dompdf\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/dompdf/dompdf 2\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/barryvdh/laravel-dompdf 2\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/dompdf/php-font-lib 2\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/masterminds/html5 2\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/dompdf/php-svg-lib 2\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/sabberworm/php-css-parser 2\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/milon/barcode\" />\r\n      <path value=\"$PROJECT_DIR$/vendor/_laravel_idea\" />\r\n    </include_path>\r\n  </component>\r\n  <component name=\"ProblemsViewState\">\r\n    <option name=\"selectedTabId\" value=\"CurrentFile\" />\r\n    <option name=\"showPreview\" value=\"true\" />\r\n  </component>\r\n  <component name=\"ProjectColorInfo\">{\r\n  &quot;associatedIndex&quot;: 2\r\n}</component>\r\n  <component name=\"ProjectId\" id=\"2pULeBqwNrNnim6YmZ67tyqrkXt\" />\r\n  <component name=\"ProjectLevelVcsManager\">\r\n    <ConfirmationsSetting value=\"2\" id=\"Add\" />\r\n  </component>\r\n  <component name=\"ProjectViewState\">\r\n    <option name=\"hideEmptyMiddlePackages\" value=\"true\" />\r\n    <option name=\"showLibraryContents\" value=\"true\" />\r\n  </component>\r\n  <component name=\"PropertiesComponent\">{\r\n  &quot;keyToString&quot;: {\r\n    &quot;ModuleVcsDetector.initialDetectionPerformed&quot;: &quot;true&quot;,\r\n    &quot;PHPUnit.Main.executor&quot;: &quot;Debug&quot;,\r\n    &quot;RunOnceActivity.ShowReadmeOnStart&quot;: &quot;true&quot;,\r\n    &quot;RunOnceActivity.TerminalTabsStorage.copyFrom.TerminalArrangementManager&quot;: &quot;true&quot;,\r\n    &quot;RunOnceActivity.TerminalTabsStorage.copyFrom.TerminalArrangementManager.252&quot;: &quot;true&quot;,\r\n    &quot;RunOnceActivity.git.unshallow&quot;: &quot;true&quot;,\r\n    &quot;com.intellij.ml.llm.matterhorn.ej.ui.settings.DefaultAutoModeForALLUsers.v1&quot;: &quot;true&quot;,\r\n    &quot;com.intellij.ml.llm.matterhorn.ej.ui.settings.DefaultModelSelectionForGA.v1&quot;: &quot;true&quot;,\r\n    &quot;com.laravel_idea.eloquent_global_unguard&quot;: &quot;0&quot;,\r\n    &quot;database.data.extractors.current.export.id&quot;: &quot;Excel (xlsx)&quot;,\r\n    &quot;database.data.extractors.current.id&quot;: &quot;CSV-Groovy.csv.groovy&quot;,\r\n    &quot;git-widget-placeholder&quot;: &quot;main&quot;,\r\n    &quot;ignore.virus.scanning.warn.message&quot;: &quot;true&quot;,\r\n    &quot;junie.onboarding.icon.badge.shown&quot;: &quot;true&quot;,\r\n    &quot;last_opened_file_path&quot;: &quot;C:/Users/BEK/Desktop/VizzanoERP&quot;,\r\n    &quot;node.js.detected.package.eslint&quot;: &quot;true&quot;,\r\n    &quot;node.js.detected.package.tslint&quot;: &quot;true&quot;,\r\n    &quot;node.js.selected.package.eslint&quot;: &quot;(autodetect)&quot;,\r\n    &quot;node.js.selected.package.tslint&quot;: &quot;(autodetect)&quot;,\r\n    &quot;nodejs_package_manager_path&quot;: &quot;npm&quot;,\r\n    &quot;php.override.implement.member.chooser.php.doc&quot;: &quot;NONE&quot;,\r\n    &quot;settings.editor.selected.configurable&quot;: &quot;terminal&quot;,\r\n    &quot;to.speed.mode.migration.done&quot;: &quot;true&quot;,\r\n    &quot;vue.rearranger.settings.migration&quot;: &quot;true&quot;\r\n  },\r\n  &quot;keyToStringList&quot;: {\r\n    &quot;DatabaseDriversLRU&quot;: [\r\n      &quot;postgresql&quot;\r\n    ]\r\n  }\r\n}</component>\r\n  <component name=\"RecentsManager\">\r\n    <key name=\"CopyFile.RECENT_KEYS\">\r\n      <recent name=\"$PROJECT_DIR$/storage/fonts\" />\r\n      <recent name=\"$PROJECT_DIR$/public/images\" />\r\n      <recent name=\"$PROJECT_DIR$/public/storage\" />\r\n    </key>\r\n    <key name=\"MoveFile.RECENT_KEYS\">\r\n      <recent name=\"D:\\PHP\\VizzanoERP\\app\\Http\\Controllers\" />\r\n      <recent name=\"$PROJECT_DIR$/app/Models\" />\r\n      <recent name=\"$PROJECT_DIR$/public/storage/images\" />\r\n    </key>\r\n  </component>\r\n  <component name=\"RunManager\">\r\n    <configuration name=\"Main\" type=\"PHPUnitRunConfigurationType\" factoryName=\"PHPUnit\">\r\n      <TestRunner configuration_file=\"$PROJECT_DIR$/phpunit.xml\" scope=\"XML\" use_alternative_configuration_file=\"true\" />\r\n      <method v=\"2\" />\r\n    </configuration>\r\n  </component>\r\n  <component name=\"SharedIndexes\">\r\n    <attachedChunks>\r\n      <set>\r\n        <option value=\"bundled-js-predefined-d6986cc7102b-3aa1da707db6-JavaScript-PS-252.27397.112\" />\r\n        <option value=\"bundled-php-predefined-a98d8de5180a-b35feea871ed-com.jetbrains.php.sharedIndexes-PS-252.27397.112\" />\r\n      </set>\r\n    </attachedChunks>\r\n  </component>\r\n  <component name=\"SpellCheckerSettings\" RuntimeDictionaries=\"0\" Folders=\"0\" CustomDictionaries=\"0\" DefaultDictionary=\"application-level\" UseSingleDictionary=\"true\" transferred=\"true\" />\r\n  <component name=\"TaskManager\">\r\n    <task active=\"true\" id=\"Default\" summary=\"Default task\">\r\n      <changelist id=\"6d7ca805-b105-4f4e-beb7-ef93e65f0a7f\" name=\"Changes\" comment=\"\" />\r\n      <created>1732815799814</created>\r\n      <option name=\"number\" value=\"Default\" />\r\n      <option name=\"presentableId\" value=\"Default\" />\r\n      <updated>1732815799814</updated>\r\n      <workItem from=\"1732815801672\" duration=\"5647000\" />\r\n      <workItem from=\"1732871828931\" duration=\"1619000\" />\r\n      <workItem from=\"1732873980745\" duration=\"12558000\" />\r\n      <workItem from=\"1732893188742\" duration=\"2422000\" />\r\n      <workItem from=\"1732939540663\" duration=\"14313000\" />\r\n      <workItem from=\"1732958480231\" duration=\"4900000\" />\r\n      <workItem from=\"1732964191867\" duration=\"7000\" />\r\n      <workItem from=\"1732964204777\" duration=\"18064000\" />\r\n      <workItem from=\"1733030916314\" duration=\"44644000\" />\r\n      <workItem from=\"1733227874625\" duration=\"4706000\" />\r\n      <workItem from=\"1733370100289\" duration=\"26152000\" />\r\n      <workItem from=\"1733551514192\" duration=\"17000\" />\r\n      <workItem from=\"1733551537372\" duration=\"26586000\" />\r\n      <workItem from=\"1733638388154\" duration=\"30643000\" />\r\n      <workItem from=\"1733718278133\" duration=\"24870000\" />\r\n      <workItem from=\"1733919347046\" duration=\"37415000\" />\r\n      <workItem from=\"1734085017237\" duration=\"14188000\" />\r\n      <workItem from=\"1734156357945\" duration=\"13505000\" />\r\n      <workItem from=\"1734242461603\" duration=\"35806000\" />\r\n      <workItem from=\"1734328184413\" duration=\"9952000\" />\r\n      <workItem from=\"1734343199733\" duration=\"8393000\" />\r\n      <workItem from=\"1734445721131\" duration=\"29941000\" />\r\n      <workItem from=\"1734620569531\" duration=\"48667000\" />\r\n      <workItem from=\"1734880852297\" duration=\"169000\" />\r\n      <workItem from=\"1734881030137\" duration=\"80000\" />\r\n      <workItem from=\"1734881117240\" duration=\"123249000\" />\r\n      <workItem from=\"1735464297693\" duration=\"27453000\" />\r\n      <workItem from=\"1735892543609\" duration=\"285185000\" />\r\n      <workItem from=\"1737451183299\" duration=\"44502000\" />\r\n      <workItem from=\"1737627437272\" duration=\"4149000\" />\r\n      <workItem from=\"1737691796794\" duration=\"5358000\" />\r\n      <workItem from=\"1737698058134\" duration=\"58515000\" />\r\n      <workItem from=\"1738136394804\" duration=\"7306000\" />\r\n      <workItem from=\"1738150229098\" duration=\"38000\" />\r\n      <workItem from=\"1738150275701\" duration=\"24020000\" />\r\n      <workItem from=\"1738316004127\" duration=\"14347000\" />\r\n      <workItem from=\"1738644612505\" duration=\"401000\" />\r\n      <workItem from=\"1738645050807\" duration=\"12035000\" />\r\n      <workItem from=\"1738921667722\" duration=\"534000\" />\r\n      <workItem from=\"1738922218127\" duration=\"170439000\" />\r\n      <workItem from=\"1739815357912\" duration=\"598000\" />\r\n      <workItem from=\"1739939018318\" duration=\"41436000\" />\r\n      <workItem from=\"1740248217686\" duration=\"418000\" />\r\n      <workItem from=\"1740469185556\" duration=\"6530000\" />\r\n      <workItem from=\"1740659759337\" duration=\"3567000\" />\r\n      <workItem from=\"1740663338010\" duration=\"50000\" />\r\n      <workItem from=\"1740663405658\" duration=\"8086000\" />\r\n      <workItem from=\"1740735187737\" duration=\"16683000\" />\r\n      <workItem from=\"1741766048451\" duration=\"4659000\" />\r\n      <workItem from=\"1741855404878\" duration=\"301000\" />\r\n      <workItem from=\"1741855748226\" duration=\"1486000\" />\r\n      <workItem from=\"1741941474763\" duration=\"5433000\" />\r\n      <workItem from=\"1741954676932\" duration=\"58989000\" />\r\n      <workItem from=\"1743138246243\" duration=\"41861000\" />\r\n      <workItem from=\"1743510169755\" duration=\"230908000\" />\r\n      <workItem from=\"1744443741471\" duration=\"61765000\" />\r\n      <workItem from=\"1744813142360\" duration=\"790000\" />\r\n      <workItem from=\"1744870055538\" duration=\"809000\" />\r\n      <workItem from=\"1744871038796\" duration=\"8465000\" />\r\n      <workItem from=\"1744951228255\" duration=\"1192000\" />\r\n      <workItem from=\"1744952470574\" duration=\"21783000\" />\r\n      <workItem from=\"1745038653694\" duration=\"30962000\" />\r\n      <workItem from=\"1745222272471\" duration=\"11000\" />\r\n      <workItem from=\"1745222297650\" duration=\"26560000\" />\r\n      <workItem from=\"1745303207118\" duration=\"44297000\" />\r\n      <workItem from=\"1745485070343\" duration=\"75179000\" />\r\n      <workItem from=\"1745916228550\" duration=\"117733000\" />\r\n      <workItem from=\"1746869349673\" duration=\"33665000\" />\r\n      <workItem from=\"1747650677313\" duration=\"45401000\" />\r\n      <workItem from=\"1747805735328\" duration=\"85348000\" />\r\n      <workItem from=\"1748085734900\" duration=\"18000\" />\r\n      <workItem from=\"1748085763506\" duration=\"10129000\" />\r\n      <workItem from=\"1748929470653\" duration=\"19581000\" />\r\n      <workItem from=\"1749008089755\" duration=\"2982000\" />\r\n      <workItem from=\"1749012396751\" duration=\"17372000\" />\r\n      <workItem from=\"1749039244580\" duration=\"98000\" />\r\n      <workItem from=\"1749039358773\" duration=\"8619000\" />\r\n      <workItem from=\"1749095537237\" duration=\"9790000\" />\r\n      <workItem from=\"1749370347161\" duration=\"10114000\" />\r\n      <workItem from=\"1749382139867\" duration=\"4422000\" />\r\n      <workItem from=\"1749387605241\" duration=\"1606000\" />\r\n      <workItem from=\"1749443010392\" duration=\"21336000\" />\r\n      <workItem from=\"1749528590888\" duration=\"11233000\" />\r\n      <workItem from=\"1749549408089\" duration=\"1150000\" />\r\n      <workItem from=\"1749550589141\" duration=\"13025000\" />\r\n      <workItem from=\"1749614493650\" duration=\"1548000\" />\r\n      <workItem from=\"1749629603254\" duration=\"6560000\" />\r\n      <workItem from=\"1749644433774\" duration=\"3442000\" />\r\n      <workItem from=\"1749702180705\" duration=\"6311000\" />\r\n      <workItem from=\"1749717110025\" duration=\"1664000\" />\r\n      <workItem from=\"1749720750062\" duration=\"12000\" />\r\n      <workItem from=\"1749721045215\" duration=\"23000\" />\r\n      <workItem from=\"1749790147274\" duration=\"127000\" />\r\n      <workItem from=\"1749795627660\" duration=\"68000\" />\r\n      <workItem from=\"1749795785216\" duration=\"607000\" />\r\n      <workItem from=\"1749809534077\" duration=\"12577000\" />\r\n      <workItem from=\"1749873632137\" duration=\"15816000\" />\r\n      <workItem from=\"1750047278709\" duration=\"20720000\" />\r\n      <workItem from=\"1750131005853\" duration=\"19487000\" />\r\n      <workItem from=\"1750221634660\" duration=\"7862000\" />\r\n      <workItem from=\"1750305899667\" duration=\"19360000\" />\r\n      <workItem from=\"1750392497866\" duration=\"20029000\" />\r\n      <workItem from=\"1750427572972\" duration=\"288000\" />\r\n      <workItem from=\"1750478676942\" duration=\"19056000\" />\r\n      <workItem from=\"1750506843742\" duration=\"1274000\" />\r\n      <workItem from=\"1750650436924\" duration=\"23353000\" />\r\n      <workItem from=\"1750741289727\" duration=\"14461000\" />\r\n      <workItem from=\"1750824048570\" duration=\"16212000\" />\r\n      <workItem from=\"1750911476513\" duration=\"8486000\" />\r\n      <workItem from=\"1750997346621\" duration=\"12577000\" />\r\n      <workItem from=\"1751084029479\" duration=\"3709000\" />\r\n      <workItem from=\"1751087818667\" duration=\"13824000\" />\r\n      <workItem from=\"1751255793996\" duration=\"9457000\" />\r\n      <workItem from=\"1751277219377\" duration=\"3088000\" />\r\n      <workItem from=\"1751343592281\" duration=\"12588000\" />\r\n      <workItem from=\"1751432833774\" duration=\"32026000\" />\r\n      <workItem from=\"1751517131245\" duration=\"13508000\" />\r\n      <workItem from=\"1751602589172\" duration=\"16369000\" />\r\n      <workItem from=\"1751688620067\" duration=\"17670000\" />\r\n      <workItem from=\"1751863286087\" duration=\"14260000\" />\r\n      <workItem from=\"1751952279529\" duration=\"8382000\" />\r\n      <workItem from=\"1752032799117\" duration=\"16055000\" />\r\n      <workItem from=\"1752121381931\" duration=\"19264000\" />\r\n      <workItem from=\"1752207734715\" duration=\"9325000\" />\r\n      <workItem from=\"1752294056668\" duration=\"7108000\" />\r\n      <workItem from=\"1752467143431\" duration=\"17066000\" />\r\n      <workItem from=\"1752554554901\" duration=\"14949000\" />\r\n      <workItem from=\"1752639015923\" duration=\"11964000\" />\r\n      <workItem from=\"1752727624023\" duration=\"13208000\" />\r\n      <workItem from=\"1752811712425\" duration=\"5753000\" />\r\n      <workItem from=\"1752897519834\" duration=\"8291000\" />\r\n      <workItem from=\"1753073473836\" duration=\"8149000\" />\r\n      <workItem from=\"1753158637202\" duration=\"15599000\" />\r\n      <workItem from=\"1753244517827\" duration=\"11702000\" />\r\n      <workItem from=\"1753332777470\" duration=\"1084000\" />\r\n      <workItem from=\"1753344880394\" duration=\"5225000\" />\r\n      <workItem from=\"1753415745966\" duration=\"10668000\" />\r\n      <workItem from=\"1753504160140\" duration=\"7808000\" />\r\n      <workItem from=\"1753677291569\" duration=\"12264000\" />\r\n      <workItem from=\"1753763833309\" duration=\"9273000\" />\r\n      <workItem from=\"1753780797536\" duration=\"381000\" />\r\n      <workItem from=\"1753854491530\" duration=\"958000\" />\r\n      <workItem from=\"1753855561347\" duration=\"8419000\" />\r\n      <workItem from=\"1753934960659\" duration=\"16743000\" />\r\n      <workItem from=\"1754022224415\" duration=\"11643000\" />\r\n      <workItem from=\"1754108186755\" duration=\"18539000\" />\r\n      <workItem from=\"1754281291114\" duration=\"9794000\" />\r\n      <workItem from=\"1754367849437\" duration=\"4786000\" />\r\n      <workItem from=\"1754397224305\" duration=\"1195000\" />\r\n      <workItem from=\"1754453313779\" duration=\"2772000\" />\r\n      <workItem from=\"1754465263485\" duration=\"4715000\" />\r\n      <workItem from=\"1754541753989\" duration=\"9613000\" />\r\n      <workItem from=\"1754626767965\" duration=\"683000\" />\r\n      <workItem from=\"1754628459107\" duration=\"9475000\" />\r\n      <workItem from=\"1754721911145\" duration=\"9404000\" />\r\n      <workItem from=\"1754808086247\" duration=\"27708000\" />\r\n      <workItem from=\"1754971510318\" duration=\"30586000\" />\r\n      <workItem from=\"1755056050959\" duration=\"1224000\" />\r\n      <workItem from=\"1755098913642\" duration=\"2816000\" />\r\n      <workItem from=\"1755148942853\" duration=\"14030000\" />\r\n      <workItem from=\"1755231953038\" duration=\"11552000\" />\r\n      <workItem from=\"1755316321759\" duration=\"21878000\" />\r\n      <workItem from=\"1755490840842\" duration=\"13762000\" />\r\n      <workItem from=\"1755573704521\" duration=\"634000\" />\r\n      <workItem from=\"1755576366145\" duration=\"3789000\" />\r\n      <workItem from=\"1755661288200\" duration=\"4132000\" />\r\n      <workItem from=\"1755751862233\" duration=\"1250000\" />\r\n      <workItem from=\"1755837746056\" duration=\"2550000\" />\r\n      <workItem from=\"1755920289579\" duration=\"3129000\" />\r\n      <workItem from=\"1756114874304\" duration=\"11544000\" />\r\n      <workItem from=\"1756179711186\" duration=\"19501000\" />\r\n      <workItem from=\"1756268702388\" duration=\"17501000\" />\r\n      <workItem from=\"1756353994222\" duration=\"19196000\" />\r\n      <workItem from=\"1756720738596\" duration=\"3110000\" />\r\n      <workItem from=\"1756783969780\" duration=\"6307000\" />\r\n      <workItem from=\"1756793374710\" duration=\"17092000\" />\r\n      <workItem from=\"1756873290773\" duration=\"13851000\" />\r\n      <workItem from=\"1756961219470\" duration=\"15654000\" />\r\n      <workItem from=\"1757046849246\" duration=\"4971000\" />\r\n      <workItem from=\"1757738542207\" duration=\"11992000\" />\r\n      <workItem from=\"1757762132977\" duration=\"2915000\" />\r\n      <workItem from=\"1757829555229\" duration=\"3103000\" />\r\n      <workItem from=\"1757835145822\" duration=\"902000\" />\r\n      <workItem from=\"1757841908475\" duration=\"4576000\" />\r\n      <workItem from=\"1757908435282\" duration=\"9451000\" />\r\n      <workItem from=\"1757927282628\" duration=\"13185000\" />\r\n      <workItem from=\"1757995927780\" duration=\"8584000\" />\r\n      <workItem from=\"1758081928897\" duration=\"11767000\" />\r\n      <workItem from=\"1758170494220\" duration=\"3146000\" />\r\n      <workItem from=\"1758255527259\" duration=\"7636000\" />\r\n      <workItem from=\"1758342986210\" duration=\"11143000\" />\r\n      <workItem from=\"1758517769970\" duration=\"14561000\" />\r\n      <workItem from=\"1758606346601\" duration=\"12386000\" />\r\n      <workItem from=\"1758692886021\" duration=\"5114000\" />\r\n      <workItem from=\"1758708237598\" duration=\"1478000\" />\r\n      <workItem from=\"1758711605755\" duration=\"4029000\" />\r\n      <workItem from=\"1758774127700\" duration=\"11612000\" />\r\n      <workItem from=\"1758864472510\" duration=\"6523000\" />\r\n      <workItem from=\"1758949185635\" duration=\"20545000\" />\r\n      <workItem from=\"1759122279117\" duration=\"15187000\" />\r\n      <workItem from=\"1759204679625\" duration=\"13726000\" />\r\n      <workItem from=\"1759293522466\" duration=\"9302000\" />\r\n      <workItem from=\"1759376230263\" duration=\"14977000\" />\r\n      <workItem from=\"1759464805600\" duration=\"8579000\" />\r\n      <workItem from=\"1759485516361\" duration=\"2922000\" />\r\n      <workItem from=\"1759551368016\" duration=\"3353000\" />\r\n      <workItem from=\"1759637971018\" duration=\"355000\" />\r\n      <workItem from=\"1759655189323\" duration=\"947000\" />\r\n      <workItem from=\"1760109865663\" duration=\"35000\" />\r\n      <workItem from=\"1760109909440\" duration=\"170000\" />\r\n      <workItem from=\"1760156044319\" duration=\"3064000\" />\r\n      <workItem from=\"1760178268095\" duration=\"345000\" />\r\n      <workItem from=\"1761992248949\" duration=\"177000\" />\r\n      <workItem from=\"1761992451897\" duration=\"292000\" />\r\n      <workItem from=\"1761992767268\" duration=\"213000\" />\r\n      <workItem from=\"1761992994939\" duration=\"1407000\" />\r\n      <workItem from=\"1761994438958\" duration=\"21001000\" />\r\n      <workItem from=\"1762063784746\" duration=\"22759000\" />\r\n      <workItem from=\"1762142764178\" duration=\"16574000\" />\r\n      <workItem from=\"1762425582395\" duration=\"29795000\" />\r\n      <workItem from=\"1762519243993\" duration=\"29761000\" />\r\n      <workItem from=\"1762610846664\" duration=\"22961000\" />\r\n      <workItem from=\"1762644680269\" duration=\"4983000\" />\r\n      <workItem from=\"1762713114894\" duration=\"20778000\" />\r\n      <workItem from=\"1763031712051\" duration=\"2504000\" />\r\n    </task>\r\n    <task id=\"LOCAL-01855\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762566956648</created>\r\n      <option name=\"number\" value=\"01855\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01855\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762566956649</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01856\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762611201675</created>\r\n      <option name=\"number\" value=\"01856\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01856\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762611201675</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01857\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762618889724</created>\r\n      <option name=\"number\" value=\"01857\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01857\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762618889725</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01858\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762618958108</created>\r\n      <option name=\"number\" value=\"01858\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01858\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762618958108</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01859\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762619817014</created>\r\n      <option name=\"number\" value=\"01859\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01859\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762619817014</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01860\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762620068534</created>\r\n      <option name=\"number\" value=\"01860\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01860\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762620068534</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01861\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762621090331</created>\r\n      <option name=\"number\" value=\"01861\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01861\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762621090331</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01862\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762623738512</created>\r\n      <option name=\"number\" value=\"01862\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01862\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762623738512</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01863\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762626139120</created>\r\n      <option name=\"number\" value=\"01863\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01863\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762626139120</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01864\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762626155411</created>\r\n      <option name=\"number\" value=\"01864\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01864\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762626155411</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01865\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762626245791</created>\r\n      <option name=\"number\" value=\"01865\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01865\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762626245792</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01866\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762626366509</created>\r\n      <option name=\"number\" value=\"01866\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01866\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762626366509</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01867\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762630431489</created>\r\n      <option name=\"number\" value=\"01867\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01867\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762630431489</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01868\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762630476856</created>\r\n      <option name=\"number\" value=\"01868\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01868\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762630476856</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01869\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762630541523</created>\r\n      <option name=\"number\" value=\"01869\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01869\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762630541523</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01870\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762631342792</created>\r\n      <option name=\"number\" value=\"01870\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01870\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762631342792</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01871\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762639974913</created>\r\n      <option name=\"number\" value=\"01871\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01871\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762639974913</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01872\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762640168453</created>\r\n      <option name=\"number\" value=\"01872\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01872\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762640168453</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01873\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762640304540</created>\r\n      <option name=\"number\" value=\"01873\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01873\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762640304540</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01874\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762640450227</created>\r\n      <option name=\"number\" value=\"01874\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01874\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762640450227</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01875\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762640609102</created>\r\n      <option name=\"number\" value=\"01875\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01875\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762640609102</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01876\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762640642040</created>\r\n      <option name=\"number\" value=\"01876\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01876\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762640642040</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01877\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762640831265</created>\r\n      <option name=\"number\" value=\"01877\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01877\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762640831265</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01878\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762641008505</created>\r\n      <option name=\"number\" value=\"01878\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01878\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762641008505</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01879\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762641104890</created>\r\n      <option name=\"number\" value=\"01879\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01879\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762641104890</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01880\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762641486027</created>\r\n      <option name=\"number\" value=\"01880\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01880\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762641486027</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01881\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762641863393</created>\r\n      <option name=\"number\" value=\"01881\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01881\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762641863393</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01882\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762642183802</created>\r\n      <option name=\"number\" value=\"01882\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01882\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762642183802</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01883\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762643731197</created>\r\n      <option name=\"number\" value=\"01883\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01883\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762643731199</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01884\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762643864451</created>\r\n      <option name=\"number\" value=\"01884\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01884\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762643864451</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01885\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762643996760</created>\r\n      <option name=\"number\" value=\"01885\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01885\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762643996760</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01886\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762644084386</created>\r\n      <option name=\"number\" value=\"01886\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01886\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762644084386</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01887\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762646982100</created>\r\n      <option name=\"number\" value=\"01887\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01887\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762646982100</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01888\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762647079078</created>\r\n      <option name=\"number\" value=\"01888\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01888\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762647079078</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01889\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762652033369</created>\r\n      <option name=\"number\" value=\"01889\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01889\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762652033369</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01890\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762652225767</created>\r\n      <option name=\"number\" value=\"01890\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01890\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762652225767</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01891\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762713314248</created>\r\n      <option name=\"number\" value=\"01891\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01891\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762713314248</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01892\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762717182703</created>\r\n      <option name=\"number\" value=\"01892\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01892\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762717182703</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01893\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762717589844</created>\r\n      <option name=\"number\" value=\"01893\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01893\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762717589844</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01894\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762720808112</created>\r\n      <option name=\"number\" value=\"01894\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01894\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762720808113</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01895\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762721063746</created>\r\n      <option name=\"number\" value=\"01895\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01895\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762721063746</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01896\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762722889640</created>\r\n      <option name=\"number\" value=\"01896\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01896\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762722889640</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01897\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762723024043</created>\r\n      <option name=\"number\" value=\"01897\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01897\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762723024043</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01898\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762723234494</created>\r\n      <option name=\"number\" value=\"01898\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01898\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762723234494</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01899\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762725230324</created>\r\n      <option name=\"number\" value=\"01899\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01899\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762725230324</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01900\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762732698461</created>\r\n      <option name=\"number\" value=\"01900\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01900\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762732698461</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01901\" summary=\"feat: add DailyPayment model and controller for managing daily payment records\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762732825169</created>\r\n      <option name=\"number\" value=\"01901\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01901\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762732825169</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01902\" summary=\"fix: correct join column name in sewing outputs query\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762732895515</created>\r\n      <option name=\"number\" value=\"01902\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01902\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762732895515</updated>\r\n    </task>\r\n    <task id=\"LOCAL-01903\" summary=\"fix: correct join column name in sewing outputs query\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1762737176543</created>\r\n      <option name=\"number\" value=\"01903\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-01903\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1762737176543</updated>\r\n    </task>\r\n    <option name=\"localTasksCounter\" value=\"1904\" />\r\n    <servers />\r\n  </component>\r\n  <component name=\"TypeScriptGeneratedFilesManager\">\r\n    <option name=\"version\" value=\"3\" />\r\n  </component>\r\n  <component name=\"Vcs.Log.Tabs.Properties\">\r\n    <option name=\"TAB_STATES\">\r\n      <map>\r\n        <entry key=\"MAIN\">\r\n          <value>\r\n            <State>\r\n              <option name=\"FILTERS\">\r\n                <map>\r\n                  <entry key=\"branch\">\r\n                    <value>\r\n                      <list>\r\n                        <option value=\"origin/main\" />\r\n                      </list>\r\n                    </value>\r\n                  </entry>\r\n                </map>\r\n              </option>\r\n            </State>\r\n          </value>\r\n        </entry>\r\n      </map>\r\n    </option>\r\n  </component>\r\n  <component name=\"VcsManagerConfiguration\">\r\n    <MESSAGE value=\"fix: enhance order data structure in CeoController to include submodel sewing outputs\" />\r\n    <MESSAGE value=\"fix: add route for retrieving employee tarification logs in InternalAccountantController\" />\r\n    <MESSAGE value=\"fix: add route for retrieving order attendance salary in InternalAccountantController\" />\r\n    <MESSAGE value=\"fix: calculate overall cost per unit and include total output quantity in CasherController\" />\r\n    <MESSAGE value=\"fix: filter outputs in CasherController to exclude specific group names\" />\r\n    <MESSAGE value=\"fix: optimize daily salary calculation in InternalAccountantController\" />\r\n    <MESSAGE value=\"fix: refine daily salary calculation logic in InternalAccountantController\" />\r\n    <MESSAGE value=\"fix: add endpoint to retrieve order attendance salary in InternalAccountantController\" />\r\n    <MESSAGE value=\"fix: calculate total summa based on maximum spend in InternalAccountantController\" />\r\n    <MESSAGE value=\"fix: optimize order attendance salary calculation in InternalAccountantController\" />\r\n    <MESSAGE value=\"fix: update attendance salary table and optimize group orders query in InternalAccountantController\" />\r\n    <MESSAGE value=\"fix: update joins in attendance salary query for order submodels in InternalAccountantController\" />\r\n    <MESSAGE value=\"fix: correct orders_count calculation in attendance salary query for order submodels in InternalAccountantController\" />\r\n    <MESSAGE value=\"fix: rename tarification_salary to salary in attendance salary calculation in InternalAccountantController\" />\r\n    <MESSAGE value=\"fix: add max-width and overflow handling for product column in stock balances table\" />\r\n    <MESSAGE value=\"fix: optimize order retrieval in TechnologController by reducing selected columns and improving tarification check\" />\r\n    <MESSAGE value=\"fix: enhance order retrieval in TechnologController by refining selected columns and adding has_tarifications logic\" />\r\n    <MESSAGE value=\"fix: enhance order retrieval in TechnologController by adding tarifications relationship and simplifying has_tarifications logic\" />\r\n    <MESSAGE value=\"fix: enhance order data structure in CeoController by adding status and submodel name fields\" />\r\n    <MESSAGE value=\"fix: enhance order data structure in CeoController by adding outputs to submodels\" />\r\n    <MESSAGE value=\"fix: enhance order data structure in CeoController by adding submodel name and outputs to submodels\" />\r\n    <MESSAGE value=\"fix: update payment calculation logic for 2026 summer season and improve department queries\" />\r\n    <MESSAGE value=\"fix: enhance payment distribution logic in CuttingMasterController and update employee status filter in PaymentCalculationService\" />\r\n    <MESSAGE value=\"feat: add DailyPayment model and controller for managing daily payment records\" />\r\n    <MESSAGE value=\"fix: correct join column name in sewing outputs query\" />\r\n    <option name=\"LAST_COMMIT_MESSAGE\" value=\"fix: correct join column name in sewing outputs query\" />\r\n  </component>\r\n  <component name=\"XSLT-Support.FileAssociations.UIState\">\r\n    <expand />\r\n    <select />\r\n  </component>\r\n</project>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/.idea/workspace.xml b/.idea/workspace.xml
--- a/.idea/workspace.xml	(revision f68ea360d0ccc0cd5e8e17942d0740f3cb7f80c1)
+++ b/.idea/workspace.xml	(date 1763034640113)
@@ -4,9 +4,16 @@
     <option name="autoReloadType" value="SELECTIVE" />
   </component>
   <component name="ChangeListManager">
-    <list default="true" id="6d7ca805-b105-4f4e-beb7-ef93e65f0a7f" name="Changes" comment="fix: correct join column name in sewing outputs query">
+    <list default="true" id="6d7ca805-b105-4f4e-beb7-ef93e65f0a7f" name="Changes" comment="Merge branch 'main' of https://github.com/Jamxon/VizzanoERP&#10;&#10;# Conflicts:&#10;#&#9;.idea/workspace.xml">
+      <change beforePath="$PROJECT_DIR$/.idea/data_source_mapping.xml" beforeDir="false" />
+      <change beforePath="$PROJECT_DIR$/.idea/phpunit.xml" beforeDir="false" afterPath="$PROJECT_DIR$/.idea/phpunit.xml" afterDir="false" />
       <change beforePath="$PROJECT_DIR$/.idea/workspace.xml" beforeDir="false" afterPath="$PROJECT_DIR$/.idea/workspace.xml" afterDir="false" />
       <change beforePath="$PROJECT_DIR$/app/Http/Controllers/CasherController.php" beforeDir="false" afterPath="$PROJECT_DIR$/app/Http/Controllers/CasherController.php" afterDir="false" />
+      <change beforePath="$PROJECT_DIR$/app/Http/Controllers/HikvisionEventController.php" beforeDir="false" afterPath="$PROJECT_DIR$/app/Http/Controllers/HikvisionEventController.php" afterDir="false" />
+      <change beforePath="$PROJECT_DIR$/app/Http/Controllers/SuperHRController.php" beforeDir="false" afterPath="$PROJECT_DIR$/app/Http/Controllers/SuperHRController.php" afterDir="false" />
+      <change beforePath="$PROJECT_DIR$/app/Models/Employee.php" beforeDir="false" afterPath="$PROJECT_DIR$/app/Models/Employee.php" afterDir="false" />
+      <change beforePath="$PROJECT_DIR$/app/Providers/RouteServiceProvider.php" beforeDir="false" afterPath="$PROJECT_DIR$/app/Providers/RouteServiceProvider.php" afterDir="false" />
+      <change beforePath="$PROJECT_DIR$/app/Services/TelegramService.php" beforeDir="false" afterPath="$PROJECT_DIR$/app/Services/TelegramService.php" afterDir="false" />
     </list>
     <option name="SHOW_DIALOG" value="false" />
     <option name="HIGHLIGHT_CONFLICTS" value="true" />
@@ -214,39 +221,39 @@
     <option name="hideEmptyMiddlePackages" value="true" />
     <option name="showLibraryContents" value="true" />
   </component>
-  <component name="PropertiesComponent">{
-  &quot;keyToString&quot;: {
-    &quot;ModuleVcsDetector.initialDetectionPerformed&quot;: &quot;true&quot;,
-    &quot;PHPUnit.Main.executor&quot;: &quot;Debug&quot;,
-    &quot;RunOnceActivity.ShowReadmeOnStart&quot;: &quot;true&quot;,
-    &quot;RunOnceActivity.TerminalTabsStorage.copyFrom.TerminalArrangementManager&quot;: &quot;true&quot;,
-    &quot;RunOnceActivity.TerminalTabsStorage.copyFrom.TerminalArrangementManager.252&quot;: &quot;true&quot;,
-    &quot;RunOnceActivity.git.unshallow&quot;: &quot;true&quot;,
-    &quot;com.intellij.ml.llm.matterhorn.ej.ui.settings.DefaultAutoModeForALLUsers.v1&quot;: &quot;true&quot;,
-    &quot;com.intellij.ml.llm.matterhorn.ej.ui.settings.DefaultModelSelectionForGA.v1&quot;: &quot;true&quot;,
-    &quot;com.laravel_idea.eloquent_global_unguard&quot;: &quot;0&quot;,
-    &quot;database.data.extractors.current.export.id&quot;: &quot;Excel (xlsx)&quot;,
-    &quot;database.data.extractors.current.id&quot;: &quot;CSV-Groovy.csv.groovy&quot;,
-    &quot;git-widget-placeholder&quot;: &quot;main&quot;,
-    &quot;ignore.virus.scanning.warn.message&quot;: &quot;true&quot;,
-    &quot;junie.onboarding.icon.badge.shown&quot;: &quot;true&quot;,
-    &quot;last_opened_file_path&quot;: &quot;C:/Users/BEK/Desktop/VizzanoERP&quot;,
-    &quot;node.js.detected.package.eslint&quot;: &quot;true&quot;,
-    &quot;node.js.detected.package.tslint&quot;: &quot;true&quot;,
-    &quot;node.js.selected.package.eslint&quot;: &quot;(autodetect)&quot;,
-    &quot;node.js.selected.package.tslint&quot;: &quot;(autodetect)&quot;,
-    &quot;nodejs_package_manager_path&quot;: &quot;npm&quot;,
-    &quot;php.override.implement.member.chooser.php.doc&quot;: &quot;NONE&quot;,
-    &quot;settings.editor.selected.configurable&quot;: &quot;terminal&quot;,
-    &quot;to.speed.mode.migration.done&quot;: &quot;true&quot;,
-    &quot;vue.rearranger.settings.migration&quot;: &quot;true&quot;
+  <component name="PropertiesComponent"><![CDATA[{
+  "keyToString": {
+    "ModuleVcsDetector.initialDetectionPerformed": "true",
+    "PHPUnit.Main.executor": "Debug",
+    "RunOnceActivity.ShowReadmeOnStart": "true",
+    "RunOnceActivity.TerminalTabsStorage.copyFrom.TerminalArrangementManager": "true",
+    "RunOnceActivity.TerminalTabsStorage.copyFrom.TerminalArrangementManager.252": "true",
+    "RunOnceActivity.git.unshallow": "true",
+    "com.intellij.ml.llm.matterhorn.ej.ui.settings.DefaultAutoModeForALLUsers.v1": "true",
+    "com.intellij.ml.llm.matterhorn.ej.ui.settings.DefaultModelSelectionForGA.v1": "true",
+    "com.laravel_idea.eloquent_global_unguard": "0",
+    "database.data.extractors.current.export.id": "Excel (xlsx)",
+    "database.data.extractors.current.id": "CSV-Groovy.csv.groovy",
+    "git-widget-placeholder": "Merging main",
+    "ignore.virus.scanning.warn.message": "true",
+    "junie.onboarding.icon.badge.shown": "true",
+    "last_opened_file_path": "/home/jamkhan/Desktop/VizzanoERP",
+    "node.js.detected.package.eslint": "true",
+    "node.js.detected.package.tslint": "true",
+    "node.js.selected.package.eslint": "(autodetect)",
+    "node.js.selected.package.tslint": "(autodetect)",
+    "nodejs_package_manager_path": "npm",
+    "php.override.implement.member.chooser.php.doc": "NONE",
+    "settings.editor.selected.configurable": "preferences.pluginManager",
+    "to.speed.mode.migration.done": "true",
+    "vue.rearranger.settings.migration": "true"
   },
-  &quot;keyToStringList&quot;: {
-    &quot;DatabaseDriversLRU&quot;: [
-      &quot;postgresql&quot;
+  "keyToStringList": {
+    "DatabaseDriversLRU": [
+      "postgresql"
     ]
   }
-}</component>
+}]]></component>
   <component name="RecentsManager">
     <key name="CopyFile.RECENT_KEYS">
       <recent name="$PROJECT_DIR$/storage/fonts" />
@@ -501,410 +508,415 @@
       <workItem from="1762063784746" duration="22759000" />
       <workItem from="1762142764178" duration="16574000" />
       <workItem from="1762425582395" duration="29795000" />
-      <workItem from="1762519243993" duration="29761000" />
-      <workItem from="1762610846664" duration="22961000" />
-      <workItem from="1762644680269" duration="4983000" />
-      <workItem from="1762713114894" duration="20778000" />
-      <workItem from="1763031712051" duration="2504000" />
+      <workItem from="1762519243993" duration="5025000" />
+      <workItem from="1762834371067" duration="9560000" />
     </task>
-    <task id="LOCAL-01855" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01767" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762566956648</created>
-      <option name="number" value="01855" />
-      <option name="presentableId" value="LOCAL-01855" />
+      <created>1762429970237</created>
+      <option name="number" value="01767" />
+      <option name="presentableId" value="LOCAL-01767" />
       <option name="project" value="LOCAL" />
-      <updated>1762566956649</updated>
+      <updated>1762429970237</updated>
     </task>
-    <task id="LOCAL-01856" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01768" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762611201675</created>
-      <option name="number" value="01856" />
-      <option name="presentableId" value="LOCAL-01856" />
+      <created>1762429985041</created>
+      <option name="number" value="01768" />
+      <option name="presentableId" value="LOCAL-01768" />
       <option name="project" value="LOCAL" />
-      <updated>1762611201675</updated>
+      <updated>1762429985043</updated>
     </task>
-    <task id="LOCAL-01857" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01769" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762618889724</created>
-      <option name="number" value="01857" />
-      <option name="presentableId" value="LOCAL-01857" />
+      <created>1762430073573</created>
+      <option name="number" value="01769" />
+      <option name="presentableId" value="LOCAL-01769" />
       <option name="project" value="LOCAL" />
-      <updated>1762618889725</updated>
+      <updated>1762430073573</updated>
     </task>
-    <task id="LOCAL-01858" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01770" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762618958108</created>
-      <option name="number" value="01858" />
-      <option name="presentableId" value="LOCAL-01858" />
+      <created>1762430193919</created>
+      <option name="number" value="01770" />
+      <option name="presentableId" value="LOCAL-01770" />
       <option name="project" value="LOCAL" />
-      <updated>1762618958108</updated>
+      <updated>1762430193919</updated>
     </task>
-    <task id="LOCAL-01859" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01771" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762619817014</created>
-      <option name="number" value="01859" />
-      <option name="presentableId" value="LOCAL-01859" />
+      <created>1762430346357</created>
+      <option name="number" value="01771" />
+      <option name="presentableId" value="LOCAL-01771" />
       <option name="project" value="LOCAL" />
-      <updated>1762619817014</updated>
+      <updated>1762430346357</updated>
     </task>
-    <task id="LOCAL-01860" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01772" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762620068534</created>
-      <option name="number" value="01860" />
-      <option name="presentableId" value="LOCAL-01860" />
+      <created>1762430402359</created>
+      <option name="number" value="01772" />
+      <option name="presentableId" value="LOCAL-01772" />
       <option name="project" value="LOCAL" />
-      <updated>1762620068534</updated>
+      <updated>1762430402359</updated>
     </task>
-    <task id="LOCAL-01861" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01773" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762621090331</created>
-      <option name="number" value="01861" />
-      <option name="presentableId" value="LOCAL-01861" />
+      <created>1762430697370</created>
+      <option name="number" value="01773" />
+      <option name="presentableId" value="LOCAL-01773" />
       <option name="project" value="LOCAL" />
-      <updated>1762621090331</updated>
+      <updated>1762430697370</updated>
     </task>
-    <task id="LOCAL-01862" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01774" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762623738512</created>
-      <option name="number" value="01862" />
-      <option name="presentableId" value="LOCAL-01862" />
+      <created>1762430961824</created>
+      <option name="number" value="01774" />
+      <option name="presentableId" value="LOCAL-01774" />
       <option name="project" value="LOCAL" />
-      <updated>1762623738512</updated>
+      <updated>1762430961824</updated>
     </task>
-    <task id="LOCAL-01863" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01775" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762626139120</created>
-      <option name="number" value="01863" />
-      <option name="presentableId" value="LOCAL-01863" />
+      <created>1762431147653</created>
+      <option name="number" value="01775" />
+      <option name="presentableId" value="LOCAL-01775" />
       <option name="project" value="LOCAL" />
-      <updated>1762626139120</updated>
+      <updated>1762431147653</updated>
     </task>
-    <task id="LOCAL-01864" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01776" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762626155411</created>
-      <option name="number" value="01864" />
-      <option name="presentableId" value="LOCAL-01864" />
+      <created>1762431365012</created>
+      <option name="number" value="01776" />
+      <option name="presentableId" value="LOCAL-01776" />
       <option name="project" value="LOCAL" />
-      <updated>1762626155411</updated>
+      <updated>1762431365012</updated>
     </task>
-    <task id="LOCAL-01865" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01777" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762626245791</created>
-      <option name="number" value="01865" />
-      <option name="presentableId" value="LOCAL-01865" />
+      <created>1762431534793</created>
+      <option name="number" value="01777" />
+      <option name="presentableId" value="LOCAL-01777" />
       <option name="project" value="LOCAL" />
-      <updated>1762626245792</updated>
+      <updated>1762431534793</updated>
     </task>
-    <task id="LOCAL-01866" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01778" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762626366509</created>
-      <option name="number" value="01866" />
-      <option name="presentableId" value="LOCAL-01866" />
+      <created>1762431635536</created>
+      <option name="number" value="01778" />
+      <option name="presentableId" value="LOCAL-01778" />
       <option name="project" value="LOCAL" />
-      <updated>1762626366509</updated>
+      <updated>1762431635536</updated>
     </task>
-    <task id="LOCAL-01867" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01779" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762630431489</created>
-      <option name="number" value="01867" />
-      <option name="presentableId" value="LOCAL-01867" />
+      <created>1762432464025</created>
+      <option name="number" value="01779" />
+      <option name="presentableId" value="LOCAL-01779" />
       <option name="project" value="LOCAL" />
-      <updated>1762630431489</updated>
+      <updated>1762432464025</updated>
     </task>
-    <task id="LOCAL-01868" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01780" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762630476856</created>
-      <option name="number" value="01868" />
-      <option name="presentableId" value="LOCAL-01868" />
+      <created>1762437304511</created>
+      <option name="number" value="01780" />
+      <option name="presentableId" value="LOCAL-01780" />
       <option name="project" value="LOCAL" />
-      <updated>1762630476856</updated>
+      <updated>1762437304511</updated>
     </task>
-    <task id="LOCAL-01869" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01781" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762630541523</created>
-      <option name="number" value="01869" />
-      <option name="presentableId" value="LOCAL-01869" />
+      <created>1762437694279</created>
+      <option name="number" value="01781" />
+      <option name="presentableId" value="LOCAL-01781" />
       <option name="project" value="LOCAL" />
-      <updated>1762630541523</updated>
+      <updated>1762437694279</updated>
     </task>
-    <task id="LOCAL-01870" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01782" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762631342792</created>
-      <option name="number" value="01870" />
-      <option name="presentableId" value="LOCAL-01870" />
+      <created>1762438809381</created>
+      <option name="number" value="01782" />
+      <option name="presentableId" value="LOCAL-01782" />
       <option name="project" value="LOCAL" />
-      <updated>1762631342792</updated>
+      <updated>1762438809381</updated>
     </task>
-    <task id="LOCAL-01871" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01783" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762639974913</created>
-      <option name="number" value="01871" />
-      <option name="presentableId" value="LOCAL-01871" />
+      <created>1762438866351</created>
+      <option name="number" value="01783" />
+      <option name="presentableId" value="LOCAL-01783" />
       <option name="project" value="LOCAL" />
-      <updated>1762639974913</updated>
+      <updated>1762438866351</updated>
     </task>
-    <task id="LOCAL-01872" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01784" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762640168453</created>
-      <option name="number" value="01872" />
-      <option name="presentableId" value="LOCAL-01872" />
+      <created>1762438896896</created>
+      <option name="number" value="01784" />
+      <option name="presentableId" value="LOCAL-01784" />
       <option name="project" value="LOCAL" />
-      <updated>1762640168453</updated>
+      <updated>1762438896896</updated>
     </task>
-    <task id="LOCAL-01873" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01785" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762640304540</created>
-      <option name="number" value="01873" />
-      <option name="presentableId" value="LOCAL-01873" />
+      <created>1762438990832</created>
+      <option name="number" value="01785" />
+      <option name="presentableId" value="LOCAL-01785" />
       <option name="project" value="LOCAL" />
-      <updated>1762640304540</updated>
+      <updated>1762438990832</updated>
     </task>
-    <task id="LOCAL-01874" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01786" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762640450227</created>
-      <option name="number" value="01874" />
-      <option name="presentableId" value="LOCAL-01874" />
+      <created>1762441472695</created>
+      <option name="number" value="01786" />
+      <option name="presentableId" value="LOCAL-01786" />
       <option name="project" value="LOCAL" />
-      <updated>1762640450227</updated>
+      <updated>1762441472695</updated>
     </task>
-    <task id="LOCAL-01875" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01787" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762640609102</created>
-      <option name="number" value="01875" />
-      <option name="presentableId" value="LOCAL-01875" />
+      <created>1762441495905</created>
+      <option name="number" value="01787" />
+      <option name="presentableId" value="LOCAL-01787" />
       <option name="project" value="LOCAL" />
-      <updated>1762640609102</updated>
+      <updated>1762441495905</updated>
     </task>
-    <task id="LOCAL-01876" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01788" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762640642040</created>
-      <option name="number" value="01876" />
-      <option name="presentableId" value="LOCAL-01876" />
+      <created>1762442873375</created>
+      <option name="number" value="01788" />
+      <option name="presentableId" value="LOCAL-01788" />
       <option name="project" value="LOCAL" />
-      <updated>1762640642040</updated>
+      <updated>1762442873375</updated>
     </task>
-    <task id="LOCAL-01877" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01789" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762640831265</created>
-      <option name="number" value="01877" />
-      <option name="presentableId" value="LOCAL-01877" />
+      <created>1762444398552</created>
+      <option name="number" value="01789" />
+      <option name="presentableId" value="LOCAL-01789" />
       <option name="project" value="LOCAL" />
-      <updated>1762640831265</updated>
+      <updated>1762444398553</updated>
     </task>
-    <task id="LOCAL-01878" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01790" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762641008505</created>
-      <option name="number" value="01878" />
-      <option name="presentableId" value="LOCAL-01878" />
+      <created>1762444525874</created>
+      <option name="number" value="01790" />
+      <option name="presentableId" value="LOCAL-01790" />
       <option name="project" value="LOCAL" />
-      <updated>1762641008505</updated>
+      <updated>1762444525874</updated>
     </task>
-    <task id="LOCAL-01879" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01791" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762641104890</created>
-      <option name="number" value="01879" />
-      <option name="presentableId" value="LOCAL-01879" />
+      <created>1762444971487</created>
+      <option name="number" value="01791" />
+      <option name="presentableId" value="LOCAL-01791" />
       <option name="project" value="LOCAL" />
-      <updated>1762641104890</updated>
+      <updated>1762444971487</updated>
     </task>
-    <task id="LOCAL-01880" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01792" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762641486027</created>
-      <option name="number" value="01880" />
-      <option name="presentableId" value="LOCAL-01880" />
+      <created>1762445169439</created>
+      <option name="number" value="01792" />
+      <option name="presentableId" value="LOCAL-01792" />
       <option name="project" value="LOCAL" />
-      <updated>1762641486027</updated>
+      <updated>1762445169439</updated>
     </task>
-    <task id="LOCAL-01881" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01793" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762641863393</created>
-      <option name="number" value="01881" />
-      <option name="presentableId" value="LOCAL-01881" />
+      <created>1762445253277</created>
+      <option name="number" value="01793" />
+      <option name="presentableId" value="LOCAL-01793" />
       <option name="project" value="LOCAL" />
-      <updated>1762641863393</updated>
+      <updated>1762445253277</updated>
     </task>
-    <task id="LOCAL-01882" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01794" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762642183802</created>
-      <option name="number" value="01882" />
-      <option name="presentableId" value="LOCAL-01882" />
+      <created>1762445315667</created>
+      <option name="number" value="01794" />
+      <option name="presentableId" value="LOCAL-01794" />
       <option name="project" value="LOCAL" />
-      <updated>1762642183802</updated>
+      <updated>1762445315667</updated>
     </task>
-    <task id="LOCAL-01883" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01795" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762643731197</created>
-      <option name="number" value="01883" />
-      <option name="presentableId" value="LOCAL-01883" />
+      <created>1762445551244</created>
+      <option name="number" value="01795" />
+      <option name="presentableId" value="LOCAL-01795" />
       <option name="project" value="LOCAL" />
-      <updated>1762643731199</updated>
+      <updated>1762445551244</updated>
     </task>
-    <task id="LOCAL-01884" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01796" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762643864451</created>
-      <option name="number" value="01884" />
-      <option name="presentableId" value="LOCAL-01884" />
+      <created>1762445755261</created>
+      <option name="number" value="01796" />
+      <option name="presentableId" value="LOCAL-01796" />
       <option name="project" value="LOCAL" />
-      <updated>1762643864451</updated>
+      <updated>1762445755261</updated>
     </task>
-    <task id="LOCAL-01885" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01797" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762643996760</created>
-      <option name="number" value="01885" />
-      <option name="presentableId" value="LOCAL-01885" />
+      <created>1762445803990</created>
+      <option name="number" value="01797" />
+      <option name="presentableId" value="LOCAL-01797" />
       <option name="project" value="LOCAL" />
-      <updated>1762643996760</updated>
+      <updated>1762445803990</updated>
     </task>
-    <task id="LOCAL-01886" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01798" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762644084386</created>
-      <option name="number" value="01886" />
-      <option name="presentableId" value="LOCAL-01886" />
+      <created>1762445964387</created>
+      <option name="number" value="01798" />
+      <option name="presentableId" value="LOCAL-01798" />
       <option name="project" value="LOCAL" />
-      <updated>1762644084386</updated>
+      <updated>1762445964388</updated>
     </task>
-    <task id="LOCAL-01887" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01799" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762646982100</created>
-      <option name="number" value="01887" />
-      <option name="presentableId" value="LOCAL-01887" />
+      <created>1762446114305</created>
+      <option name="number" value="01799" />
+      <option name="presentableId" value="LOCAL-01799" />
       <option name="project" value="LOCAL" />
-      <updated>1762646982100</updated>
+      <updated>1762446114305</updated>
     </task>
-    <task id="LOCAL-01888" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01800" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762647079078</created>
-      <option name="number" value="01888" />
-      <option name="presentableId" value="LOCAL-01888" />
+      <created>1762446186670</created>
+      <option name="number" value="01800" />
+      <option name="presentableId" value="LOCAL-01800" />
       <option name="project" value="LOCAL" />
-      <updated>1762647079078</updated>
+      <updated>1762446186670</updated>
     </task>
-    <task id="LOCAL-01889" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01801" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762652033369</created>
-      <option name="number" value="01889" />
-      <option name="presentableId" value="LOCAL-01889" />
+      <created>1762446302754</created>
+      <option name="number" value="01801" />
+      <option name="presentableId" value="LOCAL-01801" />
       <option name="project" value="LOCAL" />
-      <updated>1762652033369</updated>
+      <updated>1762446302754</updated>
     </task>
-    <task id="LOCAL-01890" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01802" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762652225767</created>
-      <option name="number" value="01890" />
-      <option name="presentableId" value="LOCAL-01890" />
+      <created>1762446368019</created>
+      <option name="number" value="01802" />
+      <option name="presentableId" value="LOCAL-01802" />
       <option name="project" value="LOCAL" />
-      <updated>1762652225767</updated>
+      <updated>1762446368019</updated>
     </task>
-    <task id="LOCAL-01891" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01803" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762713314248</created>
-      <option name="number" value="01891" />
-      <option name="presentableId" value="LOCAL-01891" />
+      <created>1762446811068</created>
+      <option name="number" value="01803" />
+      <option name="presentableId" value="LOCAL-01803" />
       <option name="project" value="LOCAL" />
-      <updated>1762713314248</updated>
+      <updated>1762446811068</updated>
     </task>
-    <task id="LOCAL-01892" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01804" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762717182703</created>
-      <option name="number" value="01892" />
-      <option name="presentableId" value="LOCAL-01892" />
+      <created>1762447621686</created>
+      <option name="number" value="01804" />
+      <option name="presentableId" value="LOCAL-01804" />
       <option name="project" value="LOCAL" />
-      <updated>1762717182703</updated>
+      <updated>1762447621686</updated>
     </task>
-    <task id="LOCAL-01893" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01805" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762717589844</created>
-      <option name="number" value="01893" />
-      <option name="presentableId" value="LOCAL-01893" />
+      <created>1762449082907</created>
+      <option name="number" value="01805" />
+      <option name="presentableId" value="LOCAL-01805" />
       <option name="project" value="LOCAL" />
-      <updated>1762717589844</updated>
+      <updated>1762449082907</updated>
     </task>
-    <task id="LOCAL-01894" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01806" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762720808112</created>
-      <option name="number" value="01894" />
-      <option name="presentableId" value="LOCAL-01894" />
+      <created>1762450580159</created>
+      <option name="number" value="01806" />
+      <option name="presentableId" value="LOCAL-01806" />
       <option name="project" value="LOCAL" />
-      <updated>1762720808113</updated>
+      <updated>1762450580159</updated>
     </task>
-    <task id="LOCAL-01895" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01807" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762721063746</created>
-      <option name="number" value="01895" />
-      <option name="presentableId" value="LOCAL-01895" />
+      <created>1762450657810</created>
+      <option name="number" value="01807" />
+      <option name="presentableId" value="LOCAL-01807" />
       <option name="project" value="LOCAL" />
-      <updated>1762721063746</updated>
+      <updated>1762450657810</updated>
     </task>
-    <task id="LOCAL-01896" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01808" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762722889640</created>
-      <option name="number" value="01896" />
-      <option name="presentableId" value="LOCAL-01896" />
+      <created>1762450757688</created>
+      <option name="number" value="01808" />
+      <option name="presentableId" value="LOCAL-01808" />
       <option name="project" value="LOCAL" />
-      <updated>1762722889640</updated>
+      <updated>1762450757688</updated>
     </task>
-    <task id="LOCAL-01897" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01809" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762723024043</created>
-      <option name="number" value="01897" />
-      <option name="presentableId" value="LOCAL-01897" />
+      <created>1762466262187</created>
+      <option name="number" value="01809" />
+      <option name="presentableId" value="LOCAL-01809" />
       <option name="project" value="LOCAL" />
-      <updated>1762723024043</updated>
+      <updated>1762466262187</updated>
     </task>
-    <task id="LOCAL-01898" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01810" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762723234494</created>
-      <option name="number" value="01898" />
-      <option name="presentableId" value="LOCAL-01898" />
+      <created>1762466504321</created>
+      <option name="number" value="01810" />
+      <option name="presentableId" value="LOCAL-01810" />
       <option name="project" value="LOCAL" />
-      <updated>1762723234494</updated>
+      <updated>1762466504321</updated>
     </task>
-    <task id="LOCAL-01899" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01811" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762725230324</created>
-      <option name="number" value="01899" />
-      <option name="presentableId" value="LOCAL-01899" />
+      <created>1762469223008</created>
+      <option name="number" value="01811" />
+      <option name="presentableId" value="LOCAL-01811" />
       <option name="project" value="LOCAL" />
-      <updated>1762725230324</updated>
+      <updated>1762469223009</updated>
     </task>
-    <task id="LOCAL-01900" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01812" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762732698461</created>
-      <option name="number" value="01900" />
-      <option name="presentableId" value="LOCAL-01900" />
+      <created>1762527934973</created>
+      <option name="number" value="01812" />
+      <option name="presentableId" value="LOCAL-01812" />
       <option name="project" value="LOCAL" />
-      <updated>1762732698461</updated>
+      <updated>1762527934973</updated>
     </task>
-    <task id="LOCAL-01901" summary="feat: add DailyPayment model and controller for managing daily payment records">
+    <task id="LOCAL-01813" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762732825169</created>
-      <option name="number" value="01901" />
-      <option name="presentableId" value="LOCAL-01901" />
+      <created>1762528477032</created>
+      <option name="number" value="01813" />
+      <option name="presentableId" value="LOCAL-01813" />
       <option name="project" value="LOCAL" />
-      <updated>1762732825169</updated>
+      <updated>1762528477032</updated>
     </task>
-    <task id="LOCAL-01902" summary="fix: correct join column name in sewing outputs query">
+    <task id="LOCAL-01814" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762732895515</created>
-      <option name="number" value="01902" />
-      <option name="presentableId" value="LOCAL-01902" />
+      <created>1762529265847</created>
+      <option name="number" value="01814" />
+      <option name="presentableId" value="LOCAL-01814" />
       <option name="project" value="LOCAL" />
-      <updated>1762732895515</updated>
+      <updated>1762529265847</updated>
     </task>
-    <task id="LOCAL-01903" summary="fix: correct join column name in sewing outputs query">
+    <task id="LOCAL-01815" summary="feat: add DailyPayment model and controller for managing daily payment records">
       <option name="closed" value="true" />
-      <created>1762737176543</created>
-      <option name="number" value="01903" />
-      <option name="presentableId" value="LOCAL-01903" />
+      <created>1762834739144</created>
+      <option name="number" value="01815" />
+      <option name="presentableId" value="LOCAL-01815" />
       <option name="project" value="LOCAL" />
-      <updated>1762737176543</updated>
+      <updated>1762834739145</updated>
     </task>
-    <option name="localTasksCounter" value="1904" />
+    <option name="localTasksCounter" value="1816" />
     <servers />
   </component>
   <component name="TypeScriptGeneratedFilesManager">
     <option name="version" value="3" />
   </component>
+  <component name="UnknownFeatures">
+    <option featureType="dependencySupport" implementationName="javascript:npm:react" />
+    <option featureType="dependencySupport" implementationName="javascript:npm:prettier" />
+    <option featureType="dependencySupport" implementationName="javascript:npm:vite" />
+    <option featureType="dependencySupport" implementationName="javascript:npm:webpack" />
+    <option featureType="dependencySupport" implementationName="javascript:npm:cypress" />
+    <option featureType="dependencySupport" implementationName="javascript:npm:postcss" />
+  </component>
   <component name="Vcs.Log.Tabs.Properties">
     <option name="TAB_STATES">
       <map>
@@ -929,6 +941,7 @@
     </option>
   </component>
   <component name="VcsManagerConfiguration">
+    <MESSAGE value="fix: update supplier name retrieval in SupplierController for order notifications" />
     <MESSAGE value="fix: enhance order data structure in CeoController to include submodel sewing outputs" />
     <MESSAGE value="fix: add route for retrieving employee tarification logs in InternalAccountantController" />
     <MESSAGE value="fix: add route for retrieving order attendance salary in InternalAccountantController" />
@@ -953,8 +966,7 @@
     <MESSAGE value="fix: update payment calculation logic for 2026 summer season and improve department queries" />
     <MESSAGE value="fix: enhance payment distribution logic in CuttingMasterController and update employee status filter in PaymentCalculationService" />
     <MESSAGE value="feat: add DailyPayment model and controller for managing daily payment records" />
-    <MESSAGE value="fix: correct join column name in sewing outputs query" />
-    <option name="LAST_COMMIT_MESSAGE" value="fix: correct join column name in sewing outputs query" />
+    <option name="LAST_COMMIT_MESSAGE" value="feat: add DailyPayment model and controller for managing daily payment records" />
   </component>
   <component name="XSLT-Support.FileAssociations.UIState">
     <expand />
Index: app/Services/TelegramService.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?php\r\n\r\nnamespace App\\Services;\r\n\r\nuse App\\Models\\TelegramReport;\r\nuse Illuminate\\Support\\Facades\\Http;\r\nuse Illuminate\\Support\\Facades\\Cache;\r\n\r\nclass TelegramService\r\n{\r\n    private $token;\r\n\r\n    public function __construct()\r\n    {\r\n        $this->token = \"8381341070:AAHMQEsFDAGvAADaby5SE1yEqoqK_6hNOfo\";\r\n    }\r\n\r\n    private function apiUrl($method)\r\n    {\r\n        return \"https://api.telegram.org/bot{$this->token}/{$method}\";\r\n    }\r\n\r\n    public function sendMessage($chatId, $text)\r\n    {\r\n        $res = Http::post($this->apiUrl('sendMessage'), [\r\n            'chat_id' => $chatId,\r\n            'text' => $text,\r\n            'parse_mode' => 'HTML'\r\n        ]);\r\n\r\n        return $res->json();\r\n    }\r\n\r\n    public function editMessage($chatId, $messageId, $text)\r\n    {\r\n        $res = Http::post($this->apiUrl('editMessageText'), [\r\n            'chat_id' => $chatId,\r\n            'message_id' => $messageId,\r\n            'text' => $text,\r\n            'parse_mode' => 'HTML'\r\n        ]);\r\n\r\n        return $res->json();\r\n    }\r\n\r\n    public function updateDailyReport($branchId, $chatId, $employees)\r\n    {\r\n        $today = now()->toDateString();\r\n\r\n        // Department bo‘yicha guruhlash\r\n        $departments = $employees->groupBy('department_id');\r\n\r\n        $text = \"<b>\uD83D\uDCCB {$today} - Davomat (Filial {$branchId})</b>\\n\\n\";\r\n\r\n        $aupCount = 0;\r\n\r\n        foreach ($departments as $departmentId => $deptEmployees) {\r\n            $departmentName = optional($deptEmployees->first()->department)->name ?? \"No department\";\r\n\r\n            if ($departmentName === 'Тикув бўлими' || $departmentName === 'Тикув') {\r\n                $text .= \"\uD83C\uDFE2 <b>{$departmentName}</b> — \" . $deptEmployees->count() . \" ta hodim\\n\";\r\n\r\n                $groups = $deptEmployees->groupBy('group_id');\r\n                foreach ($groups as $groupId => $groupEmployees) {\r\n                    if ($groupId) {\r\n                        $groupName = optional($groupEmployees->first()->group)->name ?? \"No group\";\r\n                        $text .= \"   └─ \uD83D\uDC65 {$groupName}: \" . $groupEmployees->count() . \"\\n\";\r\n                    }\r\n                }\r\n\r\n                $text .= \"\\n\";\r\n            } else {\r\n                $aupCount += $deptEmployees->count();\r\n            }\r\n        }\r\n\r\n        if ($aupCount > 0) {\r\n            $text .= \"\uD83C\uDFE2 <b>AUP</b> — {$aupCount} ta hodim\\n\\n\";\r\n        }\r\n\r\n        $text .= \"\\n<b>Jami:</b> \" . $employees->count() . \" ta hodim\";\r\n\r\n        // Bazadan avvalgi reportni olib kelamiz\r\n        $report = TelegramReport::where('branch_id', $branchId)\r\n            ->where('date', $today)\r\n            ->first();\r\n\r\n        if ($report && $report->message_id) {\r\n            // eski xabarni yangilash\r\n            $res = $this->editMessage($chatId, $report->message_id, $text);\r\n\r\n            if (($res['ok'] ?? false)) {\r\n                // agar yangilansa, faqat textni update qilamiz\r\n                $report->update(['text' => $text]);\r\n            }\r\n            // ❌ agar yangilanmasa, hech narsa qilmaymiz\r\n        } else {\r\n            // yangi xabar yuborish (faqat birinchi marta)\r\n            $res = $this->sendMessage($chatId, $text);\r\n            if ($res['ok'] ?? false) {\r\n                TelegramReport::updateOrCreate(\r\n                    ['branch_id' => $branchId, 'date' => $today],\r\n                    [\r\n                        'chat_id'    => $chatId,\r\n                        'message_id' => $res['result']['message_id'],\r\n                        'text'       => $text,\r\n                    ]\r\n                );\r\n            }\r\n        }\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/Services/TelegramService.php b/app/Services/TelegramService.php
--- a/app/Services/TelegramService.php	(revision f68ea360d0ccc0cd5e8e17942d0740f3cb7f80c1)
+++ b/app/Services/TelegramService.php	(date 1763034557046)
@@ -57,7 +57,7 @@
         foreach ($departments as $departmentId => $deptEmployees) {
             $departmentName = optional($deptEmployees->first()->department)->name ?? "No department";
 
-            if ($departmentName === 'Тикув бўлими' || $departmentName === 'Тикув') {
+            if ($departmentName === 'Тикув бўлими' || $departmentName === 'Тикув' || $departmentName === "Tikuv bo'limi") {
                 $text .= "🏢 <b>{$departmentName}</b> — " . $deptEmployees->count() . " ta hodim\n";
 
                 $groups = $deptEmployees->groupBy('group_id');
